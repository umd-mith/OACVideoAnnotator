/*
 *  OAC Video Annotation Tool v0.1
 * 
 *  Developed as a plugin for the MITHGrid framework. 
 *  
 *  Date: Tue Feb 14 11:23:23 2012 -0500
 *  
 * Educational Community License, Version 2.0
 * 
 * Copyright 2011 University of Maryland. Licensed under the Educational
 * Community License, Version 2.0 (the "License"); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License at
 * 
 * http://www.osedu.org/licenses/ECL-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 * 
 */
var MITHGrid=MITHGrid||{},jQuery=jQuery||{},Raphael=Raphael||{},OAC=OAC||{},app={};MITHGrid.globalNamespace("OAC"),OAC.namespace("Client"),OAC.Client.namespace("StreamingVideo"),function(a,b,c){var d=c.Client.StreamingVideo.namespace("Controller");d.namespace("KeyboardListener"),d.KeyboardListener.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.KeyboardListener",c);c=d.options,d.applyBindings=function(b,d){var e=b.locate("doc"),f,g=function(a){f=a};c.application.events.onActiveAnnotationChange.addListener(g),a(e).keydown(function(a){if(f!==undefined||f!=="")if(a.keyCode===8||a.keyCode===46)b.events.onDelete.fire(f),f=""})};return d},d.namespace("AnnotationEditSelectionGrid"),d.AnnotationEditSelectionGrid.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid",c),e=[];c=d.options,e=d.options.dirs||["ul","top","ur","lft","lr","btm","ll","rgt","mid"],d.applyBindings=function(b,c){var f,g,h={},i={},j={},k={},l={},m,n={},o={},p={},q={},r,s=c.paper,t={},u=5,v,w,x,y,z={},A,B={},C={},D={},E,F={},G={},H={},I;b.events.onResize.addListener(function(a,b){m!==undefined&&m.eventResize!==undefined&&m.eventResize(a,b)}),b.events.onMove.addListener(function(a,b){m!==undefined&&m.eventMove!==undefined&&m.eventMove(a,b)}),b.events.onDelete.addListener(function(a){m!==undefined&&m.eventDelete!==undefined&&m.eventDelete(a)}),b.attachRendering=function(a){b.detachRendering();a!==undefined&&(m=a,v(),A())},b.detachRendering=function(){typeof m!="undefined"&&m!==null&&(m=undefined,h.hide(),j.hide(),i.hide(),k&&k.hide())},v=function(){r=m.getExtents(),t.width=r.width+2*u,t.height=r.height+2*u,t.x=r.x-u/8-t.width/2,t.y=r.y-u/8-t.height/2,w(t),k&&x(t)},A=function(){a.isEmptyObject(h)?(h=s.set(),a.each(l,function(a,b){var c;a==="mid"?(i=s.rect(b.x,b.y,u,u),b.id=i.id):(c=s.rect(b.x,b.y,u,u),b.id=c.id,c.attr({cursor:b.cursor}),h.push(c))}),h.attr({fill:99e4,stroke:"black"}),a.isEmptyObject(i)||i.attr({fill:99e4,stroke:"black",cursor:"move"}),j=s.rect(t.x,t.y,t.width,t.height),j.attr({stroke:"green","stroke-dasharray":["--"]}),x(t),a.isEmptyObject(i)||i.drag(function(a,b){B.nx=t.x+a,B.ny=t.y+b,C.x=r.x+a,C.y=r.y+b,j.attr({x:B.nx,y:B.ny}),w({x:B.nx,y:B.ny,width:t.width,height:t.height}),k&&x({x:B.nx,y:B.ny,width:t.width,height:t.height})},function(a,b,c){f=c.layerX,g=c.layerY,v(),m.shape.attr({cursor:"move"})},function(){var a={x:C.x,y:C.y};b.events.onMove.fire(m.id,a),m.shape.attr({cursor:"default"})}),h.drag(function(a,b){C.w=Math.abs(r.width+a*q.x),C.h=Math.abs(r.height+b*q.y),B.nw=C.w+u*2,B.nh=C.h+u*2,B.nx=r.x-u/4-B.nw/2,B.ny=r.y-u/4-B.nh/2,j.attr({x:B.nx,y:B.ny,width:B.nw,height:B.nh}),w({x:B.nx,y:B.ny,width:B.nw,height:B.nh}),k&&x({x:B.nx,y:B.ny,width:B.nw,height:B.nh})},function(a,b,c){var d,e;r=m.getExtents(),f=c.layerX,g=c.layerY,d=8*(f-r.x)/r.width+4,e=8*(g-r.y)/r.height+4,d<3?q.x=-2:d<5?q.x=0:q.x=2,e<3?q.y=-2:e<5?q.y=0:q.y=2,v()},function(){var a={width:C.w,height:C.h};m!==undefined&&d.events.onResize.fire(m.id,a)})):(j.show(),j.attr({x:t.x,y:t.y,width:t.width,height:t.height}),h.show(),i.show().toFront(),k&&(k.show(),x(t)))},x=function(b){a.isEmptyObject(k)?(D.x=b.x+b.width,D.y=b.y-u*4-2,D.w=100,D.h=20,G={x:D.x+2,y:D.y+2,w:D.w/2-4,h:D.h-D.h/8},F={x:G.x+G.w+2,y:D.y+2,w:D.w/2-4,h:D.h-D.h/8},k=s.set(),p=s.rect(D.x,D.y,D.w,D.h),p.attr({fill:"#FFFFFF",stroke:"#000"}),k.push(p),o=s.rect(G.x,G.y,G.w,G.h),o.attr({fill:334009,cursor:"pointer"}),k.push(o),n=s.rect(F.x,F.y,F.w,F.h),n.attr({fill:334009,cursor:"pointer"}),k.push(n),o.mousedown(function(){m!==undefined&&d.events.onEdit.fire(m.id)}),o.hover(function(){o.attr({fill:443009})},function(){o.attr({fill:334009})}),n.mousedown(function(){m!==undefined&&(d.events.onDelete.fire(m.id),y())}),n.hover(function(){n.attr({fill:443009})},function(){n.attr({fill:334009})})):(D.x=b.x+b.width,D.y=b.y-u*4-2,G={x:D.x+2,y:D.y+2},F={x:G.x+o.attr("width")+2,y:D.y+2},p.attr({x:D.x,y:D.y}),o.attr(G),n.attr(F))},y=function(){b.detachRendering(),m=undefined,k.hide(),j.hide(),h.hide(),i.hide()},H={ul:["nw",0,0,0,0],top:["n",1,0,0,0],ur:["ne",2,-1,0,0],rgt:["e",2,-1,1,0],lr:["se",2,-1,2,-1],btm:["s",1,0,2,-1],ll:["sw",0,0,2,-1],lft:["w",0,0,1,0],mid:["pointer",1,0,1,0]},w=function(b){var c=function(a,c,d,e,f){return{x:b.x+c*b.width/2+d*u,y:b.y+e*b.height/2+f*u,cursor:a.length>2?a:a+"-resize"}},d=function(a,c,d,e,f){var g;a.x=b.x+c*b.width/2+d*u,a.y=b.y+e*b.height/2+f*u,g=s.getById(a.id),g.attr({x:a.x,y:a.y})};a.each(e,function(a,b){var e=H[b];e!==undefined&&(l[b]===undefined?l[b]=c(e[0],e[1],e[2],e[3],e[4]):d(l[b],e[1],e[2],e[3],e[4]))})}};return d},d.namespace("ShapeCreateBox"),d.ShapeCreateBox.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.ShapeCreateBox",c);c=d.options,d.applyBindings=function(b,c){var d,e,f={},g,h={},i=c.paper,j={},k=10,l,m,n={},o,p;b.createGuide=function(b){j.x=b[0],j.y=b[1],j.width=b[0]+k,j.height=b[1]+k,a.isEmptyObject(f)?(f=i.rect(j.x,j.y,j.width,j.height),f.attr({stroke:"green","stroke-dasharray":["--"]})):(f.show(),f.attr({x:j.x,y:j.y,width:j.width,height:j.height}))},b.resizeGuide=function(a){j.width=a[0]-j.x,j.height=a[1]-j.y,f.attr({width:j.width,height:j.height})},b.completeShape=function(a){j.width=a.width,j.height=a.height,f.attr({width:j.width,height:j.height}),f.hide();return{x:j.x,y:j.y,width:j.width,height:j.height}}};return d},d.namespace("AnnoActiveController"),d.AnnoActiveController.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.AnnoActiveController",c);c=d.options,d.applyBindings=function(b,d){var e,f,g,h=b.locate("annotation"),i=b.locate("body"),j=b.locate("annotations"),k=b.locate("textarea"),l=b.locate("editarea"),m=b.locate("editbutton"),n=b.locate("updatebutton"),o=b.locate("deletebutton"),p=!1;e=function(){a(l).show(),a(i).hide(),p=!0,b.events.onClick.fire(d.itemId)},f=function(){a(l).hide(),a(i).show(),p=!1},g=function(c){var e=a(k).val();c.preventDefault(),b.events.onUpdate.fire(d.itemId,e),f()},a(h).bind("dblclick",function(a){a.preventDefault(),p?f():e()}),a(h).bind("click",function(a){c.application.setActiveAnnotation(d.itemId)}),c.application.events.onActiveAnnotationChange.addListener(function(a){a!==d.id&&p&&(g({preventDefault:function(){}}),f())})};return d},d.namespace("CanvasClickController"),d.CanvasClickController.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.CanvasClickController",c);c=d.options,d.applyBindings=function(b,d){var e,f,g,h,i=d.closeEnough,j,k,l,m,n,o,p,q={},r=d.paper,s,t=function(a){var c;if(p===undefined||a!==p.id){c=q[a];if(c===undefined){b.events.onClick.fire(undefined),p=undefined;return!1}p=c}},u=function(a){if(p===undefined||a!==p.id)var b=q[a]},v=function(c){var d=0,e=[],f=[],g,h,i,j,k=a(c).offset();a(c).unbind(),a(c).mousedown(function(a){d<=0&&(g=a.pageX-k.left,h=a.pageY-k.top,e=[g,h],d=1,b.events.onShapeStart.fire(e))}),a(c).mousemove(function(a){d!==2&&d!==0&&(g=a.pageX-k.left,h=a.pageY-k.top,f=[g,h],b.events.onShapeDrag.fire(f))}),a(c).mouseup(function(a){d>=1&&(d=0,f===undefined&&(f=[g+5,h+5]),b.events.onShapeDone.fire({x:e[0],y:e[1],width:f[0]-e[0],height:f[1]-e[1]}))})},w=function(b){a(b).unbind(),a(b).bind("mousedown",function(d){h="",s=a(b).offset(),e=Math.abs(s.left-d.pageX),f=Math.abs(s.top-d.pageY);if(p!==undefined){g=p.getExtents(),j=Math.abs(s.left-d.pageX),k=Math.abs(s.top-d.pageY);if(j<g.width+4&&k<g.height+4)return}a.each(q,function(a,b){g=b.getExtents(),j=Math.abs(s.left-d.pageX),k=Math.abs(s.top-d.pageY);if(j<g.width+4&&k<g.height+4){h=b.id;if(p===undefined||b.id!==p.id)p=b,c.application.setActiveAnnotation(b.id);return!1}}),h.length===0&&p!==undefined&&(c.application.setActiveAnnotation(undefined),p=undefined)})};c.application.events.onActiveAnnotationChange.addListener(t),c.application.events.onCurrentModeChange.addListener(function(a){a==="Rectangle"||a==="Ellipse"?v(b.locate("svg")):a==="Select"&&w(b.locate("svg"))}),b.registerRendering=function(a){q[a.id]=a},b.removeRendering=function(a){delete q[a.id]}};return d},d.namespace("AnnotationCreationButton"),d.AnnotationCreationButton.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.AnnotationCreationButton",c);c=d.options,d.applyBindings=function(b,d){var e,f=!1,g,h;e=b.locate("button"),a(e).live("mousedown",function(b){f===!1?(f=!0,c.application.setCurrentMode(d.action),a(e).addClass("active")):f===!0&&(f=!1,c.application.setCurrentMode(""),a(e).removeClass("active"))}),g=function(b){h===""?(f=!1,a(e).removeClass("active")):b===c.action?(f=!0,a(e).addClass("active")):(f=!1,a(e).removeClass("active"))},c.application.events.onCurrentModeChange.addListener(g)};return d},d.namespace("sliderButton"),d.sliderButton.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.sliderButton",c);c=d.options,d.applyBindings=function(b,d){var e,f,g,h,i,j;f=b.locate("timedisplay"),j=function(b){i===undefined&&(i=b,a(e).slider("value",i))},g=function(b,d){c.application.setCurrentTime(d.value),a(f).text("TIME: "+d.value),i=d.value},h=function(b,d){d===undefined&&(i=b,a(e).slider("value",b));i!==d.value&&(c.application.setCurrentTime(d.value),a(f).text("TIME: "+d.value),i=d.value)},e=b.locate("slider"),a(e).slider({start:g,slide:h})};return d},d.namespace("PlayerControl"),d.PlayerControl.initController=function(a){var c=b.Controller.initController("OAC.Client.StreamingVideo.Controller.PlayerControl",a);a=c.options,c.applyBindings=function(a,b){},c.start=function(){a.player.play()},c.pause=function(){a.player.pause()};return c}}(jQuery,MITHGrid,OAC),function(a,b,c){b.Presentation.namespace("AnnotationList"),b.Presentation.AnnotationList.initPresentation=function(c,d){var e=b.Presentation.initPresentation("MITHGrid.Presentation.AnnotationList",c,d),f=function(b){var c,e,f,g,h;f=d.dataView.prepare(["!bodyType"]),c=f.evaluate("text"),a.each(c,function(a,c){e=d.application.dataStore.canvas.getItem(c),g=parseInt(e.ntp_start,10),h=parseInt(e.ntp_end,10),b>=g&&b<=h&&d.application.dataStore.canvas.updateItems([{id:e.id}])})};return e},b.Presentation.namespace("RaphaelCanvas"),b.Presentation.RaphaelCanvas.initPresentation=function(c,d){var e=b.Presentation.initPresentation("MITHGrid.Presentation.RaphaelCanvas",c,d),f=a(c).attr("id"),g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;d=e.options,k=d.controllers.canvas,l=d.controllers.keyboard,m=d.controllers.shapeEditBox,q=d.controllers.shapeCreateBox,i=d.application.cX||a(c).css("x"),j=d.application.cY||a(c).css("y"),d.application.cWidth!==undefined?h=d.application.cWidth:h=a(c).width(),d.application.cHeight!==undefined?g=d.application.cHeight:g=a(c).height(),e.events=e.events||{},e.events.onOpacityChange=b.initEventFirer(!1,!1),p=l.bind(a("body"),{}),a.extend(!0,e.events,p.events),e.canvas=new Raphael(a(c),h,g),o=k.bind(a("body"),{closeEnough:5,paper:e.canvas}),u=m.bind(a(c),{paper:e.canvas}),r=q.bind(a(c),{paper:e.canvas}),o.events.onShapeStart.addListener(function(a){r.createGuide(a)}),o.events.onShapeDrag.addListener(function(a){r.resizeGuide(a)}),o.events.onShapeDone.addListener(function(a){var b=r.completeShape(a);d.application.insertShape(b)}),y=function(b){b!==undefined&&(a("svg").css({left:parseInt(b[0],10)+"px",top:parseInt(b[1],10)+"px",width:b[2],height:b[3]}),a(c).css({left:parseInt(b[0],10)+"px",top:parseInt(b[1],10)+"px",width:b[2],height:b[3]}))},v=function(b){var c,e,f,g,h,i=function(a,b,c,d,e){var f=0;a<d&&a>=b?(f=1/(d-a),f=f.toFixed(1)):a>e&&a<=c?(f=1/(a-e),f=f.toFixed(1)):a>=b&&a<=c&&a>=d&&a<=e&&(f=1);return f};w=d.dataView.prepare(["!type"]),c=w.evaluate("Annotation"),a.each(c,function(a,c){e=x.getItem(c),f=parseInt(e.ntp_start,10)-d.fadeStart,g=parseInt(e.ntp_end,10)+d.fadeStart,h=i(b,f,g,parseInt(e.ntp_start,10),parseInt(e.ntp_end,10)),d.application.dataStore.canvas.updateItems([{id:e.id,x:e.x,y:e.y,w:e.w,h:e.h,opacity:h}])})},n=e.render,d.application.events.onCurrentTimeChange.addListener(v),d.application.events.onPlayerChange.addListener(function(a){y(a)}),e.render=function(a,b,c){var e=n(a,b,c),f;console.log("rendering raphael item");if(e!==undefined){f=b;while(f.dataStore)f=f.dataStore;x=f,w=d.dataView.prepare(["!type"]),o.registerRendering(e)}return e},e.renderItems=function(){},t=e.eventFocusChange,e.eventFocusChange=function(a){t(a),u.attachRendering(e.renderingFor(a))};return e}}(jQuery,MITHGrid,OAC),function(a,b,c){var d=1;c.Client.StreamingVideo.initApp=function(c,e){var f,g,h,i,j,k,l="OAC-Client-StreamingVideo-SVG-Canvas-"+d,m=[],n=[];d+=1,h=b.Application.initApp("OAC.Client.StreamingVideo",c,a.extend(!0,{},{viewSetup:'<div id="'+l+'" class="section-canvas"></div>'+'<div class="mithgrid-bottomarea">'+'<div id="sidebar'+l+'" class="section-controls"></div>'+'<div class="section-annotations">'+'<div class="header">'+"Annotations"+"</div>"+"</div>"+"</div>",presentations:{raphsvg:{container:"#"+l,lenses:{},lensKey:[".shapeType"]},annoItem:{container:".section-annotations",lenses:{},lensKey:[".bodyType"]}}},e)),h.cWidth=100,h.cHeight=100,h.cX=0,h.cY=0,h.shapeTypes={},h.initShapeLens=function(a,b,c,d){var e={id:d};e.eventFocus=function(){e.shape.attr({opacity:1}).toFront(),b.events.onDelete.addListener(e.eventDelete)},e.eventUnfocus=function(){e.shape.attr({opacity:.5}).toBack(),b.events.onDelete.removeListener(e.eventDelete)},e.eventDelete=function(a){a===d&&c.removeItems([d])},e.eventResize=function(a,b){a===d&&c.updateItems([{id:d,w:b.width,h:b.height}])},e.eventMove=function(a,b){a===d&&c.updateItems([{id:d,x:b.x,y:b.y}])},e.remove=function(a){e.shape.remove()};return e},h.initTextLens=function(b,c,d,e){var f={},i=d.getItem(e),j,k,l,m;j=a('<div class="anno_item"><p class="bodyContentInstructions">Double click here to open edit window.</p><div class="editArea"><textarea class="bodyContentTextArea"></textarea></div><div class="body"><p class="bodyContent"></p></div></div>'),l=a(j).find(".bodyContentTextArea"),m=a(j).find(".bodyContent"),a(l).text(i.bodyContent[0]),a(m).text(i.bodyContent[0]),a(b).append(j),a(j).find(".editArea").hide(),k=g.bind(j,{model:d,itemId:e}),f.eventUpdate=function(a,b){a===e&&d.updateItems([{id:e,bodyContent:b}])},f.eventFocus=function(){j.addClass("selected")},f.eventUnfocus=function(){j.removeClass("selected")},k.events.onClick.addListener(h.setActiveAnnotation),k.events.onUpdate.addListener(f.eventUpdate),f.update=function(b){a(j).find(".bodyContent").text(b.bodyContent[0]),a(j).find(".bodyContentTextArea").text(b.bodyContent[0])},f.remove=function(){a(j).remove()};return f},h.buttonFeature=function(b,c,d){if(a("#"+d).length!==0)return!1;var e={},f,g=a(".button"),i,j=a("#sidebar"+l),k,m,n;b==="buttongrouping"?(a(j).find("#"+c).length===0&&a(j).append('<div id="'+c+'" class="buttongrouping"></div>'),i=a("#"+c),f='<div id="'+d+'" class="button">'+d+"</div>",a(i).append(f),e.element=a("#"+d),k=h.controller.buttonActive.bind(e.element,{action:d})):b==="slidergrouping"&&(a(j).find("#"+c).length===0&&a(j).append('<div id="'+c+'" class="slidergrouping"></div>'),i=a("#"+c),f='<div id="'+d+'"><div class="header">'+d+"</div>"+'<div id="slider"></div><div class="timedisplay"></div></div>',a(i).append(f),e.element=a("#"+d),k=h.controller.slider.bind(e.element,{action:d}));return e},h.addShape=function(a,b){h.presentation.raphsvg.addLens(a,b)},h.addBody=function(a,b){h.presentation.annoItem.addLens(a,b)},h.addShapeType=function(a,b){var c,d,e;d=b.calc,e=b.lens,c=h.buttonFeature("Shapes",a),h.shapeTypes[a]={calc:d},h.addShape(a,e)},h.insertShape=function(b){var c,d=h.dataStore.canvas.prepare(["!type"]),e=d.evaluate("Annotation"),f=h.getCurrentTime()-5,g=h.getCurrentTime()+5,i=h.getCurrentMode(),j;j=h.shapeTypes[i].calc(b),c={id:"anno"+e.length,type:"Annotation",bodyType:"Text",bodyContent:"This is an annotation for "+i,shapeType:i,opacity:1,ntp_start:f,ntp_end:g},a.extend(c,j),h.dataStore.canvas.loadItems([c])},h.exportShapes=function(){var b,c;b=a("#"+l).width(),c=a("#"+l).height(),a.each([])},h.ready(function(){g=h.controller.annoActive,h.events.onActiveAnnotationChange.addListener(h.presentation.raphsvg.eventFocusChange),h.events.onActiveAnnotationChange.addListener(h.presentation.annoItem.eventFocusChange),h.events.onCurrentTimeChange.addListener(function(a){h.dataView.currentAnnotations.setKeyRange(a-5,a+5)})}),h.ready(function(){var c,d,e,f,g,i,j,k,l,m;c=function(a){var b={};b.x=a.x+a.width/2,b.y=a.y+a.height/2,b.w=a.width,b.h=a.height;return b},l=function(b,c,d){var e={},f;f=a.extend(!0,{},b),e.x=f.x/c*100,e.y=f.y/d*100,e.w=f.w/c*100,e.h=f.h/d*100,a.extend(f,e);return f},e=function(c,d,e,f){var g=h.initShapeLens(c,d,e,f),i=e.getItem(f),j,k;j=d.canvas.rect(i.x[0]-i.w[0]/2,i.y[0]-i.h[0]/2,i.w[0],i.h[0]),j.attr({fill:"red",opacity:i.opacity}),a(j.node).attr("id",i.id[0]),g.update=function(a){try{a.x!==undefined&&a.y!==undefined&&a.w!==undefined&&a.y!==undefined&&j.attr({x:a.x[0]-a.w[0]/2,y:a.y[0]-a.h[0]/2,width:a.w[0],height:a.h[0],opacity:a.opacity})}catch(c){b.debug(c)}},d.events.onOpacityChange.addListener(function(b){a(j).attr("opacity",b)}),g.getExtents=function(){return{x:j.attr("x")+j.attr("width")/2,y:j.attr("y")+j.attr("height")/2,width:j.attr("width"),height:j.attr("height")}},g.shape=j;return g},h.addShapeType("Rectangle",{calc:c,lens:e}),d=function(a){var b={};b.x=a.x+a.width/2,b.y=a.y+a.height/2,b.w=a.width,b.h=a.height;return b},f=function(a,c,d,e){var f=h.initShapeLens(a,c,d,e),g=d.getItem(e),i;i=c.canvas.ellipse(g.x[0],g.y[0],g.w[0]/2,g.h[0]/2),i.attr({fill:"red",opacity:.5}),f.update=function(a){try{a.x!==undefined&&a.y!==undefined&&i.attr({cx:a.x[0],cy:a.y[0],rx:a.w[0]/2,ry:a.h[0]/2})}catch(c){b.debug(c)}},f.getExtents=function(){return{x:i.attr("cx"),y:i.attr("cy"),width:i.attr("rx")*2,height:i.attr("ry")*2}},f.shape=i;return f},h.addShapeType("Ellipse",{calc:d,lens:f}),h.addBody("Text",h.initTextLens),g=h.buttonFeature("buttongrouping","Shapes","Rectangle"),i=h.buttonFeature("buttongrouping","Shapes","Ellipse"),j=h.buttonFeature("buttongrouping","General","Select"),m=h.buttonFeature("buttongrouping","General","Watch"),h.setCurrentTime(0)}),h.ready(function(){var a;e.playerobject!==undefined&&(m=e.playerobject.getcoordinates(),n=e.playerobject.getsize(),h.setPlayer([m[0],m[1],n[0],n[1]]),h.setCurrentTime(e.playerobject.getPlayhead()),e.playerobject.onPlayheadUpdate(function(a){h.setCurrentTime(h.getCurrentTime()+1)}),h.events.onCurrentModeChange.addListener(function(a){console.log("mode: "+a),a!=="Watch"?e.playerobject.pause():a==="Watch"&&e.playerobject.play()}))});return h}}(jQuery,MITHGrid,OAC),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.CanvasClickController",{bind:{events:{onClick:null,onShapeStart:null,onShapeDrag:null,onShapeDone:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.AnnoActiveController",{bind:{events:{onClick:null,onDelete:null,onUpdate:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid",{bind:{events:{onResize:null,onMove:null,onEdit:null,onDelete:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.KeyboardListener",{bind:{events:{onDelete:["preventable","unicast"]}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.AnnotationCreationButton",{bind:{events:{onCurrentModeChange:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.ShapeCreateBox",{bind:{events:{}}}),MITHGrid.defaults("OAC.Client.StreamingVideo",{controllers:{keyboard:{type:OAC.Client.StreamingVideo.Controller.KeyboardListener,selectors:{doc:""}},shapeEditBox:{type:OAC.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid},shapeCreateBox:{type:OAC.Client.StreamingVideo.Controller.ShapeCreateBox},canvas:{type:OAC.Client.StreamingVideo.Controller.CanvasClickController,selectors:{svg:" > svg"}},annoActive:{type:OAC.Client.StreamingVideo.Controller.AnnoActiveController,selectors:{annotation:"",annotationlist:":parent",bodycontent:".bodyContent",body:".body",editbutton:".button.edit",editarea:".editArea",textarea:".editArea > textarea",updatebutton:".button.update",deletebutton:".button.delete"}},buttonActive:{type:OAC.Client.StreamingVideo.Controller.AnnotationCreationButton,selectors:{button:""}},slider:{type:OAC.Client.StreamingVideo.Controller.sliderButton,selectors:{slider:"#slider",timedisplay:".timedisplay"}}},variables:{ActiveAnnotation:{is:"rw"},CurrentTime:{is:"rw","default":0},CurrentMode:{is:"rw"},Player:{is:"rw"}},dataViews:{drawspace:{dataStore:"canvas",types:["Annotation"]},currentAnnotations:{dataStore:"canvas",type:MITHGrid.Data.RangePager,leftExpressions:[".ntp_start"],rightExpressions:[".ntp_end"]}},dataStores:{canvas:{types:{Annotation:{}},properties:{shapeType:{valueType:"text"},bodyType:{valueType:"text"},bodyContent:{valueType:"text"},targetURI:{valueType:"uri"},opacity:{valueType:"numeric"},start_ntp:{valueType:"numeric"},end_ntp:{valueType:"numeric"}}}},presentations:{raphsvg:{type:MITHGrid.Presentation.RaphaelCanvas,dataView:"currentAnnotations",controllers:{keyboard:"keyboard",editBox:"editBox",canvas:"canvas",shapeCreateBox:"shapeCreateBox",shapeEditBox:"shapeEditBox"},fadeStart:5},annoItem:{type:MITHGrid.Presentation.AnnotationList,dataView:"currentAnnotations",container:".anno_list"}}});