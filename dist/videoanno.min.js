/*
 *  OAC Video Annotation Tool v0.1
 * 
 *  Developed as a plugin for the MITHGrid framework. 
 *  
 *  Date: Thu Nov 17 15:08:41 2011 -0500
 *  
 * Educational Community License, Version 2.0
 * 
 * Copyright 2011 University of Maryland. Licensed under the Educational
 * Community License, Version 2.0 (the "License"); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License at
 * 
 * http://www.osedu.org/licenses/ECL-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 * 
 */
var MITHGrid=MITHGrid||{},jQuery=jQuery||{},Raphael=Raphael||{},OAC=OAC||{},app={};MITHGrid.globalNamespace("OAC"),OAC.namespace("Client"),OAC.Client.namespace("StreamingVideo"),function(a,b,c){c.Client.StreamingVideo.initApp=function(d,e){var f,g;g=c.Client.StreamingVideo.Controller.annoActiveController({selectors:{annotation:"",annotationlist:":parent",bodycontent:"> .bodyContent",editbutton:"> .bodyContent > .button.edit",editarea:"> .editArea",textarea:"> .editArea > textarea",updatebutton:"> .editArea > .button.update",deletebutton:"> .button.delete"}}),app=b.Application.initApp("OAC.Client.StreamingVideo",d,a.extend(!0,{},e,{variables:{ActiveAnnotation:{is:"rw"}},dataViews:{drawspace:{dataStore:"canvas",types:["Rectangle","Ellipse"],label:"drawspace"}},viewSetup:'<div id="canvasSVG" class="canvas_svg"></div><div id="annoList" class="anno_list"></div>',presentations:{raphsvg:{type:b.Presentation.RaphaelCanvas,container:"#canvasSVG",dataView:"drawspace",lenses:{Rectangle:function(a,c,d,e){var f={id:e},g=d.getItem(e),h,i,j,k,l=g.active[0];i=g.x-g.w[0]/2,j=g.y-g.h[0]/2,h=c.canvas.rect(i,j,g.w[0],g.h[0]),h.attr({fill:"red",opacity:l?1:.5}),f.update=function(a){a.active[0]&&l===!1?(h.attr({opacity:1}).toFront(),l=!0,c.editBoundingBox.attachRendering(f),c.keyBoardListener.events.eventDelete.addListener(f.eventDeleteHandle)):a.active[0]===!1&&l===!0&&(h.attr({opacity:.5}).toBack(),l=!1,c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(f.eventDeleteHandle));try{a.x!==undefined&&a.y!==undefined&&a.w!==undefined&&a.y!==undefined&&f.shape.attr({x:a.x[0]-a.w[0]/2,y:a.y[0]-a.h[0]/2,width:a.w[0],height:a.h[0]})}catch(b){console.log(b)}},f.remove=function(a){h.remove(),c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(f.eventDeleteHandle)},f.getExtents=function(){return{x:h.attr("x")+h.attr("width")/2,y:h.attr("y")+h.attr("height")/2,width:h.attr("width"),height:h.attr("height")}},f.shapeIsActive=b.initEventFirer(!1,!1),f.eventClickHandle=function(a){a===e?d.updateItems([{id:e,active:!0}]):d.updateItems([{id:e,active:!1}])},f.eventResizeHandle=function(a,b){a===e&&d.updateItems([{id:e,w:b.width,h:b.height}])},f.eventMoveHandle=function(a,b){a===e&&d.updateItems([{id:e,x:b.x,y:b.y}])},f.eventDeleteHandle=function(a){a===e&&d.removeItems([e])},f.shape=h,c.canvasEvents.registerRendering(f),app.events.onActiveAnnotationChange.addListener(f.eventClickHandle);return f},Ellipse:function(a,c,d,e){var f={id:e},g=d.getItem(e),h,i=g.active[0];h=c.canvas.ellipse(g.x[0],g.y[0],g.w[0]/2,g.h[0]/2),h.attr({fill:"red",opacity:i?1:.5}),f.update=function(a){a.active[0]&&i===!1?(h.attr({opacity:1}).toFront(),i=!0,c.editBoundingBox.attachRendering(f),c.keyBoardListener.events.eventDelete.addListener(f.eventDeleteHandle)):a.active[0]===!1&&i===!0&&(h.attr({opacity:.5}).toBack(),i=!1,c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(f.eventDeleteHandle));try{a.x!==undefined&&a.y!==undefined&&h.attr({cx:a.x[0],cy:a.y[0],rx:a.w[0]/2,ry:a.h[0]/2})}catch(b){console.log(b)}},f.remove=function(){h.remove(),c.editBoundingBox.detachRendering(),c.keyBoardListener.events.eventDelete.removeListener(f.eventDeleteHandle)},f.getExtents=function(){return{x:h.attr("cx"),y:h.attr("cy"),width:h.attr("rx")*2,height:h.attr("ry")*2}},f.eventClickHandle=function(a){a===e?d.updateItems([{id:e,active:!0}]):d.updateItems([{id:e,active:!1}])},f.eventResizeHandle=function(a,b){a===e&&d.updateItems([{id:e,w:b.width,h:b.height}])},f.eventMoveHandle=function(a,b){a===e&&d.updateItems([{id:e,x:b.x,y:b.y}])},f.eventDeleteHandle=function(a){a===e&&d.removeItems([e])},f.shapeIsActive=b.initEventFirer(!0,!1),f.shape=h,c.canvasEvents.registerRendering(f),app.events.onActiveAnnotationChange.addListener(f.eventClickHandle);return f}}},annoItem:{type:b.Presentation.AnnotationList,dataView:"drawspace",container:".anno_list",lenses:{Rectangle:function(b,c,d,e){var h={},i=d.getItem(e),j;a("#delete"+i.id[0]).live("click",function(a){a.preventDefault(),d.removeItems([i.id[0]])}),j=f(i,b),h.annoEvents=g.bind(j,{model:d,itemId:e}),h.clickEventHandle=function(a){a===e&&i.active[0]!==!0&&d.updateItems([{id:e,active:!0}])},h.updateEventHandle=function(a,b){a===e&&d.updateItems([{id:e,bodyContent:b}])},h.annoEvents.events.eventClick.addListener(h.clickEventHandle),h.annoEvents.events.eventUpdate.addListener(h.updateEventHandle),h.update=function(a){a.active[0]?j.addClass("selected"):j.removeClass("selected")},h.remove=function(){a("#"+i.id).remove()};return h},Ellipse:function(b,c,d,e){var h={},i=d.getItem(e),j;a("#delete"+i.id[0]).live("click",function(a){a.preventDefault(),d.removeItems([i.id[0]])}),j=f(i,b),h.annoEvents=g.bind(j,{model:d,itemId:e}),h.updateEventHandle=function(a,b){a===e&&d.updateItems([{id:e,bodyContent:b}])},h.annoEvents.events.eventUpdate.addListener(h.updateEventHandle),h.update=function(a){a.active[0]?j.addClass("selected"):j.removeClass("selected")},h.remove=function(){a("#"+i.id).remove()};return h}}}},cWidth:e.width,cHeight:e.height})),f=function(b,c){var d=b.active[0]?"anno_item selected":"anno_item",e='<div id="'+b.id[0]+'" class="'+d+'">'+'<div class="editArea">'+'<textarea class="bodyContentTextArea">'+b.bodyContent[0]+"</textarea>"+"<br/>"+'<div id="update'+b.id[0]+'" class="button update">Update</div>'+"</div>"+'<div class="bodyContent">'+"<p>"+b.bodyContent[0]+"</p>"+'<div id="#edit'+b.id[0]+'" class="button edit">Edit</div>'+"</div>"+"</div>";a("#"+b.id[0]).remove(),a(c).append(e),a("#"+b.id[0]+" > .editArea").hide();return a("#"+a(c).attr("id")+" > #"+b.id[0])};return app}}(jQuery,MITHGrid,OAC),MITHGrid.defaults("OAC.Client.StreamingVideo",{dataStores:{canvas:{types:{Rectangle:{},Ellipse:{}},properties:{bodyContent:{valueType:"String"},targetURI:{valueType:"Item"},active:{valueType:"Bool"}}}}}),function(a,b,c){c.Client.StreamingVideo.namespace("Controller"),c.Client.StreamingVideo.Controller.keyBoardListener=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.keyBoardListener",c);d.options=c,d.applyBindings=function(c,d){var e=c.locate("doc"),f,g=function(a){f=a};app.events.onActiveAnnotationChange.addListener(g),c.events={eventDelete:b.initEventFirer(!0,!0)},a(e).keydown(function(a){if(f!==undefined||f!=="")if(a.keyCode===8||a.keyCode===46)c.events.eventDelete.fire(f),f=""})};return d},c.Client.StreamingVideo.Controller.annotationEditSelectionGrid=function(c){var d=b.Controller.initRaphaelController("OAC.Client.StreamingVideo.Controller.annotationEditSelectionGrid",c);c=d.options,d.handleSet={},d.midDrag={},d.svgBBox={},d.rendering={},d.handles={},d.itemMenu={},d.deleteButton={},d.editButton={},d.menuContainer={},d.dirs=d.options.dirs||["ul","top","ur","lft","lr","btm","ll","rgt","mid"],d.eventResize=b.initEventFirer(!0,!1),d.eventDrag=b.initEventFirer(!0,!1),d.eventEdit=b.initEventFirer(!0,!1),d.eventDelete=b.initEventFirer(!0,!1),d.applyBindings=function(b,c){var e,f,g={},i,j,k=c.paper,l={},m=5,n,o,p,q={},r,s={},t={},u={},v,w={},x={},y;b.attachRendering=function(a){d.rendering=a,j=d.rendering.shape,n(),r(),d.rendering.eventResizeHandle!==undefined&&d.eventResize.addListener(d.rendering.eventResizeHandle),d.rendering.eventMoveHandle!==undefined&&d.eventDrag.addListener(d.rendering.eventMoveHandle)},b.detachRendering=function(){d.rendering.eventResizeHandle!==undefined&&d.eventResize.removeListener(d.rendering.eventResizeHandle),d.rendering.eventMoveHandle!==undefined&&d.eventDrag.removeListener(d.rendering.eventMoveHandle),d.handleSet.hide(),d.svgBBox.hide(),d.midDrag.hide(),d.itemMenu&&d.itemMenu.hide()},n=function(){i=d.rendering.getExtents(),px=4*(e-i.x)/i.width+2,py=4*(f-i.y)/i.height+2,px<1?g.x=-1:px<3?g.x=0:g.x=1,py<1?g.y=-1:py<3?g.y=0:g.y=1,l.width=i.width+2*m,l.height=i.height+2*m,l.x=i.x-m/8-l.width/2,l.y=i.y-m/8-l.height/2,o(l),d.itemMenu&&p(l)},r=function(){a.isEmptyObject(d.handleSet)?(d.handleSet=k.set(),a.each(d.handles,function(a,b){a==="mid"?(d.midDrag=k.rect(b.x,b.y,m,m),b.id=d.midDrag.id):(h=k.rect(b.x,b.y,m,m),b.id=h.id,h.attr({cursor:b.cursor}),d.handleSet.push(h))}),d.handleSet.attr({fill:99e4,stroke:"black"}),a.isEmptyObject(d.midDrag)||d.midDrag.attr({fill:99e4,stroke:"black",cursor:"move"}),d.svgBBox=k.rect(l.x,l.y,l.width,l.height),d.svgBBox.attr({stroke:"green","stroke-dasharray":["--"]}),p(l),a.isEmptyObject(d.midDrag)||d.midDrag.drag(function(a,b){s.nx=l.x+a,s.ny=l.y+b,shapeAttrs.x=i.x+a,shapeAttrs.y=i.y+b,d.svgBBox.attr({x:s.nx,y:s.ny}),o({x:s.nx,y:s.ny,width:l.width,height:l.height}),d.itemMenu&&p({x:s.nx,y:s.ny,width:l.width,height:l.height})},function(a,b,c){e=c.offsetX,f=c.offsetY,n(),d.rendering.shape.attr({cursor:"move"})},function(){var a={x:shapeAttrs.x,y:shapeAttrs.y};d.eventDrag.fire(d.rendering.id,a),d.rendering.shape.attr({cursor:"default"})}),d.handleSet.drag(function(a,b){shapeAttrs.w=i.width+2*a*g.x,shapeAttrs.h=i.height+2*b*g.y,s.nw=i.width+2*a*g.x+m*2,s.nh=i.height+2*b*g.y+m*2,s.nx=i.x-m/4-nw/2,s.ny=i.y-m/4-nh/2,d.svgBBox.attr({x:s.nx,y:s.ny,width:s.nw,height:s.nh}),o({x:s.nx,y:s.ny,width:s.nw,height:s.nh}),d.itemMenu&&p({x:s.nx,y:s.ny,width:s.nw,height:s.nh})},function(a,b,c){e=c.offsetX,f=c.offsetY,n()},function(){pos={width:shapeAttrs.w,height:shapeAttrs.h},d.eventResize.fire(d.rendering.id,pos)})):(d.svgBBox.show(),d.svgBBox.attr({x:l.x,y:l.y,width:l.width,height:l.height}),d.handleSet.show(),d.midDrag.show().toFront(),d.itemMenu&&(d.itemMenu.show(),p(l)))},p=function(b){a.isEmptyObject(d.itemMenu)?(u.x=b.x+b.width,u.y=b.y-m*4-2,u.w=100,u.h=20,x={x:u.x+2,y:u.y+2,w:u.w/2-4,h:u.h-u.h/8},w={x:x.x+x.w+2,y:u.y+2,w:u.w/2-4,h:u.h-u.h/8},d.itemMenu=k.set(),d.menuContainer=k.rect(u.x,u.y,u.w,u.h),d.menuContainer.attr({fill:"#FFFFFF",stroke:"#000"}),d.itemMenu.push(d.menuContainer),d.editButton=k.rect(x.x,x.y,x.w,x.h),d.editButton.attr({fill:334009,cursor:"pointer"}),d.itemMenu.push(d.editButton),d.deleteButton=k.rect(w.x,w.y,w.w,w.h),d.deleteButton.attr({fill:334009,cursor:"pointer"}),d.itemMenu.push(d.deleteButton),d.editButton.mousedown(function(){d.rendering!==undefined&&d.eventEdit.fire(d.rendering.id)}),d.deleteButton.mousedown(function(){d.rendering!==undefined&&(d.eventDelete.fire(d.rendering.id),itemDeleted())})):(u.x=b.x+b.width,u.y=b.y-m*4-2,x={x:u.x+2,y:u.y+2},w={x:x.x+d.editButton.attr("width")+2,y:u.y+2},d.menuContainer.attr({x:u.x,y:u.y}),d.editButton.attr(x),d.deleteButton.attr(w))},itemDeleted=function(){d.rendering=undefined,d.itemMenu.hide(),d.svgBBox.hide(),d.handleSet.hide(),d.midDrag.hide()},o=function(b){a.each(d.dirs,function(a,c){switch(c){case"ul":d.handles.ul===undefined?d.handles.ul={x:b.x,y:b.y,cursor:"nw-resize"}:(d.handles.ul.x=b.x,d.handles.ul.y=b.y,y=k.getById(d.handles.ul.id),y.attr({x:d.handles.ul.x,y:d.handles.ul.y}));break;case"top":d.handles.top===undefined?d.handles.top={x:b.x+b.width/2,y:b.y,cursor:"n-resize"}:(d.handles.top.x=b.x+b.width/2,d.handles.top.y=b.y,y=k.getById(d.handles.top.id),y.attr({x:d.handles.top.x,y:d.handles.top.y}));break;case"ur":d.handles.ur===undefined?d.handles.ur={x:b.x+(b.width-m),y:b.y,cursor:"ne-resize"}:(d.handles.ur.x=b.x+(b.width-m),d.handles.ur.y=b.y,y=k.getById(d.handles.ur.id),y.attr({x:d.handles.ur.x,y:d.handles.ur.y}));break;case"rgt":d.handles.rgt===undefined?d.handles.rgt={x:b.x-m+b.width,y:b.y-m+b.height/2,cursor:"e-resize"}:(d.handles.rgt.x=b.x-m+b.width,d.handles.rgt.y=b.y-m+b.height/2,y=k.getById(d.handles.rgt.id),y.attr({x:d.handles.rgt.x,y:d.handles.rgt.y}));break;case"lr":d.handles.lr===undefined?d.handles.lr={x:b.x-m+b.width,y:b.y-m+b.width,cursor:"se-resize"}:(d.handles.lr.x=b.x-m+b.width,d.handles.lr.y=b.y-m+b.height,y=k.getById(d.handles.lr.id),y.attr({x:d.handles.lr.x,y:d.handles.lr.y}));break;case"btm":d.handles.btm===undefined?d.handles.btm={x:b.x+b.width/2,y:b.y-m+b.height,cursor:"s-resize"}:(d.handles.btm.x=b.x+b.width/2,d.handles.btm.y=b.y-m+b.height,y=k.getById(d.handles.btm.id),y.attr({x:d.handles.btm.x,y:d.handles.btm.y}));break;case"ll":d.handles.ll===undefined?d.handles.ll={x:b.x,y:b.y-m+b.height,cursor:"sw-resize"}:(d.handles.ll.x=b.x,d.handles.ll.y=b.y-m+b.height,y=k.getById(d.handles.ll.id),y.attr({x:d.handles.ll.x,y:d.handles.ll.y}));break;case"lft":d.handles.lft===undefined?d.handles.lft={x:b.x,y:b.y+b.height/2,cursor:"w-resize"}:(d.handles.lft.x=b.x,d.handles.lft.y=b.y+b.height/2,y=k.getById(d.handles.lft.id),y.attr({x:d.handles.lft.x,y:d.handles.lft.y}));break;case"mid":d.handles.mid===undefined?d.handles.mid={x:b.x+b.width/2,y:b.y+b.height/2,cursor:"pointer"}:(d.handles.mid.x=b.x+b.width/2,d.handles.mid.y=b.y+b.height/2,y=k.getById(d.handles.mid.id),y.attr({x:d.handles.mid.x,y:d.handles.mid.y}))}})}};return d},c.Client.StreamingVideo.Controller.annoActiveController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.annoActiveController",c);c=d.options,d.applyBindings=function(c,d){var e,f,g,h,i,j,k;e=c.locate("annotation"),f=c.locate("bodycontent"),g=c.locate("annotations"),j=c.locate("textarea"),i=c.locate("editarea"),k=c.locate("editbutton"),updateButton=c.locate("updatebutton"),h=c.locate("deletebutton"),c.events={},c.events.eventClick=b.initEventFirer(!0,!1),c.events.eventDelete=b.initEventFirer(!0,!1),c.events.eventUpdate=b.initEventFirer(!0,!1),c.renderings={},c.active=!1,editStart=function(){a(i).show(),a(f).hide(),c.active=!0,c.events.eventClick.fire(d.itemId)},editEnd=function(){a(i).hide(),a(f).show(),c.active=!1},editUpdate=function(b){b.preventDefault();var e=a(j).val();c.events.eventUpdate.fire(d.itemId,e),editEnd()},a(k).live("click",function(a){a.preventDefault(),c.active?editEnd():editStart()}),a(updateButton).live("click",editUpdate),a(e).live("click",function(a){app.setActiveAnnotation(d.itemId)})};return d},c.Client.StreamingVideo.Controller.canvasController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.canvasClickController",c);d.options=c,d.applyBindings=function(c,d){var e,f,g,h,i=c.locate("svg"),j=d.closeEnough,k,l,m,n,o,p,q=d.paper,r=a(i).offset(),s=function(a){if(c.curRendering===undefined||a!==c.curRendering.id){var b=c.renderings[a];if(b===undefined){c.event.eventClick.fire(""),c.curRendering=undefined;return!1}c.curRendering=b}},t=function(a){if(c.curRendering===undefined||a!==c.curRendering.id)var b=c.renderings[a]};app.events.onActiveAnnotationChange.addListener(s),c.event={},c.event.eventClick=b.initEventFirer(!0,!1),c.renderings={},c.curRendering=undefined,c.registerRendering=function(a){c.renderings[a.id]=a,a.shapeIsActive!==undefined&&a.shapeIsActive.addListener(s)},c.removeRendering=function(b){var d={},e;b.eventClickHandle!==undefined&&c.event.eventClick.removeListener(b.eventClickHandle),a.each(c.renderings,function(a,c){a!==b.id&&(d[a]=c)}),c.renderings=a.extend(!0,{},d)},a(i).bind("mousedown",function(b){h="",r=a(i).offset(),e=Math.abs(b.pageX-r.left),f=Math.abs(b.pageY-r.top),a.each(c.renderings,function(a,b){g=b.getExtents(),k=Math.abs(e-g.x),l=Math.abs(f-g.y);if(k<=g.width&&l<=g.height){h=b.id;if(c.curRendering===undefined||b.id!==c.curRendering.id)c.curRendering=b,app.setActiveAnnotation(b.id);return!1}}),h.length===0&&c.curRendering!==undefined&&(app.setActiveAnnotation("null"),c.curRendering=undefined)})};return d}}(jQuery,MITHGrid,OAC),function(a,b,c){var d,e,f;d=c.Client.StreamingVideo.Controller.canvasController({selectors:{svg:""}}),e=c.Client.StreamingVideo.Controller.annotationEditSelectionGrid({}),f=c.Client.StreamingVideo.Controller.keyBoardListener({selectors:{doc:""}}),b.Presentation.namespace("AnnotationList"),b.Presentation.AnnotationList.initPresentation=function(a,c){var d=b.Presentation.initPresentation("AnnotationList",a,c);return d},b.Presentation.namespace("RaphaelCanvas"),b.Presentation.RaphaelCanvas.initPresentation=function(c,g){var h=b.Presentation.initPresentation("RaphaelCanvas",c,g),i=a(c).attr("id"),j,k;g.cWidth!==undefined?k=g.cWidth:k=a(c).width(),g.cHeight!==undefined?j=g.cHeight:j=a(c).height(),h.canvas=new Raphael(i,k,j),h.canvasEvents=d.bind(c,{closeEnough:5,paper:h.canvas}),h.editBoundingBox=e.bind(a(c),{paper:h.canvas}),h.keyBoardListener=f.bind(a("body"),{});return h}}(jQuery,MITHGrid,OAC);