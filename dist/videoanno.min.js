/*
# OAC Video Annotation Tool v
# 
# The **OAC Video Annotation Tool** is a MITHGrid application providing annotation capabilities for streaming
# video embedded in a web page. 
#  
# Date: Tue May 1 11:30:18 2012 -0400
#  
# Educational Community License, Version 2.0
# 
# Copyright 2011 University of Maryland. Licensed under the Educational
# Community License, Version 2.0 (the "License"); you may not use this file
# except in compliance with the License. You may obtain a copy of the License at
# 
# http:#www.osedu.org/licenses/ECL-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under
# the License.
#
# Author: Grant Dickie
*/
(function(){var a,b=Array.prototype.slice,c=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};a=MITHGrid.globalNamespace("OAC"),a.namespace("Client"),a.Client.namespace("StreamingVideo"),function(a,d,e){var f,g,h,i,j,k;e.Client.StreamingVideo.namespace("Controller",function(c){var e;e=function(a,b){var c,d;c=0,d=0;while(a!=null)c+=a.offsetLeft,d+=a.offsetTop,a=a.offsetParent;return{x:b.pageX-c,y:b.pageY-d}},c.namespace("KeyboardListener",function(c){return c.initInstance=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Controller).initInstance.apply(e,["OAC.Client.StreamingVideo.Controller.KeyboardListener"].concat(b.call(c),[function(b){var c,d;d=b.options,c=d.isActive||function(){return!0};return b.applyBindings=function(b,e){var f;f=b.locate("doc"),d.application.events.onActiveAnnotationChange.addListener(function(a){var b;return b=a});return a(f).keydown(function(a){var d,e;if(c()&&typeof d!="undefined"&&d!==null)if((e=a.keyCode)===8||e===46){b.events.onDelete.fire(d);return d=null}})}}]))}}),c.namespace("Drag",function(a){return a.initInstance=function(){var a,c;a=1<=arguments.length?b.call(arguments,0):[];return(c=d.Controller.Raphael).initInstance.apply(c,["OAC.Client.StreamingVideo.Controller.Drag"].concat(b.call(a),[function(a){a.applyBindings=function(a){var b,c,d,f;f=a.locate("raphael"),d=function(b,c,d){var g;g=e(f.node,d);return a.events.onFocus.fire(g.x,g.y)},b=function(){return a.events.onUnfocus.fire()},c=function(b,c){return a.events.onUpdate.fire(b,c)};return f.drag(c,d,b)};return a.removeBindings=function(a){var b;b=a.locate("raphael");return b.undrag}}]))}}),c.namespace("Select",function(a){return a.initInstance=function(){var a,c;a=1<=arguments.length?b.call(arguments,0):[];return(c=d.Controller.Raphael).initInstance.apply(c,["OAC.Client.StreamingVideo.Controller.Select"].concat(b.call(a),[function(a){var b,c;c=a.options,b=c.isSelectable||function(){return!0};return a.applyBindings=function(a){var c;c=a.locate("raphael");return c.click(function(c){if(b())return a.events.onSelect.fire()})}}]))}}),c.namespace("TextBodyEditor",function(c){return c.initInstance=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Controller).initInstance.apply(e,["OAC.Client.StreamingVideo.Controller.TextBodyEditor"].concat(b.call(c),[function(b){var c;c=b.options;return b.applyBindings=function(b,d){var e,f,g,h,i,j,k,l,m,n,o,p,q;f=b.locate("annotation"),h=b.locate("body"),e=b.locate("annotations"),p=b.locate("textarea"),j=b.locate("editarea"),k=b.locate("editbutton"),q=b.locate("updatebutton"),i=b.locate("deletebutton"),g=!1,o=null,m=function(){a(j).show(),a(h).hide(),g=!0;return b.events.onClick.fire(d.itemId)},l=function(){a(j).hide(),a(h).show();return g=!1},n=function(c){var e;e=a(p).val(),c.preventDefault(),b.events.onUpdate.fire(d.itemId,e);return l()},a(f).bind("dblclick",function(a){a.preventDefault();if(g){l();return c.application.setCurrentMode(o||"")}m(),o=c.application.getCurrentMode();return c.application.setCurrentMode("TextEdit")}),a(f).bind("click",function(a){return c.application.setActiveAnnotation(d.itemId)}),a(q).bind("click",function(e){b.events.onUpdate.fire(d.itemId,a(p).val()),l();return c.application.setCurrentMode(o)}),a(i).bind("click",function(c){b.events.onDelete.fire(d.itemId);return a(f).remove()}),c.application.events.onActiveAnnotationChange.addListener(function(a){if(a!==d.id&&g){n({preventDefault:function(){}});return l()}});return c.application.events.onCurrentModeChange.addListener(function(a){if(a!=="TextEdit")return l()})}}]))}}),c.namespace("CanvasClickController",function(c){return c.initInstance=function(){var c,f;c=1<=arguments.length?b.call(arguments,0):[];return(f=d.Controller).initInstance.apply(f,["OAC.Client.StreamingVideo.Controller.CanvasClickController"].concat(b.call(c),[function(b){var c,f;c=b.options,f=null;return b.applyBindings=function(b,g){var h,i,j,k,l,m,n,o,p,q;i=g.closeEnough,o={},m=g.paper,j=function(){n(),f=m.rect(0,0,m.width,m.height),f.toFront(),f.attr({fill:"#ffffff",opacity:.01});return a(f.node).css({"pointer-events":"auto"})},n=function(){f!=null&&(f.unmousedown(),f.unmouseup(),f.unmousemove(),f.attr({opacity:0}),f.remove(),f=null);return q()},l=!1,h=function(a){if(!l){l=!0;return d.mouse.capture(function(b){if(a[b]!=null)return a[b](this)})}},q=function(){if(l){d.mouse.uncapture();return l=!1}},k=function(a){var c,d,g,i,k,m;d=!1,l=!1,m=[],c=[],j(),f.unmousedown(),f.unmouseup(),f.unmousemove(),g=function(a){var g,h,i;if(!d){g=e(f.node,a),h=g.x,i=g.y,m=[h,i],c=[h,i],d=!0;return b.events.onShapeStart.fire(m)}},i=function(a){var g,h,i;if(!!d){g=e(f.node,a),h=g.x,i=g.y,c=[h,i];return b.events.onShapeDrag.fire(c)}},k=function(a){if(!!d){d=!1,b.events.onShapeDone.fire(c),q();return f.toFront()}},f.mousedown(g),f.mousemove(i),f.mouseup(k);return h({mousedown:g,mouseup:k,mousemove:i})},p=function(a){j(),f.unmousedown(),f.mousedown(function(a){var b;c.application.setActiveAnnotation(void 0),b=null;return f.toBack()});return f.toBack()},c.application.events.onCurrentModeChange.addListener(function(c){n();return c==="Rectangle"||c==="Ellipse"?k(b.locate("svgwrapper")):c==="Select"?p(b.locate("svgwrapper")):a(b.locate("svgwrapper")).unbind()});return b.toBack=function(){if(f!=null)return f.toBack()}}}]))}}),c.namespace("sliderButton",function(c){return c.initInstance=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Controller).initInstance.apply(e,["OAC.Client.StreamingVideo.Controller.sliderButton"].concat(b.call(c),[function(b){var c;c=b.options;return b.applyBindings=function(b,d){var e,f,g,h,i;e=b.locate("timedisplay"),f=function(b){var c;if(typeof c=="undefined"||c===null){c=b;return a(g).slider("value",c)}},i=function(b,d){var f;c.application.setCurrentTime(d.value),a(e).text("TIME: "+d.value);return f=d.value},h=function(b,d){var f;d==null&&(f=b,a(g).slider("value",b));if(f!==d.value){c.application.setCurrentTime(d.value),a(e).text("TIME: "+d.value);return f=d.value}},g=b.locate("slider");return a(g).slider({start:i,slide:h})}}]))}});return c.namespace("timeControl",function(c){return c.initInstance=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Controller).initInstance.apply(e,["OAC.Client.StreamingVideo.Controller.timeControl"].concat(b.call(c),[function(b){var c;c=b.options,b.currentId="";return b.applyBindings=function(b,d){var e,f,g,h;h=b.locate("timestart"),g=b.locate("timeend"),f=b.locate("submit"),e=b.locate("menudiv"),a(e).hide(),a(f).bind("click",function(){var c,d;d=parseInt(a(h).val(),10),c=parseInt(a(g).val(),10);if(b.currentId!=null&&d!=null&&c!=null){b.events.onUpdate.fire(b.currentId,d,c);return a(e).hide()}});return c.application.events.onActiveAnnotationChange.addListener(function(c){if(c!=null){a(e).show(),a(h).val(""),a(g).val("");return b.currentId=c}return a(e).hide()})}}]))}})}),e.Client.StreamingVideo.namespace("Player",function(c){var e,f;f=[],e=[],c.player=function(a){a==null&&(a=0);return f[a]},c.onNewPlayer=function(a){var b,c,d;for(c=0,d=f.length;c<d;c++)b=f[c],a(b);return e.push(a)},c.register=function(b){var c,d,g,h,i,j,k;h=b.getAvailablePlayers(),k=[];for(i=0,j=h.length;i<j;i++)g=h[i],a(g).data("driver",b),d=b.bindPlayer(g),f.push(d),k.push(function(){var a,b,f;f=[];for(a=0,b=e.length;a<b;a++)c=e[a],f.push(c.call({},d));return f}());return k};return c.namespace("DriverBinding",function(a){return a.initInstance=function(){var a;a=1<=arguments.length?b.call(arguments,0):[];return d.initInstance.apply(d,["OAC.Client.StreamingVideo.Player.DriverBinding"].concat(b.call(a)))}})}),a(document).ready(function(){return e.Client.StreamingVideo.Player.register(j())}),j=function(){var b;b={},b.getAvailablePlayers=function(){var b,c,d,e,f,g,i;b=0,g=a(".dummyplayer"),i=[];for(e=0,f=g.length;e<f;e++)c=g[e],d=a(c).data("player"),d==null&&(d=h(c,b),a(c).data("player",d),d.startDummyPlayer()),b+=1,i.push(d);return i},b.getOACVersion=function(){return"1.0"},b.bindPlayer=function(a){return e.Client.StreamingVideo.Player.DriverBinding.initInstance(function(b){a.onplayheadupdate(function(){return b.events.onPlayheadUpdate.fire(b.getPlayhead())}),b.getCoordinates=function(){var b,c,d,e,f;e=a.getcoordinates(),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(parseInt(b,10));return f},b.getSize=function(){var b,c,d,e,f;e=a.getsize(),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(parseInt(b,10));return f},b.play=a.play,b.pause=a.pause,b.getPlayhead=a.getplayhead;return b.setPlayhead=a.setplayhead})};return b},h=function(b,c){var d;d={},d.startDummyPlayer=function(){d.setAspect(),d.setContent(),d.play();return window.setTimeout(d.secondIntervalUpdate,1e3)},d.setAspect=function(){a(b).css("background",'url("dummyplayer/images/dummy.png") no-repeat scroll right bottom #F8C700');return a(b).css("border","1px solid darkBlue")},d.setContent=function(){var d;d="$('#player-content-"+c+"').parents('.dummyplayer').data('player')";return a(b).append('<ul id="player-content-'+c+'" style="list-style-type: none; padding: 0;">\n\t<li style="text-align: center; font-weight: bold; text-decoration: underline;">Dummy Player #'+(c+1)+'</li>\n\t<li style="text-align: center;">Status: <span class="dummy-status">Paused</span></li>\n\t<li style="text-align: center;">Position: <span class="dummy-position">0</span> seconds</li>\n\t<!-- li style="text-align: center;">\n\t\t<ul style="list-style-type: none; padding: 0;">\n\t\t\t<li style="margin: 0 8px; display: inline;">\n\t\t\t\t<a onClick="'+d+'.rewind(5)"><img src="dummyplayer/images/rewind.png" /></a>\n\t\t\t</li>\n\t\t\t<li style="margin: 0 8px; display: inline;">\n\t\t\t\t<a onClick="'+d+'.toggle()"><img src="dummyplayer/images/playpause.png" /></a>\n\t\t\t</li>\n\t\t\t<li style="margin: 0 8px; display: inline;">\n\t\t\t\t<a onClick="'+d+'.forward(5)"><img src="dummyplayer/images/forward.png" /></a>\n\t\t\t</li>\n\t\t</ul>\n\t</li -->\n</ul>')},d.secondIntervalUpdate=function(){window.setTimeout(d.secondIntervalUpdate,1e3);if(a(b).find(".dummy-status").html()==="Playing")return d.forward(1)},d.toggle=function(){return a(b).find(".dummy-status").html()==="Playing"?d.pause():d.play()},d.pause=function(){return a(b).find(".dummy-status").html("Paused")},d.play=function(){return a(b).find(".dummy-status").html("Playing")},d.rewind=function(a){return d.setplayhead(d.getplayhead()-parseInt(a,10))},d.forward=function(a){return d.setplayhead(d.getplayhead()+parseInt(a,10))},d.setplayhead=function(c){c=parseInt(c,10),c<0&&(c=0),a(b).find(".dummy-position").html(c);return a(b).trigger("timeupdate")},d.getplayhead=function(){return parseInt(a(b).find(".dummy-position").html(),10)},d.getsize=function(){var b;b=[],b.push(parseInt(a("#player-content-"+c).parents(".dummyplayer").css("width"),10)),b.push(parseInt(a("#player-content-"+c).parents(".dummyplayer").css("height"),10));return b},d.getcoordinates=function(){var b;b=[],b.push(a("#player-content-"+c).parents(".dummyplayer").position().top),b.push(a("#player-content-"+c).parents(".dummyplayer").position().left);return b},d.onplayheadupdate=function(c){return a(b).bind("timeupdate",c)};return d},a(document).ready(function(){return e.Client.StreamingVideo.Player.register(i())}),i=function(){var b;b={},b.getAvailablePlayers=function(){return a("video")},b.getOACVersion=function(){return"1.0"},b.bindPlayer=function(b){return e.Client.StreamingVideo.Player.DriverBinding.initInstance(function(c){a(b).bind("loadedmetadata",function(){return c.events.onResize.fire(c.getSize())}),a(b).bind("timeupdate",function(){return c.events.onPlayheadUpdate.fire(b.currentTime)}),c.getCoordinates=function(){return[a(b).position().left,a(b).position().top]},c.getSize=function(){return[a(b).width(),a(b).height()]},c.getTargetURI=function(){return a(b).data("oatarget")},c.play=function(){return b.play()},c.pause=function(){return b.pause()},c.getPlayhead=function(){return b.currentTime};return c.setPlayhead=function(a){return b.currentTime=parseFloat(a)}})};return b},e.Client.StreamingVideo.namespace("Component",function(c){c.namespace("ModeButton",function(c){return c.initInstance=function(){var c;c=1<=arguments.length?b.call(arguments,0):[];return d.initInstance.apply(d,["OAC.Client.StreamingVideo.Component.ModeButton"].concat(b.call(c),[function(b,c){var d,e;e=b.options,d=!1,a(c).mousedown(function(b){if(d===!1){d=!0,e.application.setCurrentMode(e.mode);return a(c).addClass("active")}if(d===!0){d=!1,e.application.setCurrentMode(void 0);return a(c).removeClass("active")}});return e.application.events.onCurrentModeChange.addListener(function(b){if(b===e.mode){d=!0;return a(c).addClass("active")}d=!1;return a(c).removeClass("active")})}]))}}),c.namespace("ShapeEditBox",function(c){return c.initInstance=function(){var c;c=1<=arguments.length?b.call(arguments,0):[];return d.initInstance.apply(d,["OAC.Client.StreamingVideo.Component.ShapeEditBox"].concat(b.call(c),[function(b,c){var d,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;t=b.options,k=e.Client.StreamingVideo.Controller.Drag.initInstance({}),q={},r={},d=null,f={},v={},o={},m={},n={},w=null,s=null,u=5,j=t.dirs,p={ul:["nw",0,0],top:["n",1,0],ur:["ne",2,0],rgt:["e",2,1],lr:["se",2,2],btm:["s",1,2],ll:["sw",0,2],lft:["w",0,1],mid:["pointer",1,1]},i=function(a){var b,c,d,e;b=a.brx,d=a.tlx,c=a.bry,e=a.tly,n.x===0&&n.y===0?(d+=a.dx,b+=a.dx,e+=a.dy,c+=a.dy):(n.x<0?d+=a.dx:n.x>0&&(b+=a.dx),n.y<0?e+=a.dy:n.y>0&&(c+=a.dy)),b>d?a.x=d:a.x=b,c>e?a.y=e:a.y=c,a.width=Math.abs(b-d),a.height=Math.abs(c-e);return a},h=function(a){var b,c,d,e,f,g,h;i(a),b=function(b,c,d){return{x:a.x+c*a.width/2-u/2,y:a.y+d*a.height/2-u/2,cursor:b.length>2?b:b+"-resize"}},e=function(b,c,d){b.x=a.x+c*a.width/2-u/2,b.y=a.y+d*a.height/2-u/2;return b.el.attr({x:b.x,y:b.y})},h=[];for(f=0,g=j.length;f<g;f++)d=j[f],c=p[d],c!=null?r[d]!=null?h.push(e(r[d],c[1],c[2])):h.push(r[d]=b(c[0],c[1],c[2])):h.push(void 0);return h},g=function(){m=d.getExtents(),f={tlx:m.x-m.width/2,tly:m.y-m.height/2,brx:m.x+m.width/2,bry:m.y+m.height/2,dx:0,dy:0};return h(f)},l=function(){var e,j,l,o;if(a.isEmptyObject(q)){q=c.set();for(j in r)o=r[j],j==="mid"?(s=c.rect(o.x,o.y,u,u),a(s.node).css({"pointer-events":"auto"}),o.id=s.id,o.el=s):(e=c.rect(o.x,o.y,u,u),a(e.node).css({"pointer-events":"auto"}),o.id=e.id,o.el=e,e.attr({cursor:o.cursor}),q.push(e));q.attr({fill:"black",stroke:"black"}),a.isEmptyObject(s)||s.attr({fill:"black",stroke:"black",cursor:"move"}),i(f),w=c.rect(f.x,f.y,f.width,f.height),w.attr({stroke:"#333333","stroke-dasharray":["--"]}),a.isEmptyObject(s)||(l=k.bind(s),l.events.onUpdate.addListener(function(a,b){f.dx=a,f.dy=b,h(f);return w.attr({x:f.x,y:f.y})}),l.events.onFocus.addListener(function(a,b){n.x=0,n.y=0,g();return d.shape.attr({cursor:"move"})}),l.events.onUnfocus.addListener(function(){i(f);return b.events.onMove.fire({x:f.x+f.width/2,y:f.y+f.height/2})}));return q.forEach(function(a){var c;c=k.bind(a),c.events.onUpdate.addListener(function(a,b){f.dx=a,f.dy=b,h(f);return w.attr({x:f.x,y:f.y,width:f.width,height:f.height})}),c.events.onFocus.addListener(function(a,b){var c,e;m=d.getExtents(),c=8*(a-m.x)/m.width+4,e=8*(b-m.y)/m.height+4,c<3?n.x=-1:c<5?n.x=0:n.x=1,e<3?n.y=-1:e<5?n.y=0:n.y=1;return g()}),c.events.onUnfocus.addListener(function(){i(f);return b.events.onResize.fire({x:f.x+f.width/2,y:f.y+f.height/2,width:f.width,height:f.height})}),w.toFront(),q.toFront();return s.toFront()})}w.show().toFront(),w.attr({x:f.x,y:f.y,width:f.width,height:f.height}),q.show().toFront();return s.show().toFront()},b.show=function(){g();return l()},b.hide=function(){if(!a.isEmptyObject(q)){q.hide(),w.hide();return s.hide()}},b.attachToRendering=function(a){b.detachFromRendering();if(a!=null){d=a;return b.show()}};return b.detachFromRendering=function(){d=null;return b.hide()}}]))}});return c.namespace("ShapeCreateBox",function(c){return c.initInstance=function(){var c;c=1<=arguments.length?b.call(arguments,0):[];return d.initInstance.apply(d,["OAC.Client.StreamingVideo.Component.ShapeCreateBox"].concat(b.call(c),[function(b,c){var d,e,f,g,h,i;f=b.options,i={},e={},d={},g=10,h={},b.createGuide=function(b){d.x=b[0],d.y=b[1],d.width=0,d.height=0;if(a.isEmptyObject(i)){i=c.rect(d.x,d.y,d.width,d.height);return i.attr({stroke:"#333333","stroke-dasharray":["--"]})}i.show();return i.attr({x:d.x,y:d.y,width:d.width,height:d.height})},b.resizeGuide=function(a){d.width=a[0]-d.x,d.height=a[1]-d.y;return d.width<0?d.height<0?i.attr({width:-d.width,height:-d.height,x:d.x+d.width,y:d.y+d.height}):i.attr({width:-d.width,height:d.height,x:d.x+d.width,y:d.y}):d.height<0?i.attr({width:d.width,height:-d.height,x:d.x,y:d.y+d.height}):i.attr({width:d.width,height:d.height,x:d.x,y:d.y})};return b.completeShape=function(a){b.resizeGuide(a),i.hide(),d.width<0&&(d.x+=d.width,d.width=-d.width),d.height<0&&(d.y+=d.height,d.height=-d.height);return{x:d.x,y:d.y,width:d.width,height:d.height}}}]))}})}),e.Client.StreamingVideo.namespace("Presentation",function(c){c.namespace("AnnotationList",function(c){return c.initInstance=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Presentation).initInstance.apply(e,["OAC.Client.StreamingVideo.Presentation.AnnotationList"].concat(b.call(c),[function(b,c){var d,e;e=b.options,d=e.application;return b.initTextLens=function(b,c,e,f,g){var h,i,j,k,l,m;m={},k=e.getItem(f),l=a('<div class="anno_item">\n\t<p class="bodyContentInstructions">Double click here to open edit window.</p>\n\t<div class="editArea">\n\t\t<textarea class="bodyContentTextArea"></textarea>\n\t\t<div id="editUpdate" class="button update">Update</div>\n\t\t<div id="editDelete" class="button delete">Delete</div>\n\t</div>\n\t<div class="body">\n\t\t<p class="bodyContent"></p>\n\t</div>\n</div>'),j=a(l).find(".bodyContentTextArea"),i=a(l).find(".bodyContent"),a(j).text(k.bodyContent[0]),a(i).text(k.bodyContent[0]),a(b).append(l),a(l).find(".editArea").hide(),m.eventFocus=function(){return l.addClass("selected")},m.eventUnfocus=function(){return l.removeClass("selected")},m.eventUpdate=function(a,b){if(a===f)return e.updateItems([{id:f,bodyContent:b}])},m.eventDelete=function(a){if(a===f)return e.removeItems([f])},m.update=function(b){a(l).find(".bodyContent").text(b.bodyContent[0]);return a(l).find(".bodyContentTextArea").text(b.bodyContent[0])},m.remove=function(){return a(l).remove()},h=d.controller.annoActive.bind(l,{model:e,itemId:f}),h.events.onClick.addListener(d.setActiveAnnotation),h.events.onDelete.addListener(m.eventDelete),h.events.onUpdate.addListener(m.eventUpdate),g!=null&&g(m);return m}}]))}});return c.namespace("RaphaelCanvas",function(c){return c.initInstance=function(){var c,f;c=1<=arguments.length?b.call(arguments,0):[];return(f=d.Presentation).initInstance.apply(f,["OAC.StreamingVideo.Client.Presentation.RaphaelCanvas"].concat(b.call(c),[function(b,c){var f,g,h,i,j,k,l,m,n,o,p,q;j=a(c).attr("id"),m=b.options,f=m.application,i=m.controllers.canvas,k=m.controllers.keyboard,b.canvas=new Raphael(a(c),10,10),a(b.canvas.canvas).css({"pointer-events":"none"}),h=i.bind(a(c),{closeEnough:5,paper:b.canvas}),g=e.Client.StreamingVideo.Component.ShapeEditBox.initInstance(b.canvas),o=e.Client.StreamingVideo.Component.ShapeCreateBox.initInstance(b.canvas),l=k.bind(a(c),{}),b.events=a.extend(!0,b.events,l.events),g.events.onResize.addListener(function(a){var c;c=b.getFocusedRendering();if(c!=null&&c.eventResize!=null)return c.eventResize(a)}),g.events.onMove.addListener(function(a){var c;c=b.getFocusedRendering();if(c!=null&&c.eventMove!=null)return c.eventMove(a)}),g.events.onDelete.addListener(function(){var a;a=b.getFocusedRendering();if(a!=null&&a.eventDelete!=null){a.eventDelete();return g.detachFromRendering()}}),f.events.onCurrentModeChange.addListener(function(a){if(a!=="Select"&&a!=="Drag")return g.detachFromRendering()}),n=f.getPlayer(),q=function(){var c,d,e,f,g,h;if(n!=null){g=n.getCoordinates(),e=g[0],f=g[1],h=n.getSize(),d=h[0],c=h[1],a(b.canvas.canvas).css({left:e+"px",top:f+"px"});return b.canvas.setSize(d,c)}},d.events.onWindowResize.addListener(q),n!=null&&n.events.onResize.addListener(q),q(),h.events.onShapeStart.addListener(o.createGuide),h.events.onShapeDrag.addListener(o.resizeGuide),h.events.onShapeDone.addListener(function(a){var b;b=o.completeShape(a);if(b.height>1&&b.width>1)return f.insertShape(b)}),f.events.onCurrentTimeChange.addListener(function(a){return b.visitRenderings(function(b,c){if(c.eventCurrentTimeChange!=null)return c.eventCurrentTimeChange(a)})}),f.events.onTimeEasementChange.addListener(function(a){return b.visitRenderings(function(b,c){if(c.eventTimeEasementChange!=null)return c.eventTimeEasementChange(a)})}),p=b.eventFocusChange;return b.eventFocusChange=function(a){if(f.getCurrentMode()==="Select"){p(a),g.attachToRendering(b.getFocusedRendering());return h.toBack()}}}]))}})}),f=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},k=function(){return f()+f()+"-"+f()+"-"+f()+"-"+f()+"-"+f()+f()+f()},g=1;return e.Client.StreamingVideo.namespace("Application",function(e){return e.initInstance=function(){var e,f,h,i,j,l,m,n,o,p,q,r;f=1<=arguments.length?b.call(arguments,0):[],e={},o=0,m="OAC-Client-StreamingVideo-SVG-Canvas-"+g,q=[],p=[],r=d.normalizeArgs.apply(d,["OAC.Client.StreamingVideo.Application"].concat(b.call(f))),l=r[0],i=r[1],n=r[2],h=r[3],g+=1,i==null&&(i=a("<div id='"+m+"-container'></div>"),a("body").append(i)),j=a.extend(!0,{},{viewSetup:'<div id="'+m+'" class="section-canvas"></div>',controllers:{keyboard:{isActive:function(){return e.getCurrentMode()!=="Editing"}},selectShape:{isSelectable:function(){return e.getCurrentMode()==="Select"}}},presentations:{raphsvg:{container:"#"+m,lenses:{},lensKey:[".shapeType"]}}},n);return d.Application.initInstance(l,i,j,h,function(b){var d,f,g,h,i,j;e=b,i={},n=e.options,g=n.player,n.url=n.url||g.getTargetURI(),h={},g!=null&&(j=g.getSize(),h.width=j[0],h.height=j[1],g.events.onResize.addListener(function(a){return h.width=a[0],h.height=a[1],a})),e.getPlayer=function(){return g},e.initShapeLens=function(a,b,c,d,f){var g,i,j,k,l,m,n,o,p;p={id:d},m=c.getItem(d),k=!1,o=m.npt_start[0],i=m.npt_end[0],l=o-e.getTimeEasement(),j=i+e.getTimeEasement(),g=function(a){var b,c;c=0,a>=l&&a<j&&(b=e.getTimeEasement(),b>0?a<o?c=(b-o+a)/b:a>i?c=(b+i-a)/b:c=1:c=1);return c},p.scalePoint=function(a,b,c,d){c!=null&&c[0]!=null?c=c[0]:c=h.width,d!=null&&d[0]!=null?d=d[0]:d=h.height;return c===0||d===0?[a,b]:[a*h.width/c,b*h.height/d]},p.eventTimeEasementChange=function(a){l=o-a,j=i+a;return p.setOpacity(g(e.getCurrentTime()))},p.eventCurrentTimeChange=function(a){return p.setOpacity(g(a))},n=0,p.setOpacity=function(a){a!=null&&(n=a);if(p.shape!=null)return p.shape.attr({opacity:(k?.5:.25)*n})},p.getOpacity=function(){return n},p.setOpacity(g(e.getCurrentTime())),p.eventFocus=function(){k=!0,p.setOpacity(),p.shape.toFront();return b.events.onDelete.addListener(p.eventDelete)},p.eventUnfocus=function(){k=!1,p.setOpacity(),p.shape.toBack();return b.events.onDelete.removeListener(p.eventDelete)},p.eventDelete=function(){return c.removeItems([d])},p.eventResize=function(a){return c.updateItems([{id:d,x:a.x,y:a.y,w:a.width,h:a.height,targetWidth:h.width,targetHeight:h.height}])},p.eventMove=function(a){return c.updateItems([{id:d,x:a.x,y:a.y}])},p.update=function(a){if(a.npt_start[0]!==o||a.npt_end[0]!==i){o=a.npt_start[0],i=a.npt_end[0],l=o-e.getTimeEasement(),j=i+e.getTimeEasement();return p.setOpacity(g(e.getCurrentTime()))}},p.remove=function(a){return p.shape.remove()},f!=null&&f(p);return p},e.addShapeType=function(a,b){i[a]=b;return e.presentation.raphsvg.addLens(a,b.lens)},e.insertShape=function(b){var c,d,f,g,j,l;f=parseFloat(e.getCurrentTime())-5,d=parseFloat(e.getCurrentTime())+5,c=e.getCurrentMode();if(i[c]!=null){g=i[c].calc(b),o=k(),j={id:"_:anno"+o,type:"Annotation",bodyType:"Text",bodyContent:"This is an annotation for "+c,shapeType:c,targetURI:e.options.url,targetHeight:h.height,targetWidth:h.width,npt_start:f<0?0:f,npt_end:d},e.dataStore.canvas.loadItems([l=a.extend(!0,j,g)]);return j.id}},d={OA:"http://www.w3.org/ns/openannotation/core",OAX:"http://www.w3.org/ns/openannotation/extensions",RDF:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",CNT:"http://www.w3.org/2008/content#",DC:"http://purl.org/dc/elements/1.1/",EXIF:"http://www.w3.org/2003/12/exif/ns#"},f=function(a){var b,c,d,e,f;a.indexOf(":")===-1?(f=parseFloat(a),e=0,d=0):(c=function(){var c,d,e,f;e=a.split(":"),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(parseFloat(b));return f}(),f=c.pop(),c.length>0?e=c.pop():e=0,c.length>0?d=c.pop():d=0);return(d*60+e)*60+f},e.importData=function(b){var g,h,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O;y=[];for(o in b){q=b[o];if(I=""+d.OA+"Annotation",c.call(function(){var a,b,c,e;c=q[""+d.RDF+"type"],e=[];for(a=0,b=c.length;a<b;a++)w=c[a],e.push(w.value);return e}(),I)>=0){x={id:o,type:"Annotation",bodyContent:"",bodyType:"Text",targetURI:e.options.url},q[""+d.OA+"hasBody"]!=null&&q[""+d.OA+"hasBody"][0]!=null&&b[q[""+d.OA+"hasBody"][0].value]!=null&&(x.bodyContent=b[q[""+d.OA+"hasBody"][0].value][""+d.CNT+"chars"][0].value);if(q[""+d.OA+"hasTarget"]!=null){J=function(){var a,b,c,e;c=q[""+d.OA+"hasTarget"],e=[];for(a=0,b=c.length;a<b;a++)A=c[a],e.push(A.value);return e}();for(B=0,E=J.length;B<E;B++){n=J[B];if(b[n]!=null&&b[n][""+d.OA+"hasSource"]!=null){r=(K=e.options.url,c.call(function(){var a,c,e,f;e=b[n][""+d.OA+"hasSource"],f=[];for(a=0,c=e.length;a<c;a++)t=e[a],f.push(t.value);return f}(),K)>=0);if(r){L=function(){var a,c,e,f;e=b[n][""+d.OA+"hasSelector"],f=[];for(a=0,c=e.length;a<c;a++)A=e[a],f.push(A.value);return f}();for(C=0,F=L.length;C<F;C++){l=L[C],r=(M=""+d.OAX+"CompositeSelector",c.call(function(){var a,c,e,f;e=b[l][""+d.RDF+"type"],f=[];for(a=0,c=e.length;a<c;a++)w=e[a],f.push(w.value);return f}(),M)>=0);if(b[l]!=null&&r){N=function(){var a,c,e,f;e=b[l][""+d.OA+"hasSelector"],f=[];for(a=0,c=e.length;a<c;a++)A=e[a],f.push(A.value);return f}();for(D=0,G=N.length;D<G;D++){m=N[D];if(b[m]!=null){z=function(){var a,c,e,f;e=b[m][""+d.RDF+"type"],f=[];for(a=0,c=e.length;a<c;a++)w=e[a],f.push(w.value);return f}();if(O=""+d.OAX+"SvgSelector",c.call(z,O)>=0)if(b[m][""+d.CNT+"chars"]!=null&&b[m][""+d.CNT+"chars"][0]!=null){v=b[m][""+d.CNT+"chars"][0].value,j=a.parseXML(v);if(j!=null){h=j.documentElement,s=h.nodeName;for(w in i)p=i[w],p.extractFromSVG!=null&&c.call(p.rootSVGElement,s)>=0&&(u=p.extractFromSVG(h),u!=null&&(a.extend(x,u),x.shapeType=w,b[m][""+d.EXIF+"width"]!=null&&b[m][""+d.EXIF+"width"][0]!=null&&(x.targetWidth=parseFloat(b[m][""+d.EXIF+"width"][0].value)),b[m][""+d.EXIF+"height"]!=null&&b[m][""+d.EXIF+"height"][0]!=null&&(x.targetHeight=parseFloat(b[m][""+d.EXIF+"height"][0].value))))}}(H=""+d.OA+"FragSelector",c.call(z,H)>=0)&&b[m][""+d.RDF+"value"]!=null&&b[m][""+d.RDF+"value"][0]!=null&&(k=b[m][""+d.RDF+"value"][0].value,k=k.replace(/^t=npt:/,""),g=k.split(","),x.npt_start=f(g[0]),x.npt_end=f(g[1]))}}}}}}}}else x={id:o,type:"Annotation",bodyContent:"",bodyType:"Text",targetURI:e.options.url,shapeType:"",npt_start:0,npt_end:0};(x.npt_start!=null||x.npt_end!=null||x.shapeType!=null)&&y.push(x)}}return e.dataStore.canvas.loadItems(y)},e.exportData=function(a){var b,c,f,g,j,l,m,n,o,p,q,r,s,t;p={},f=e.dataStore.canvas.prepare(["!type"]),n=function(a,b,c,d,e){p[a]==null&&(p[a]={}),p[a][b+c]==null&&(p[a][b+c]=[]);return p[a][b+c].push({type:d,value:e})},b=function(a,b,c,d){return n(a,b,c,"bnode",d)},q=function(a,b,c,d){return n(a,b,c,"uri",d)},l=function(a,b,c,d){return n(a,b,c,"literal",d)},g=function(a,b){q(b,d.RDF,"type",""+d.OA+"Body"),l(b,d.DC,"format","text/plain"),l(b,d.CNT,"characterEncoding","utf-8");return l(b,d.CNT,"chars",a.bodyContent[0])},j=function(a,c){var f,g;q(c[0],d.RDF,"type",""+d.OA+"SpecificResource"),q(c[0],d.OA,"hasSource",a.targetURI[0]),b(c[0],d.OA,"hasSelector",c[1]),q(c[1],d.RDF,"type",""+d.OAX+"CompositeSelector"),b(c[1],d.OA,"hasSelector",c[2]),b(c[1],d.OA,"hasSelector",c[3]),a.shapeType!=null&&(f=(g=i[a.shapeType[0]])!=null?g.renderAsSVG:void 0),f!=null&&(q(c[2],d.RDF,"type",""+d.OAX+"SvgSelector"),l(c[2],d.DC,"format","text/svg+xml"),l(c[2],d.CNT,"characterEncoding","utf-8"),l(c[2],d.CNT,"chars",f(e.dataStore.canvas,a.id[0])),a.targetHeight!=null&&a.targetHeight[0]!=null?l(c[2],d.EXIF,"height",a.targetHeight[0]):l(c[2],d.EXIF,"height",h.height),a.targetWidth!=null&&a.targetWidth[0]!=null?l(c[2],d.EXIF,"width",a.targetWidth[0]):l(c[2],d.EXIF,"width",h.width)),q(c[3],d.RDF,"type",""+d.OA+"FragSelector");return l(c[3],d.RDF,"value","t=npt:"+a.npt_start[0]+","+a.npt_end[0])},c=function(a){var c,f,h,i,l,m;h=e.dataStore.canvas.getItem(a[0]),a.length>1?(c=a[1],m=a[2],i=a[3],l=a[4],f=a[5]):(c="_:b"+k(),m="_:t"+k(),i="_:sel"+k(),l="_:sel"+k(),f="_:sel"+k()),q(a[0],d.RDF,"type",""+d.OA+"Annotation"),b(a[0],d.OA,"hasBody",c),b(a[0],d.OA,"hasTarget",m),g(h,c);return j(h,[m,i,l,f])},m=function(b){var f,g,h,i,k,l,m,n,o,p,q,r,s,t;h=e.dataStore.canvas.getItem(b);if(a[h.id]!=null){r=a[h.id],t=[];for(p in r){q=r[p];switch(p){case""+d.OA+"hasBody":f=a[h.id].hasBody[0].value,t.push(a[f].chars[0].value=h.bodyContent);break;case""+d.OA+"hasTarget":if(h.targetURI[0]!=null&&h.x[0]!=null){o=a[h.id].hasTarget[0].value,g=!1;if(a[o].hasSource[0].value===h.targetURI[0]){n=a[o].hasSelector[0].value,g=!0,s=a[n];for(l in s){m=s[l];if(l==="hasSelector")for(i in m)k=m[i],a[k.value].type[0].value===OAC_NS.SVGConstraint?a[k.value].chars=[{type:"literal",value:"<"+h.shapeType[0].substring(0,4).toLowerCase()+' x="'+h.x[0]+'" y="'+h.y[0]+' width="'+h.w[0]+'" height="'+h.h[0]+'" />'}]:a[k.value].type[0].value===OAC_NS.FragSelector&&(a[m].chars=[{type:"literal",value:"t=npt:"+h.npt_start[0]+","+h.npt_end[0]}])}}g?t.push(void 0):t.push(j(h))}else t.push(void 0)}}return t}return c(h.id)},a=a||{},t=f.evaluate("Annotation");for(r=0,s=t.length;r<s;r++)o=t[r],m(o);return p},e.ready(function(){e.events.onActiveAnnotationChange.addListener(e.presentation.raphsvg.eventFocusChange),e.events.onCurrentTimeChange.addListener(function(a){e.dataView.currentAnnotations.setKeyRange(a-5,a+5),g.setPlayhead(a);return e.setCurrentMode("Watch")}),e.setCurrentTime(g.getPlayhead()),g.events.onPlayheadUpdate.addListener(e.setCurrentTime);return e.events.onCurrentModeChange.addListener(function(a){if(a!=="Watch")return g.pause();if(a==="Watch")return g.play()})});return e.ready(function(){var b;e.addShapeType("Rectangle",{calc:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2,w:a.width,h:a.height}},renderAsSVG:function(a,b){var c;c=a.getItem(b);return"<rect x='"+c.x[0]+"' y='"+c.y[0]+"' width='"+c.w[0]+"' height='"+c.h[0]+"' />"},rootSVGElement:["rect"],extractFromSVG:function(a){var b;b={},b.w=parseFloat(a.getAttribute("width")),b.h=parseFloat(a.getAttribute("height")),b.x=parseFloat(a.getAttribute("x")),b.y=parseFloat(a.getAttribute("y"));return b},lens:function(b,c,d,f){return e.initShapeLens(b,c,d,f,function(b){var g,h,i,j,k,l,m,n,o,p;i=d.getItem(f),o=b.scalePoint(i.x[0]-i.w[0]/2,i.y[0]-i.h[0]/2,i.targetWidth,i.targetHeight),m=o[0],n=o[1],p=b.scalePoint(i.w[0],i.h[0],i.targetWidth,i.targetHeight),l=p[0],h=p[1],g=c.canvas.rect(m,n,l,h),b.shape=g,g.attr({fill:"silver",border:"grey"}),b.setOpacity(),a(g.node).css({"pointer-events":"auto"}),j=e.controller.selectShape.bind(g),j.events.onSelect.addListener(function(){return e.setActiveAnnotation(f)}),k=b.update,b.update=function(a){var c,d;i=a,k(i);if(i.x!=null&&i.y!=null&&i.w!=null&&i.h!=null){c=b.scalePoint(i.x[0],i.y[0],i.targetWidth,i.targetHeight),m=c[0],n=c[1],d=b.scalePoint(i.w[0],i.h[0],i.targetWidth,i.targetHeight),l=d[0],h=d[1];return g.attr({x:m-l/2,y:n-h/2,width:l,height:h})}};return b.getExtents=function(){return{x:g.attr("x")+g.attr("width")/2,y:g.attr("y")+g.attr("height")/2,width:g.attr("width"),height:g.attr("height")}}})}}),e.addShapeType
("Ellipse",{calc:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2,w:a.width,h:a.height}},renderAsSVG:function(a,b){var c;c=a.getItem(b);return"<elli x='"+c.x[0]+"' y='"+c.y[0]+"' width='"+c.w[0]+"' height='"+c.h[0]+"' />"},rootSVGElement:["elli"],extractFromSVG:function(a){var b;b={},b.w=parseFloat(a.getAttribute("width")),b.h=parseFloat(a.getAttribute("height")),b.x=parseFloat(a.getAttribute("x")),b.y=parseFloat(a.getAttribute("y"));return b},lens:function(b,c,d,f){return e.initShapeLens(b,c,d,f,function(b){var g,h,i,j,k,l,m,n,o,p;i=d.getItem(f),o=b.scalePoint(i.x[0],i.y[0],i.targetWidth,i.targetHeight),m=o[0],n=o[1],p=b.scalePoint(i.w[0]/2,i.h[0]/2,i.targetWidth,i.targetHeight),l=p[0],h=p[1],g=c.canvas.ellipse(m,n,l,h),b.shape=g,g.attr({fill:"silver",border:"grey"}),b.setOpacity(),a(g.node).css({"pointer-events":"auto"}),j=e.controller.selectShape.bind(g),j.events.onSelect.addListener(function(){return e.setActiveAnnotation(f)}),k=b.update,b.update=function(a){var c,d;k(a);if(a.x!=null&&a.y!=null){c=b.scalePoint(a.x[0],a.y[0],a.targetWidth,a.targetHeight),m=c[0],n=c[1],d=b.scalePoint(a.w[0],a.h[0],a.targetWidth,a.targetHeight),l=d[0],h=d[1];return g.attr({cx:m,cy:n,rx:l/2,ry:h/2})}};return b.getExtents=function(){return{x:g.attr("cx"),y:g.attr("cy"),width:g.attr("rx")*2,height:g.attr("ry")*2}}})}}),e.setCurrentTime(0),b=e.controller.timecontrol.bind(".timeselect",{});return b.events.onUpdate.addListener(function(a,b,c){return e.dataStore.canvas.updateItems([{id:a,npt_start:b,npt_end:c}])})})})}})}(jQuery,MITHGrid,a),MITHGrid.defaults("OAC.Client.StreamingVideo.Player.DriverBinding",{events:{onResize:null,onPlayheadUpdate:null}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Component.ShapeEditBox",{dirs:["ul","top","ur","lft","lr","btm","ll","rgt","mid"],events:{onResize:null,onMove:null,onEdit:null,onDelete:null,onCurrentModeChange:null}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.CanvasClickController",{bind:{events:{onClick:null,onShapeStart:null,onShapeDrag:null,onShapeDone:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.TextBodyEditor",{bind:{events:{onClick:null,onDelete:null,onUpdate:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.KeyboardListener",{bind:{events:{onDelete:["preventable","unicast"]}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Component.ModeButton",{bind:{events:{onCurrentModeChange:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.ShapeCreateBox",{bind:{events:{}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.Drag",{bind:{events:{onFocus:null,onUnfocus:null,onUpdate:null}},selectors:{"":""}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.Select",{bind:{events:{onSelect:null}},selectors:{"":""},isSelectable:function(){return!0}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.timeControl",{bind:{events:{onUpdate:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Application",{controllers:{keyboard:{type:a.Client.StreamingVideo.Controller.KeyboardListener,selectors:{doc:""}},canvas:{type:a.Client.StreamingVideo.Controller.CanvasClickController,selectors:{svgwrapper:""}},annoActive:{type:a.Client.StreamingVideo.Controller.TextBodyEditor,selectors:{annotation:"",annotationlist:":parent",bodycontent:".bodyContent",body:".body",editbutton:".button.edit",editarea:".editArea",textarea:".editArea > textarea",updatebutton:".button.update",deletebutton:".button.delete"}},timecontrol:{type:a.Client.StreamingVideo.Controller.timeControl,selectors:{timestart:"#timestart",timeend:"#timeend",submit:"#submittime",menudiv:""}},selectShape:{type:a.Client.StreamingVideo.Controller.Select,selectors:{raphael:""}}},variables:{ActiveAnnotation:{is:"rw"},CurrentTime:{is:"rw","default":0},TimeEasement:{is:"rw","default":5},CurrentMode:{is:"rw"}},dataViews:{currentAnnotations:{dataStore:"canvas",type:MITHGrid.Data.RangePager,leftExpressions:[".npt_start"],rightExpressions:[".npt_end"]}},dataStores:{canvas:{types:{Annotation:{}},properties:{shapeType:{valueType:"text"},bodyType:{valueType:"text"},bodyContent:{valueType:"text"},targetURI:{valueType:"uri"},npt_start:{valueType:"numeric"},npt_end:{valueType:"numeric"}}}},presentations:{raphsvg:{type:a.Client.StreamingVideo.Presentation.RaphaelCanvas,dataView:"currentAnnotations",controllers:{keyboard:"keyboard",canvas:"canvas"},events:{onOpacityChange:null},fadeStart:5}}})}).call(this);