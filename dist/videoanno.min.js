<<<<<<< HEAD
/*
 *  OAC Video Annotation Tool v0.1
 * 
 *  Developed as a plugin for the MITHGrid framework. 
 *  
 *  Date: Sun Mar 18 08:55:41 2012 -0400
 *  
 * Educational Community License, Version 2.0
 * 
 * Copyright 2011 University of Maryland. Licensed under the Educational
 * Community License, Version 2.0 (the "License"); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License at
 * 
 * http://www.osedu.org/licenses/ECL-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 * 
 */
var MITHGrid=MITHGrid||{},jQuery=jQuery||{},Raphael=Raphael||{},OAC=OAC||{},app={};MITHGrid.globalNamespace("OAC"),OAC.namespace("Client"),OAC.Client.namespace("StreamingVideo"),function(a,b,c){var d=c.Client.StreamingVideo.namespace("Controller");d.namespace("KeyboardListener"),d.KeyboardListener.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.KeyboardListener",c);c=d.options,d.applyBindings=function(b,d){var e=b.locate("doc"),f,g=function(a){f=a};c.application.events.onActiveAnnotationChange.addListener(g),a(e).keydown(function(a){c.application.getCurrentMode()!=="Editing"&&(f!==undefined||f!=="")&&(a.keyCode===8||a.keyCode===46)&&(b.events.onDelete.fire(f),f="")})};return d},d.namespace("AnnotationEditSelectionGrid"),d.AnnotationEditSelectionGrid.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid",c),e=[];c=d.options,e=d.options.dirs||["ul","top","ur","lft","lr","btm","ll","rgt","mid"],d.applyBindings=function(b,f){var g,h,i={},j={},k={},l={},m={},n,o={},p={},q={},r={},s,t=f.paper,u={},v=5,w,x,y,z,A={},B,C={},D={},E={},F,G={},H={},I={},J;b.events.onResize.addListener(function(a,b){n!==undefined&&n.eventResize!==undefined&&n.eventResize(a,b)}),b.events.onMove.addListener(function(a,b){n!==undefined&&n.eventMove!==undefined&&n.eventMove(a,b)}),b.events.onDelete.addListener(function(a){n!==undefined&&n.eventDelete!==undefined&&(n.eventDelete(a),b.detachRendering())}),c.application.events.onCurrentModeChange.addListener(function(a){a!=="Select"&&a!=="Drag"&&b.detachRendering()}),b.attachRendering=function(a){b.detachRendering();a!==undefined&&(n=a,w(),B())},b.detachRendering=function(){a.isEmptyObject(i)||(n=undefined,i.hide(),k.hide(),j.hide(),l&&l.hide())},w=function(){s=n.getExtents(),u.width=s.width+2*v,u.height=s.height+2*v,u.x=s.x-v/8-u.width/2,u.y=s.y-v/8-u.height/2,x(u),l&&y(u)},B=function(){a.isEmptyObject(i)?(i=t.set(),a.each(m,function(a,b){var c;a==="mid"?(j=t.rect(b.x,b.y,v,v),b.id=j.id):(c=t.rect(b.x,b.y,v,v),b.id=c.id,c.attr({cursor:b.cursor}),i.push(c))}),i.attr({fill:99e4,stroke:"black"}),a.isEmptyObject(j)||j.attr({fill:99e4,stroke:"black",cursor:"move"}),k=t.rect(u.x,u.y,u.width,u.height),k.attr({stroke:"green","stroke-dasharray":["--"]}),y(u),a.isEmptyObject(j)||j.drag(function(a,b){C.nx=u.x+a,C.ny=u.y+b,D.x=s.x+a,D.y=s.y+b,k.attr({x:C.nx,y:C.ny}),x({x:C.nx,y:C.ny,width:u.width,height:u.height}),l&&y({x:C.nx,y:C.ny,width:u.width,height:u.height})},function(a,b,c){g=c.layerX,h=c.layerY,w(),n.shape.attr({cursor:"move"})},function(){var a={x:D.x,y:D.y};b.events.onMove.fire(n.id,a),n.shape.attr({cursor:"default"})}),i.drag(function(a,b){D.w=Math.abs(s.width+a*r.x),D.h=Math.abs(s.height+b*r.y),C.nw=D.w+v*2,C.nh=D.h+v*2,C.nx=s.x-v/4-C.nw/2,C.ny=s.y-v/4-C.nh/2,k.attr({x:C.nx,y:C.ny,width:C.nw,height:C.nh}),x({x:C.nx,y:C.ny,width:C.nw,height:C.nh}),l&&y({x:C.nx,y:C.ny,width:C.nw,height:C.nh})},function(a,b,d){var e,f;s=n.getExtents(),g=d.layerX,h=d.layerY,c.application.setCurrentMode("Drag"),e=8*(g-s.x)/s.width+4,f=8*(h-s.y)/s.height+4,e<3?r.x=-2:e<5?r.x=0:r.x=2,f<3?r.y=-2:f<5?r.y=0:r.y=2,w()},function(){var a={width:D.w,height:D.h};n!==undefined&&b.events.onResize.fire(n.id,a),c.application.setCurrentMode("Select")})):(k.show(),k.attr({x:u.x,y:u.y,width:u.width,height:u.height}),i.show(),j.show().toFront(),l&&(l.show(),y(u)))},y=function(b){a.isEmptyObject(l)?(E.x=b.x+b.width,E.y=b.y-v*4-2,E.w=100,E.h=20,H={x:E.x+2,y:E.y+2,w:E.w/2-4,h:E.h-E.h/8},G={x:H.x+H.w+2,y:E.y+2,w:E.w/2-4,h:E.h-E.h/8},l=t.set(),q=t.rect(E.x,E.y,E.w,E.h),q.attr({fill:"#FFFFFF",stroke:"#000"}),l.push(q),p=t.rect(H.x,H.y,H.w,H.h),p.attr({fill:334009,cursor:"pointer"}),l.push(p),o=t.rect(G.x,G.y,G.w,G.h),o.attr({fill:334009,cursor:"pointer"}),l.push(o),p.mousedown(function(){n!==undefined&&d.events.onEdit.fire(n.id)}),p.hover(function(){p.attr({fill:443009})},function(){p.attr({fill:334009})}),o.mousedown(function(){n!==undefined&&(d.events.onDelete.fire(n.id),z())}),o.hover(function(){o.attr({fill:443009})},function(){o.attr({fill:334009})})):(E.x=b.x+b.width,E.y=b.y-v*4-2,H={x:E.x+2,y:E.y+2},G={x:H.x+p.attr("width")+2,y:E.y+2},q.attr({x:E.x,y:E.y}),p.attr(H),o.attr(G))},z=function(){b.detachRendering(),n=undefined,l.hide(),k.hide(),i.hide(),j.hide()},I={ul:["nw",0,0,0,0],top:["n",1,0,0,0],ur:["ne",2,-1,0,0],rgt:["e",2,-1,1,0],lr:["se",2,-1,2,-1],btm:["s",1,0,2,-1],ll:["sw",0,0,2,-1],lft:["w",0,0,1,0],mid:["pointer",1,0,1,0]},x=function(b){var c=function(a,c,d,e,f){return{x:b.x+c*b.width/2+d*v,y:b.y+e*b.height/2+f*v,cursor:a.length>2?a:a+"-resize"}},d=function(a,c,d,e,f){var g;a.x=b.x+c*b.width/2+d*v,a.y=b.y+e*b.height/2+f*v,g=t.getById(a.id),g.attr({x:a.x,y:a.y})};a.each(e,function(a,b){var e=I[b];e!==undefined&&(m[b]===undefined?m[b]=c(e[0],e[1],e[2],e[3],e[4]):d(m[b],e[1],e[2],e[3],e[4]))})}};return d},d.namespace("ShapeCreateBox"),d.ShapeCreateBox.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.ShapeCreateBox",c);c=d.options,d.applyBindings=function(b,c){var d,e,f={},g,h={},i=c.paper,j={},k=10,l,m,n={},o,p;b.createGuide=function(b){j.x=b[0],j.y=b[1],j.width=b[0]+k,j.height=b[1]+k,a.isEmptyObject(f)?(f=i.rect(j.x,j.y,j.width,j.height),f.attr({stroke:"green","stroke-dasharray":["--"]})):(f.show(),f.attr({x:j.x,y:j.y,width:j.width,height:j.height}))},b.resizeGuide=function(a){j.width=a[0]-j.x,j.height=a[1]-j.y,f.attr({width:j.width,height:j.height})},b.completeShape=function(a){j.width=a.width,j.height=a.height,f.attr({width:j.width,height:j.height}),f.hide();return{x:j.x,y:j.y,width:j.width,height:j.height}}};return d},d.namespace("TextBodyEditor"),d.TextBodyEditor.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.TextBodyEditor",c);c=d.options,d.applyBindings=function(b,d){var e,f,g,h=b.locate("annotation"),i=b.locate("body"),j=b.locate("annotations"),k=b.locate("textarea"),l=b.locate("editarea"),m=b.locate("editbutton"),n=b.locate("updatebutton"),o=b.locate("deletebutton"),p=!1,q;e=function(){a(l).show(),a(i).hide(),p=!0,b.events.onClick.fire(d.itemId)},f=function(){a(l).hide(),a(i).show(),p=!1},g=function(c){var e=a(k).val();c.preventDefault(),b.events.onUpdate.fire(d.itemId,e),f()},a(h).bind("dblclick",function(a){a.preventDefault(),p?(f(),c.application.setCurrentMode(q||"")):(e(),q=c.application.getCurrentMode(),c.application.setCurrentMode("TextEdit"))}),a(h).bind("click",function(a){c.application.setActiveAnnotation(d.itemId)}),a(n).bind("click",function(e){b.events.onUpdate.fire(d.itemId,a(k).val()),f(),c.application.setCurrentMode(q)}),a(o).bind("click",function(c){b.events.onDelete.fire(d.itemId),a(h).remove()}),c.application.events.onActiveAnnotationChange.addListener(function(a){a!==d.id&&p&&(g({preventDefault:function(){}}),f())}),c.application.events.onCurrentModeChange.addListener(function(a){a!=="TextEdit"&&f()})};return d},d.namespace("CanvasClickController"),d.CanvasClickController.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.CanvasClickController",c);c=d.options,d.applyBindings=function(b,d){var e,f,g,h,i=d.closeEnough,j,k,l,m,n,o,p,q={},r=d.paper,s,t=function(a){var c;if(p===undefined||a!==p.id){c=q[a];if(c===undefined){b.events.onClick.fire(undefined),p=undefined;return!1}p=c}},u=function(a){if(p===undefined||a!==p.id)var b=q[a]},v=function(c,d){var e=0,f=[],g=[],h,i,j,k,l=a(c).offset();a(c).unbind(),a(d).mousedown(function(a){e<=0&&(h=a.pageX-l.left,i=a.pageY-l.top,f=[h,i],e=1,b.events.onShapeStart.fire(f))}),a(d).mousemove(function(a){e!==2&&e!==0&&(h=a.pageX-l.left,i=a.pageY-l.top,g=[h,i],b.events.onShapeDrag.fire(g))}),a(d).mouseup(function(a){e>=1&&(e=0,g===undefined&&(g=[h+5,i+5]),b.events.onShapeDone.fire({x:f[0],y:f[1],width:g[0]-f[0],height:g[1]-f[1]}))})},w=function(b){a(b).unbind(),a(b).bind("mousedown",function(a){c.application.setActiveAnnotation(undefined),h=""})};c.application.events.onActiveAnnotationChange.addListener(t),c.application.events.onCurrentModeChange.addListener(function(c){c==="Rectangle"||c==="Ellipse"?v(b.locate("svgwrapper"),b.locate("svg")):c==="Select"?w(b.locate("svg")):a(b.locate("svg")).unbind()}),b.registerRendering=function(a){q[a.id]=a,a.shape.click(function(b){c.application.getCurrentMode()==="Select"&&(h=a.id,c.application.setActiveAnnotation(a.id))})},b.removeRendering=function(a){delete q[a.id]}};return d},d.namespace("AnnotationCreationButton"),d.AnnotationCreationButton.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.AnnotationCreationButton",c);c=d.options,d.applyBindings=function(b,d){var e,f=!1,g,h;e=b.locate("button"),a(e).live("mousedown",function(b){f===!1?(f=!0,c.application.setCurrentMode(d.action),a(e).addClass("active")):f===!0&&(f=!1,c.application.setCurrentMode(""),a(e).removeClass("active"))}),g=function(b){b===c.action?(f=!0,a(e).addClass("active")):(f=!1,a(e).removeClass("active"))},c.application.events.onCurrentModeChange.addListener(g)};return d},d.namespace("sliderButton"),d.sliderButton.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.sliderButton",c);c=d.options,d.applyBindings=function(b,d){var e,f,g,h,i,j;f=b.locate("timedisplay"),j=function(b){i===undefined&&(i=b,a(e).slider("value",i))},g=function(b,d){c.application.setCurrentTime(d.value),a(f).text("TIME: "+d.value),i=d.value},h=function(b,d){d===undefined&&(i=b,a(e).slider("value",b));i!==d.value&&(c.application.setCurrentTime(d.value),a(f).text("TIME: "+d.value),i=d.value)},e=b.locate("slider"),a(e).slider({start:g,slide:h})};return d},d.namespace("timeControl"),d.timeControl.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.timeControl",c);c=d.options,d.currentId="",d.applyBindings=function(b,d){var e=b.locate("timestart"),f=b.locate("timeend"),g=b.locate("submit"),h=b.locate("menudiv"),i,j;a(h).hide(),a(g).bind("click",function(){i=parseInt(a(e).val(),10),j=parseInt(a(f).val(),10),b.currentId!==undefined&&i!==undefined&&j!==undefined&&(b.events.onUpdate.fire(b.currentId,i,j),a(h).hide())}),c.application.events.onActiveAnnotationChange.addListener(function(c){c!==undefined?(a(h).show(),a(e).val(""),a(f).val(""),b.currentId=c):c===undefined&&a(h).hide()})};return d},d.namespace("screenMove"),d.screenMove.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.screenMove",c);c=d.options,d.applyBindings=function(b,c){var d=b.locate("canvas"),e=b.locate("container"),f=b.locate("htmlCanvasWrapper"),g,h,i,j;a(window).resize(function(){setTimeout(function(){i=parseInt(a(e).offset().left,10),j=parseInt(a(e).offset().top,10),g=parseInt(a(e).width(),10),h=parseInt(a(e).height(),10),a(d).css({left:i+"px",top:j+"px",width:g+"px",height:h+"px"}),a(f).css({left:i+"px",top:j+"px",width:g+"px",height:h+"px"})},10)})};return d}}(jQuery,MITHGrid,OAC),function(a,b,c){b.Presentation.namespace("AnnotationList"),b.Presentation.AnnotationList.initPresentation=function(c,d){var e=b.Presentation.initPresentation("MITHGrid.Presentation.AnnotationList",c,d),f=function(b){var c,e,f,g,h;f=d.dataView.prepare(["!bodyType"]),c=f.evaluate("text"),a.each(c,function(a,c){e=d.application.dataStore.canvas.getItem(c),g=parseInt(e.ntp_start,10),h=parseInt(e.ntp_end,10),b>=g&&b<=h&&d.application.dataStore.canvas.updateItems([{id:e.id}])})};return e},b.Presentation.namespace("RaphaelCanvas"),b.Presentation.RaphaelCanvas.initPresentation=function(c,d){var e=b.Presentation.initPresentation("MITHGrid.Presentation.RaphaelCanvas",c,d),f=a(c).attr("id"),g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;d=e.options,k=d.controllers.canvas,l=d.controllers.keyboard,m=d.controllers.shapeEditBox,q=d.controllers.shapeCreateBox,s=d.controllers.screenmove,i=d.application.cX||a(c).css("x"),j=d.application.cY||a(c).css("y"),d.application.cWidth!==undefined?h=d.application.cWidth:h=a(c).width(),d.application.cHeight!==undefined?g=d.application.cHeight:g=a(c).height(),e.events=e.events||{},e.events.onOpacityChange=b.initEventFirer(!1,!1),p=l.bind(a("body"),{}),a.extend(!0,e.events,p.events),e.canvas=new Raphael(a(c),h,g),o=k.bind(a("body"),{closeEnough:5,paper:e.canvas}),x=m.bind(a(c),{paper:e.canvas}),r=q.bind(a(c),{paper:e.canvas}),t=s.bind(a("body"),{}),o.events.onShapeStart.addListener(function(a){r.createGuide(a)}),o.events.onShapeDrag.addListener(function(a){r.resizeGuide(a)}),o.events.onShapeDone.addListener(function(a){var b=r.completeShape(a);d.application.insertShape(b)}),u=function(b){b!==undefined&&(D=b.getcoordinates(),E=b.getsize(),a(c).css({left:parseInt(D[0],10)+"px",top:parseInt(D[1],10)+"px",width:E[0],height:E[1]}),a("svg").css({left:parseInt(D[0],10)+"px",top:parseInt(D[1],10)+"px",width:E[0],height:E[1]}),a(".section-controls").css({left:parseInt(D[0],10)+E[0]+10+"px",top:parseInt(D[1],10)+"px"}),a(".section-annotations").css({left:parseInt(D[0],10)+E[0]+E[0]+"px",top:parseInt(D[1],10)+"px"}))},y=function(b){var c,e,f,g,h,i=function(a,b,c,d,e){var f=0;a<d&&a>=b?(f=1/(d-a),f=f.toFixed(1)):a>e&&a<=c?(f=1/(a-e),f=f.toFixed(1)):a>=b&&a<=c&&a>=d&&a<=e&&(f=1);return f};z=d.dataView.prepare(["!type"]),c=z.evaluate("Annotation"),a.each(c,function(a,c){e=A.getItem(c),f=parseInt(e.ntp_start,10)-d.fadeStart,g=parseInt(e.ntp_end,10)+d.fadeStart,h=i(b,f,g,parseInt(e.ntp_start,10),parseInt(e.ntp_end,10)),d.application.dataStore.canvas.updateItems([{id:e.id,x:e.x,y:e.y,w:e.w,h:e.h,opacity:h}])})},n=e.render,d.application.events.onCurrentTimeChange.addListener(y),d.application.events.onPlayerChange.addListener(u),d.application.dataStore.canvas.events.onModelChange.addListener(function(){x.detachRendering()}),e.render=function(a,b,c){var e=n(a,b,c),f;if(e!==undefined){f=b;while(f.dataStore)f=f.dataStore;A=f,z=d.dataView.prepare(["!type"]),o.registerRendering(e)}return e},e.renderItems=function(){},w=e.eventFocusChange,e.eventFocusChange=function(a){d.application.getCurrentMode()==="Select"&&(w(a),x.attachRendering(e.renderingFor(a)))};return e}}(jQuery,MITHGrid,OAC),function(a,b,c){var d=1;c.Client.StreamingVideo.initApp=function(c,e){var f,g,h,i,j,k,l="OAC-Client-StreamingVideo-SVG-Canvas-"+d,m=[],n=[],o,p,q,r=[],s,t=0,u={annotation:"http://www.openannotation.org/ns/Annotation",textanno:"http://dms.stanford.edu/ns/TextAnnotation"};d+=1,h=b.Application.initApp("OAC.Client.StreamingVideo",c,a.extend(!0,{},{viewSetup:'<div id="'+l+'" class="section-canvas"></div>'+'<div class="mithgrid-bottomarea">'+'<div class="timeselect">'+"<p>Enter start time:</p>"+'<input id="timestart" type="text" />'+"<p>Enter end time:</p>"+'<input id="timeend" type="text" />'+'<div id="submittime" class="button">Confirm time settings</div>'+"</div>"+'<div id="sidebar'+l+'" class="section-controls"></div>'+'<div class="section-annotations">'+'<div class="header">'+"Annotations"+"</div>"+"</div>"+'<iframe src="" width="1000px" height="400px" />'+'<textarea id="rdfoutput" cols="1000" rows="800" />'+"</div>",presentations:{raphsvg:{container:"#"+l,lenses:{},lensKey:[".shapeType"]},annoItem:{container:".section-annotations",lenses:{},lensKey:[".bodyType"]}}},e)),h.cWidth=100,h.cHeight=100,h.cX=0,h.cY=0,h.shapeTypes={},h.initShapeLens=function(a,b,c,d){var e={id:d};e.eventFocus=function(){e.shape.attr({opacity:1}).toFront(),b.events.onDelete.addListener(e.eventDelete)},e.eventUnfocus=function(){e.shape.attr({opacity:.5}).toBack(),b.events.onDelete.removeListener(e.eventDelete)},e.eventDelete=function(a){a===d&&c.removeItems([d])},e.eventResize=function(a,b){a===d&&c.updateItems([{id:d,w:b.width,h:b.height}])},e.eventMove=function(a,b){a===d&&c.updateItems([{id:d,x:b.x,y:b.y}])},e.remove=function(a){e.shape.remove()};return e},h.initTextLens=function(b,c,d,e){var f={},i=d.getItem(e),j,k,l,m;j=a('<div class="anno_item"><p class="bodyContentInstructions">Double click here to open edit window.</p><div class="editArea"><textarea class="bodyContentTextArea"></textarea><div id="editUpdate" class="button update">Update</div><div id="editDelete" class="button delete">Delete</div></div><div class="body"><p class="bodyContent"></p></div></div>'),l=a(j).find(".bodyContentTextArea"),m=a(j).find(".bodyContent"),a(l).text(i.bodyContent[0]),a(m).text(i.bodyContent[0]),a(b).append(j),a(j).find(".editArea").hide(),k=g.bind(j,{model:d,itemId:e}),f.eventUpdate=function(a,b){a===e&&d.updateItems([{id:e,bodyContent:b}])},f.eventFocus=function(){j.addClass("selected")},f.eventUnfocus=function(){j.removeClass("selected")},k.events.onClick.addListener(h.setActiveAnnotation),k.events.onDelete.addListener(function(a){a===e&&h.dataStore.canvas.removeItems([e])}),k.events.onUpdate.addListener(f.eventUpdate),f.update=function(b){a(j).find(".bodyContent").text(b.bodyContent[0]),a(j).find(".bodyContentTextArea").text(b.bodyContent[0])},f.remove=function(){a(j).remove()};return f},h.buttonFeature=function(b,c,d,e){if(a("#"+d).length!==0)return!1;var f={},g,i=a(".button"),j,k=a("#sidebar"+l),m,n,o;b==="buttongrouping"?(a(k).find("#"+c).length===0&&a(k).append('<div id="'+c+'" class="buttongrouping"></div>'),j=a("#"+c),g='<div id="'+d+'" class="button">'+d+"</div>",a(j).append(g),f.element=a("#"+d),m=h.controller.buttonActive.bind(f.element,{action:d,callback:e||null})):b==="slidergrouping"&&(a(k).find("#"+c).length===0&&a(k).append('<div id="'+c+'" class="slidergrouping"></div>'),j=a("#"+c),g='<div id="'+d+'"><div class="header">'+d+"</div>"+'<div id="slider"></div><div class="timedisplay"></div></div>',a(j).append(g),f.element=a("#"+d),m=h.controller.slider.bind(f.element,{action:d}));return f},h.addShape=function(a,b){h.presentation.raphsvg.addLens(a,b)},h.addBody=function(a,b){h.presentation.annoItem.addLens(a,b)},h.addShapeType=function(a,b){var c,d,e;d=b.calc,e=b.lens,c=h.buttonFeature("Shapes",a),h.shapeTypes[a]={calc:d},h.addShape(a,e)},h.insertShape=function(b){var c,d=h.dataStore.canvas.prepare(["!type"]),e=d.evaluate("Annotation"),f=h.getCurrentTime()-5,g=h.getCurrentTime()+5,i=h.getCurrentMode(),j;j=h.shapeTypes[i].calc(b),c={id:"anno"+e.length,type:"Annotation",bodyType:"Text",bodyContent:"This is an annotation for "+i,targetURI:"videoURI",shapeType:i,opacity:1,ntp_start:parseInt(f,10),ntp_end:parseInt(g,10)},a.extend(c,j),h.dataStore.canvas.loadItems([c])},h.ingestJSON=function(b){var c;console.log(b),a.each(b,function(b,c){r.push(a.extend(!0,{},h.dataStore.canvas.getItem(c)))})},h.convertJSONtoRDF=function(){s='<?xml version="1.0" ?>\n<rdf:RDF xmlns:cnt="http://www.w3.org/2008/content#" xmlns:dc="http://purl.org/dc/elements/1.1/" \nxmlns:dcterms="http://purl.org/dc/terms/" xmlns:dms="http://dms.stanford.edu/ns/" \nxmlns:exif="http://www.w3.org/2003/12/exif/ns#" xmlns:foaf="http://xmlns.com/foaf/0.1/" \nxmlns:oac="http://www.openannotation.org/ns/" xmlns:ore="http://www.openarchives.org/ore/terms/" \nxmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">\n',a.each(r,function(a,b){console.log("i: "+a+" o: "+b),b.type[0]==="Annotation"&&(s+='<rdf:Description rdf:about="'+t+'">\n'+'\t<rdf:hasBody rdf:resource="'+window.encodeURI(window.location)+"body"+t+'">'+b.bodyContent[0]+"</rdf:hasBody>\n"+'\t<rdf:type rdf:resource="'+u.annotation+'"></rdf:type>\n',b.bodyType==="text"&&(s+='\t<rdf:type rdf:resource="'+u.textanno+'" />'),s+='\t<rdf:hasTarget rdf:resource="'+b.targetURI[0]+'" />\n'+"</rdf:Description>\n"),t+=1}),s+="</rdf:RDF>";return s},h.exportRDF=function(){var b=h.dataStore.canvas.prepare(["!bodyType"]),c;h.ingestJSON(b.evaluate("Text")),h.convertJSONtoRDF(),socket=io.connect("http://localhost:8080"),socket.on("sendrdf",function(){socket.emit("saverdf",{data:s}),a("iframe").attr("src","http://localhost:8080")})},h.ready(function(){g=h.controller.annoActive,h.events.onActiveAnnotationChange.addListener(h.presentation.raphsvg.eventFocusChange),h.events.onActiveAnnotationChange.addListener(h.presentation.annoItem.eventFocusChange),h.events.onCurrentTimeChange.addListener(function(a){h.dataView.currentAnnotations.setKeyRange(a-5,a+5)}),h.events.onPlayerChange.addListener(function(a){h.setCurrentTime(a.getPlayhead()),a.onPlayheadUpdate!==null&&a.pause!==null&&a.play!==null&&(a.onPlayheadUpdate(function(a){h.setCurrentTime(h.getCurrentTime()+1)}),h.events.onCurrentModeChange.addListener(function(b){b!=="Watch"?a.pause():b==="Watch"&&a.play()}))})}),h.ready(function(){var c,d,e,f,g,i,j,k,l,m,n,o;c=function(a){var b={};b.x=a.x+a.width/2,b.y=a.y+a.height/2,b.w=a.width,b.h=a.height;return b},m=function(b,c,d){var e={},f;f=a.extend(!0,{},b),e.x=f.x/c*100,e.y=f.y/d*100,e.w=f.w/c*100,e.h=f.h/d*100,a.extend(f,e);return f},e=function(c,d,e,f){var g=h.initShapeLens(c,d,e,f),i=e.getItem(f),j,k;j=d.canvas.rect(i.x[0]-i.w[0]/2,i.y[0]-i.h[0]/2,i.w[0],i.h[0]),j.attr({fill:"red",opacity:i.opacity}),a(j.node).attr("id",i.id[0]),g.update=function(a){try{a.x!==undefined&&a.y!==undefined&&a.w!==undefined&&a.h!==undefined&&j.attr({x:a.x[0]-a.w[0]/2,y:a.y[0]-a.h[0]/2,width:a.w[0],height:a.h[0],opacity:a.opacity})}catch(c){b.debug(c)}},d.events.onOpacityChange.addListener(function(b){a(j).attr("opacity",b)}),g.getExtents=function(){return{x:j.attr("x")+j.attr("width")/2,y:j.attr("y")+j.attr("height")/2,width:j.attr("width"),height:j.attr("height")}},g.shape=j;return g},h.addShapeType("Rectangle",{calc:c,lens:e}),d=function(a){var b={};b.x=a.x+a.width/2,b.y=a.y+a.height/2,b.w=a.width,b.h=a.height;return b},f=function(a,c,d,e){var f=h.initShapeLens(a,c,d,e),g=d.getItem(e),i;i=c.canvas.ellipse(g.x[0],g.y[0],g.w[0]/2,g.h[0]/2),i.attr({fill:"red",opacity:.5}),f.update=function(a){try{a.x!==undefined&&a.y!==undefined&&i.attr({cx:a.x[0],cy:a.y[0],rx:a.w[0]/2,ry:a.h[0]/2})}catch(c){b.debug(c)}},f.getExtents=function(){return{x:i.attr("cx"),y:i.attr("cy"),width:i.attr("rx")*2,height:i.attr("ry")*2}},f.shape=i;return f},h.addShapeType("Ellipse",{calc:d,lens:f}),h.addBody("Text",h.initTextLens),g=h.buttonFeature("buttongrouping","Shapes","Rectangle"),i=h.buttonFeature("buttongrouping","Shapes","Ellipse"),j=h.buttonFeature("buttongrouping","General","Select"),n=h.buttonFeature("buttongrouping","General","Watch"),l=h.buttonFeature("buttongrouping","General","Export"),a("#Export").mousedown(function(b){h.exportRDF(),a("#rdfoutput").html(a(s))}),h.setCurrentTime(0),o=h.controller.timecontrol.bind(".timeselect",{}),o.events.onUpdate.addListener(function(a,b,c){h.dataStore.canvas.updateItems([{id:a,ntp_start:b,ntp_end:c}])})});return h}}(jQuery,MITHGrid,OAC),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.CanvasClickController",{bind:{events:{onClick:null,onShapeStart:null,onShapeDrag:null,onShapeDone:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.TextBodyEditor",{bind:{events:{onClick:null,onDelete:null,onUpdate:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid",{bind:{events:{onResize:null,onMove:null,onEdit:null,onDelete:null,onCurrentModeChange:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.KeyboardListener",{bind:{events:{onDelete:["preventable","unicast"]}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.AnnotationCreationButton",{bind:{events:{onCurrentModeChange:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.ShapeCreateBox",{bind:{events:{}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.timeControl",{bind:{events:{onUpdate:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo",{controllers:{keyboard:{type:OAC.Client.StreamingVideo.Controller.KeyboardListener,selectors:{doc:""}},shapeEditBox:{type:OAC.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid},shapeCreateBox:{type:OAC.Client.StreamingVideo.Controller.ShapeCreateBox},canvas:{type:OAC.Client.StreamingVideo.Controller.CanvasClickController,selectors:{svg:" > svg",svgwrapper:".section-canvas"}},annoActive:{type:OAC.Client.StreamingVideo.Controller.TextBodyEditor,selectors:{annotation:"",annotationlist:":parent",bodycontent:".bodyContent",body:".body",editbutton:".button.edit",editarea:".editArea",textarea:".editArea > textarea",updatebutton:".button.update",deletebutton:".button.delete"}},buttonActive:{type:OAC.Client.StreamingVideo.Controller.AnnotationCreationButton,selectors:{button:""}},slider:{type:OAC.Client.StreamingVideo.Controller.sliderButton,selectors:{slider:"#slider",timedisplay:".timedisplay"}},timecontrol:{type:OAC.Client.StreamingVideo.Controller.timeControl,selectors:{timestart:"#timestart",timeend:"#timeend",submit:"#submittime",menudiv:""}},screenmove:{type:OAC.Client.StreamingVideo.Controller.screenMove,selectors:{canvas:"svg",container:".section-canvas",htmlCanvasWrapper:".section-canvas"}}},variables:{ActiveAnnotation:{is:"rw"},CurrentTime:{is:"rw","default":0},CurrentMode:{is:"rw"},Player:{is:"rw"}},dataViews:{drawspace:{dataStore:"canvas",types:["Annotation"]},currentAnnotations:{dataStore:"canvas",type:MITHGrid.Data.RangePager,leftExpressions:[".ntp_start"],rightExpressions:[".ntp_end"]}},dataStores:{canvas:{types:{Annotation:{}},properties:{shapeType:{valueType:"text"},bodyType:{valueType:"text"},bodyContent:{valueType:"text"},targetURI:{valueType:"uri"},opacity:{valueType:"numeric"},ntp_start:{valueType:"numeric"},ntp_end:{valueType:"numeric"}}}},presentations:{raphsvg:{type:MITHGrid.Presentation.RaphaelCanvas,dataView:"currentAnnotations",controllers:{keyboard:"keyboard",editBox:"editBox",canvas:"canvas",shapeCreateBox:"shapeCreateBox",shapeEditBox:"shapeEditBox",screenmove:"screenmove"},fadeStart:5},annoItem:{type:MITHGrid.Presentation.AnnotationList,dataView:"currentAnnotations",container:".anno_list"}}});
=======
//
// OAC Video Annotation Tool v0.1
// 
// The **OAC Video Annotation Tool** is a MITHGrid application providing annotation capabilities for streaming
// video embedded in a web page. 
//  
// Date: Fri Mar 30 14:14:45 2012 -0400
//  
// Educational Community License, Version 2.0
// 
// Copyright 2011 University of Maryland. Licensed under the Educational
// Community License, Version 2.0 (the "License"); you may not use this file
// except in compliance with the License. You may obtain a copy of the License at
// 
// http://www.osedu.org/licenses/ECL-2.0
// 
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
// WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
// License for the specific language governing permissions and limitations under
// the License.
//
// Author: Grant Dickie
// # Initialization
// We make sure certain globals are defined in case this library is loaded before MITHGrid,
// jQuery, or RaphaÃ«l.
var MITHGrid=MITHGrid||{},jQuery=jQuery||{},Raphael=Raphael||{},OAC=MITHGrid.globalNamespace("OAC");OAC.namespace("Client"),OAC.Client.namespace("StreamingVideo"),function(a,b,c){var d=c.Client.StreamingVideo.namespace("Controller");d.namespace("KeyboardListener"),d.KeyboardListener.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.KeyboardListener",c);c=d.options,d.applyBindings=function(b,d){var e=b.locate("doc"),f;c.application.events.onActiveAnnotationChange.addListener(function(a){f=a}),a(e).keydown(function(a){c.application.getCurrentMode()!=="Editing"&&(f!==undefined||f!=="")&&(a.keyCode===8||a.keyCode===46)&&(b.events.onDelete.fire(f),f="")})};return d},d.namespace("Drag"),d.Drag.initController=function(a){var c=b.Controller.initController("OAC.Client.StreamingVideo.Controller.Drag",a);c.applyBindings=function(a,b){var c=a.locate("raphael");c.drag(function(b,c){a.events.onUpdate.fire(b,c)},function(b,c,d){b=d.layerX,c=d.layerY,a.events.onFocus.fire(b,c)},function(){a.events.onUnfocus.fire()})};return c},d.namespace("Select"),d.Select.initController=function(a){var c=b.Controller.initController("OAC.Client.StreamingVideo.Controller.Select",a);a=c.options,c.applyBindings=function(b){var c=b.locate("raphael");c.click(function(c){a.isSelectable()&&b.events.onSelect.fire()})};return c},d.namespace("AnnotationEditSelectionGrid"),d.AnnotationEditSelectionGrid.initController=function(d){var e=b.Controller.initController("OAC.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid",d),f,g=[];d=e.options,g=e.options.dirs,f=c.Client.StreamingVideo.Controller.Drag.initController({}),e.applyBindings=function(b,c){var h,i,j={},k={},l={},m={},n={},o,p={},q={},r={},s={},t,u=c.paper,v={},w=5,x,y,z,A,B={},C,D={},E={},F={},G,H={},I={},J={},K;b.attachRendering=function(a){b.detachRendering();a!==undefined&&(o=a,x(),C())},b.detachRendering=function(){a.isEmptyObject(j)||(o=undefined,j.hide(),l.hide(),k.hide(),m&&m.hide())},x=function(){t=o.getExtents(),v.width=t.width+2*w,v.height=t.height+2*w,v.x=t.x-w/8-v.width/2,v.y=t.y-w/8-v.height/2,y(v),m&&z(v)},C=function(){var c;a.isEmptyObject(j)?(j=u.set(),a.each(n,function(a,b){var c;a==="mid"?(k=u.rect(b.x,b.y,w,w),b.id=k.id):(c=u.rect(b.x,b.y,w,w),b.id=c.id,c.attr({cursor:b.cursor}),j.push(c))}),j.attr({fill:99e4,stroke:"black"}),a.isEmptyObject(k)||k.attr({fill:99e4,stroke:"black",cursor:"move"}),l=u.rect(v.x,v.y,v.width,v.height),l.attr({stroke:"green","stroke-dasharray":["--"]}),z(v),a.isEmptyObject(k)||(c=f.bind(k),c.events.onUpdate.addListener(function(a,b){D.nx=v.x+a,D.ny=v.y+b,E.x=t.x+a,E.y=t.y+b,l.attr({x:D.nx,y:D.ny}),y({x:D.nx,y:D.ny,width:v.width,height:v.height}),m&&z({x:D.nx,y:D.ny,width:v.width,height:v.height})}),c.events.onFocus.addListener(function(a,b){h=a,i=b,x(),o.shape.attr({cursor:"move"})}),c.events.onUnfocus.addListener(function(){var a={x:E.x,y:E.y};b.events.onMove.fire(a)})),j.forEach(function(a){var c=f.bind(a);c.events.onUpdate.addListener(function(a,b){E.w=Math.abs(t.width+a*s.x),E.h=Math.abs(t.height+b*s.y),D.nw=E.w+w*2,D.nh=E.h+w*2,D.nx=t.x-w/4-D.nw/2,D.ny=t.y-w/4-D.nh/2,l.attr({x:D.nx,y:D.ny,width:D.nw,height:D.nh}),y({x:D.nx,y:D.ny,width:D.nw,height:D.nh}),m&&z({x:D.nx,y:D.ny,width:D.nw,height:D.nh})}),c.events.onFocus.addListener(function(a,b){var c,e;t=o.getExtents(),h=a,i=b,d.application.setCurrentMode("Drag"),c=8*(h-t.x)/t.width+4,e=8*(i-t.y)/t.height+4,c<3?s.x=-2:c<5?s.x=0:s.x=2,e<3?s.y=-2:e<5?s.y=0:s.y=2,x()}),c.events.onUnfocus.addListener(function(){var a={width:E.w,height:E.h};o!==undefined&&b.events.onResize.fire(a),d.application.setCurrentMode("Select")})})):(l.show(),l.attr({x:v.x,y:v.y,width:v.width,height:v.height}),j.show(),k.show().toFront(),m&&(m.show(),z(v)))},z=function(c){a.isEmptyObject(m)?(F.x=c.x+c.width,F.y=c.y-w*4-2,F.w=100,F.h=20,I={x:F.x+2,y:F.y+2,w:F.w/2-4,h:F.h-F.h/8},H={x:I.x+I.w+2,y:F.y+2,w:F.w/2-4,h:F.h-F.h/8},m=u.set(),r=u.rect(F.x,F.y,F.w,F.h),r.attr({fill:"#FFFFFF",stroke:"#000"}),m.push(r),q=u.rect(I.x,I.y,I.w,I.h),q.attr({fill:334009,cursor:"pointer"}),m.push(q),p=u.rect(H.x,H.y,H.w,H.h),p.attr({fill:334009,cursor:"pointer"}),m.push(p),q.mousedown(function(){o!==undefined&&e.events.onEdit.fire(o.id)}),q.hover(function(){q.attr({fill:443009})},function(){q.attr({fill:334009})}),p.mousedown(function(){o!==undefined&&(b.events.onDelete.fire(),A())}),p.hover(function(){p.attr({fill:443009})},function(){p.attr({fill:334009})})):(F.x=c.x+c.width,F.y=c.y-w*4-2,I={x:F.x+2,y:F.y+2},H={x:I.x+q.attr("width")+2,y:F.y+2},r.attr({x:F.x,y:F.y}),q.attr(I),p.attr(H))},A=function(){b.detachRendering(),o=undefined,m.hide(),l.hide(),j.hide(),k.hide()},J={ul:["nw",0,0,0,0],top:["n",1,0,0,0],ur:["ne",2,-1,0,0],rgt:["e",2,-1,1,0],lr:["se",2,-1,2,-1],btm:["s",1,0,2,-1],ll:["sw",0,0,2,-1],lft:["w",0,0,1,0],mid:["pointer",1,0,1,0]},y=function(b){var c=function(a,c,d,e,f){return{x:b.x+c*b.width/2+d*w,y:b.y+e*b.height/2+f*w,cursor:a.length>2?a:a+"-resize"}},d=function(a,c,d,e,f){var g;a.x=b.x+c*b.width/2+d*w,a.y=b.y+e*b.height/2+f*w,g=u.getById(a.id),g.attr({x:a.x,y:a.y})};a.each(g,function(a,b){var e=J[b];e!==undefined&&(n[b]===undefined?n[b]=c(e[0],e[1],e[2],e[3],e[4]):d(n[b],e[1],e[2],e[3],e[4]))})}};return e},d.namespace("ShapeCreateBox"),d.ShapeCreateBox.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.ShapeCreateBox",c);c=d.options,d.applyBindings=function(b,c){var d,e,f={},g,h={},i=c.paper,j={},k=10,l,m,n={},o,p;b.createGuide=function(b){j.x=b[0],j.y=b[1],j.width=b[0]+k,j.height=b[1]+k,a.isEmptyObject(f)?(f=i.rect(j.x,j.y,j.width,j.height),f.attr({stroke:"green","stroke-dasharray":["--"]})):(f.show(),f.attr({x:j.x,y:j.y,width:j.width,height:j.height}))},b.resizeGuide=function(a){j.width=a[0]-j.x,j.height=a[1]-j.y,f.attr({width:j.width,height:j.height})},b.completeShape=function(a){j.width=a.width,j.height=a.height,f.attr({width:j.width,height:j.height}),f.hide();return{x:j.x,y:j.y,width:j.width,height:j.height}}};return d},d.namespace("TextBodyEditor"),d.TextBodyEditor.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.TextBodyEditor",c);c=d.options,d.applyBindings=function(b,d){var e,f,g,h=b.locate("annotation"),i=b.locate("body"),j=b.locate("annotations"),k=b.locate("textarea"),l=b.locate("editarea"),m=b.locate("editbutton"),n=b.locate("updatebutton"),o=b.locate("deletebutton"),p=!1,q;e=function(){a(l).show(),a(i).hide(),p=!0,b.events.onClick.fire(d.itemId)},f=function(){a(l).hide(),a(i).show(),p=!1},g=function(c){var e=a(k).val();c.preventDefault(),b.events.onUpdate.fire(d.itemId,e),f()},a(h).bind("dblclick",function(a){a.preventDefault(),p?(f(),c.application.setCurrentMode(q||"")):(e(),q=c.application.getCurrentMode(),c.application.setCurrentMode("TextEdit"))}),a(h).bind("click",function(a){c.application.setActiveAnnotation(d.itemId)}),a(n).bind("click",function(e){b.events.onUpdate.fire(d.itemId,a(k).val()),f(),c.application.setCurrentMode(q)}),a(o).bind("click",function(c){b.events.onDelete.fire(d.itemId),a(h).remove()}),c.application.events.onActiveAnnotationChange.addListener(function(a){a!==d.id&&p&&(g({preventDefault:function(){}}),f())}),c.application.events.onCurrentModeChange.addListener(function(a){a!=="TextEdit"&&f()})};return d},d.namespace("CanvasClickController"),d.CanvasClickController.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.CanvasClickController",c);c=d.options,d.applyBindings=function(b,d){var e,f,g,h,i=d.closeEnough,j,k,l,m,n,o,p,q={},r=d.paper,s,t=function(a){var c;if(p===undefined||a!==p.id){c=q[a];if(c===undefined){b.events.onClick.fire(undefined),p=undefined;return!1}p=c}},u=function(a){if(p===undefined||a!==p.id)var b=q[a]},v=function(c,d){var e=0,f=[],g=[],h,i,j,k,l=a(c).offset();a(c).unbind(),a(d).mousedown(function(a){e<=0&&(h=a.pageX-l.left,i=a.pageY-l.top,f=[h,i],e=1,b.events.onShapeStart.fire(f))}),a(d).mousemove(function(a){e!==2&&e!==0&&(h=a.pageX-l.left,i=a.pageY-l.top,g=[h,i],b.events.onShapeDrag.fire(g))}),a(d).mouseup(function(a){e>=1&&(e=0,g===undefined&&(g=[h+5,i+5]),b.events.onShapeDone.fire({x:f[0],y:f[1],width:g[0]-f[0],height:g[1]-f[1]}))})},w=function(b){a(b).unbind(),a(b).bind("mousedown",function(a){c.application.setActiveAnnotation(undefined),h=""})};c.application.events.onActiveAnnotationChange.addListener(t),c.application.events.onCurrentModeChange.addListener(function(c){c==="Rectangle"||c==="Ellipse"?v(b.locate("svgwrapper"),b.locate("svg")):c==="Select"?w(b.locate("svg")):a(b.locate("svg")).unbind()}),b.registerRendering=function(a){q[a.id]=a},b.removeRendering=function(a){delete q[a.id]}};return d},d.namespace("AnnotationCreationButton"),d.AnnotationCreationButton.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.AnnotationCreationButton",c);c=d.options,d.applyBindings=function(b,d){var e,f=!1,g,h;e=b.locate("button"),a(e).live("mousedown",function(b){f===!1?(f=!0,c.application.setCurrentMode(d.action),a(e).addClass("active")):f===!0&&(f=!1,c.application.setCurrentMode(""),a(e).removeClass("active"))}),g=function(b){b===c.action?(f=!0,a(e).addClass("active")):(f=!1,a(e).removeClass("active"))},c.application.events.onCurrentModeChange.addListener(g)};return d},d.namespace("sliderButton"),d.sliderButton.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.sliderButton",c);c=d.options,d.applyBindings=function(b,d){var e,f,g,h,i,j;f=b.locate("timedisplay"),j=function(b){i===undefined&&(i=b,a(e).slider("value",i))},g=function(b,d){c.application.setCurrentTime(d.value),a(f).text("TIME: "+d.value),i=d.value},h=function(b,d){d===undefined&&(i=b,a(e).slider("value",b));i!==d.value&&(c.application.setCurrentTime(d.value),a(f).text("TIME: "+d.value),i=d.value)},e=b.locate("slider"),a(e).slider({start:g,slide:h})};return d},d.namespace("timeControl"),d.timeControl.initController=function(c){var d=b.Controller.initController("OAC.Client.StreamingVideo.Controller.timeControl",c);c=d.options,d.currentId="",d.applyBindings=function(b,d){var e=b.locate("timestart"),f=b.locate("timeend"),g=b.locate("submit"),h=b.locate("menudiv"),i,j;a(h).hide(),a(g).bind("click",function(){i=parseInt(a(e).val(),10),j=parseInt(a(f).val(),10),b.currentId!==undefined&&i!==undefined&&j!==undefined&&(b.events.onUpdate.fire(b.currentId,i,j),a(h).hide())}),c.application.events.onActiveAnnotationChange.addListener(function(c){c!==undefined?(a(h).show(),a(e).val(""),a(f).val(""),b.currentId=c):c===undefined&&a(h).hide()})};return d},d.namespace("WindowResize"),d.WindowResize.initController=function(a){var c=b.Controller.initController("OAC.Client.StreamingVideo.Controller.WindowResize",a);a=c.options,c.applyBindings=function(a,b){var c=a.locate("");c.resize(function(){setTimeout(a.events.onResize.fire,0)})};return c}}(jQuery,MITHGrid,OAC),function(a,b,c){b.Presentation.namespace("AnnotationList"),b.Presentation.AnnotationList.initPresentation=function(a,c){var d=b.Presentation.initPresentation("MITHGrid.Presentation.AnnotationList",a,c);return d},b.Presentation.namespace("RaphaelCanvas"),b.Presentation.RaphaelCanvas.initPresentation=function(c,d){var e=b.Presentation.initPresentation("MITHGrid.Presentation.RaphaelCanvas",c,d),f=a(c).attr("id"),g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;d=e.options,k=d.controllers.canvas,l=d.controllers.keyboard,m=d.controllers.shapeEditBox,q=d.controllers.shapeCreateBox,s=d.controllers.windowResize,i=a(c).css("x"),j=a(c).css("y"),h=a(c).width(),g=a(c).height(),p=l.bind(a("body"),{}),e.events=a.extend(!0,e.events,p.events),e.canvas=new Raphael(a(c),h,g),o=k.bind(a("body"),{closeEnough:5,paper:e.canvas}),x=m.bind(a(c),{paper:e.canvas}),r=q.bind(a(c),{paper:e.canvas}),t=s.bind(window),x.events.onResize.addListener(function(a){var b=e.getActiveRendering();b!==null&&b.eventResize!==undefined&&b.eventResize(a)}),x.events.onMove.addListener(function(a){var b=e.getActiveRendering();b!==null&&b.eventMove!==undefined&&b.eventMove(a)}),x.events.onDelete.addListener(function(){var a=e.getActiveRendering();a!==null&&a.eventDelete!==undefined&&(a.eventDelete(),x.detachRendering())}),d.application.events.onCurrentModeChange.addListener(function(a){a!=="Select"&&a!=="Drag"&&x.detachRendering()}),t.events.onResize.addListener(function(){var b,c,d,e,f,g,h;g=a("body").find("svg"),f=a("body").find("#myplayer"),h=a("body").find(".section-canvas"),b=parseInt(a(f).offset().left,10),c=parseInt(a(f).offset().top,10),d=parseInt(a(f).width(),10),e=parseInt(a(f).height(),10),a(g).css({left:b+"px",top:c+"px",width:d+"px",height:e+"px"}),a(h).css({left:b+"px",top:c+"px",width:d+"px",height:e+"px"})}),t.events.onResize.fire(),o.events.onShapeStart.addListener(function(a){r.createGuide(a)}),o.events.onShapeDrag.addListener(function(a){r.resizeGuide(a)}),o.events.onShapeDone.addListener(function(a){var b=r.completeShape(a);d.application.insertShape(b)}),u=function(b){b!==undefined&&(D=b.getcoordinates(),E=b.getsize(),a(c).css({left:parseInt(D[0],10)+"px",top:parseInt(D[1],10)+"px",width:E[0],height:E[1]}),a("svg").css({left:parseInt(D[0],10)+"px",top:parseInt(D[1],10)+"px",width:E[0],height:E[1]}))},d.application.events.onCurrentTimeChange.addListener(function(a){e.visitRenderings(function(b,c){c.eventCurrentTimeChange!==undefined&&c.eventCurrentTimeChange(a)})}),d.application.events.onTimeEasementChange.addListener(function(a){e.visitRenderings(function(b,c){c.eventTimeEasementChange!==undefined&&c.eventTimeEasementChange(a)})}),d.application.events.onPlayerChange.addListener(u),d.application.dataStore.canvas.events.onModelChange.addListener(function(){x.detachRendering()}),n=e.render,e.render=function(a,b,c){var e=n(a,b,c),f;if(e!==undefined){f=b;while(f.dataStore)f=f.dataStore;A=f,z=d.dataView.prepare(["!type"]),o.registerRendering(e)}return e},w=e.eventFocusChange,e.eventFocusChange=function(a){d.application.getCurrentMode()==="Select"&&(w(a),x.attachRendering(e.getActiveRendering()))};return e}}(jQuery,MITHGrid,OAC),function(a,b,c){var d=1;c.Client.StreamingVideo.initApp=function(c,e){var f,g,h,i,j,k={},l=0,m="OAC-Client-StreamingVideo-SVG-Canvas-"+d,n=[],o=[];d+=1,g=b.Application.initApp("OAC.Client.StreamingVideo",c,a.extend(!0,{},{viewSetup:'<div id="'+m+'" class="section-canvas"></div>'+'<div class="mithgrid-bottomarea">'+'<div class="timeselect">'+"<p>Enter start time:</p>"+'<input id="timestart" type="text" />'+"<p>Enter end time:</p>"+'<input id="timeend" type="text" />'+'<div id="submittime" class="button">Confirm time settings</div>'+"</div>"+'<div id="sidebar'+m+'" class="section-controls"></div>'+'<div class="section-annotations">'+'<div class="header">'+"Annotations"+"</div>"+"</div>"+"</div>",controllers:{keyboard:{isActive:function(){return g.getCurrentMode()!=="Editing"}},selectShape:{isSelectable:function(){return g.getCurrentMode()==="Select"?!0:!1}}},presentations:{raphsvg:{container:"#"+m,lenses:{},lensKey:[".shapeType"]},annoItem:{container:".section-annotations",lenses:{},lensKey:[".bodyType"]}}},e)),g.initShapeLens=function(a,b,c,d){var e={id:d},f,h,i,j,k,l,m,n=c.getItem(d);f=function(a){var b=0;if(a<l||a>m)return 0;a<j?(b=1/(j-a),b=b.toFixed(3)):a>k?(b=1/(a-k),b=b.toFixed(3)):b=1;return b},j=n.ntp_start[0],k=n.ntp_end[0],l=j-g.getTimeEasement(),m=k+g.getTimeEasement(),i=f(g.getCurrentTime()),e.eventTimeEasementChange=function(a){l=j-a,m=k+a,e.setOpacity(f(g.getCurrentTime()))},e.eventCurrentTimeChange=function(a){e.setOpacity(f(a))},e.setOpacity=function(a){a!==null&&a!==undefined&&(i=a),e.shape.attr({opacity:(h?1:.5)*i})},e.eventFocus=function(){h=1,e.setOpacity(),e.shape.toFront(),b.events.onDelete.addListener(e.eventDelete)},e.eventUnfocus=function(){h=0,e.setOpacity(),e.shape.toBack(),b.events.onDelete.removeListener(e.eventDelete)},e.eventDelete=function(){c.removeItems([d])},e.eventResize=function(a){c.updateItems([{id:d,w:a.width,h:a.height}])},e.eventMove=function(a){c.updateItems([{id:d,x:a.x,y:a.y}])},e.update=function(a){if(a.ntp_start[0]!==j||a.ntp_end[0]!==k)j=a.ntp_start[0],k=a.ntp_end[0],l=j-g.getTimeEasement(),m=k+g.getTimeEasement(),e.setOpacity(f(g.getCurrentTime()))},e.remove=function(a){e.shape.remove()};return e},g.initTextLens=function(b,c,d,e){var f={},h=d.getItem(e),i,j,k,l;i=a('<div class="anno_item"><p class="bodyContentInstructions">Double click here to open edit window.</p><div class="editArea"><textarea class="bodyContentTextArea"></textarea><div id="editUpdate" class="button update">Update</div><div id="editDelete" class="button delete">Delete</div></div><div class="body"><p class="bodyContent"></p></div></div>'),k=a(i).find(".bodyContentTextArea"),l=a(i).find(".bodyContent"),a(k).text(h.bodyContent[0]),a(l).text(h.bodyContent[0]),a(b).append(i),a(i).find(".editArea").hide(),f.eventFocus=function(){i.addClass("selected")},f.eventUnfocus=function(){i.removeClass("selected")},f.eventUpdate=function(a,b){a===e&&d.updateItems([{id:e,bodyContent:b}])},f.eventDelete=function(a){a===e&&d.removeItems([e])},f.update=function(b){a(i).find(".bodyContent").text(b.bodyContent[0]),a(i).find(".bodyContentTextArea").text(b.bodyContent[0])},f.remove=function(){a(i).remove()},j=g.controller.annoActive.bind(i,{model:d,itemId:e}),j.events.onClick.addListener(g.setActiveAnnotation),j.events.onDelete.addListener(f.eventDelete),j.events.onUpdate.addListener(f.eventUpdate);return f},g.buttonFeature=function(b,c,d){if(a("#"+d).length!==0)return!1;var e={},f,h=a(".button"),i,j=a("#sidebar"+m),k,l,n;b==="buttongrouping"?(a(j).find("#"+c).length===0&&a(j).append('<div id="'+c+'" class="buttongrouping"></div>'),i=a("#"+c),f='<div id="'+d+'" class="button">'+d+"</div>",a(i).append(f),e.element=a("#"+d),k=g.controller.buttonActive.bind(e.element,{action:d})):b==="slidergrouping"&&(a(j).find("#"+c).length===0&&a(j).append('<div id="'+c+'" class="slidergrouping"></div>'),i=a("#"+c),f='<div id="'+d+'"><div class="header">'+d+"</div>"+'<div id="slider"></div><div class="timedisplay"></div></div>',a(i).append(f),e.element=a("#"+d),k=g.controller.slider.bind(e.element,{action:d}));return e},g.addShape=function(a,b){g.presentation.raphsvg.addLens(a,b)},g.addBody=function(a,b){g.presentation.annoItem.addLens(a,b)},g.addShapeType=function(a,b){var c,d,e;d=b.calc,e=b.lens,c=g.buttonFeature("Shapes",a),k[a]={calc:d},g.addShape(a,e)},g.insertShape=function(b){var c,d=parseFloat(g.getCurrentTime())-5,e=parseFloat(g.getCurrentTime())+5,f=g.getCurrentMode(),h;h=k[f].calc(b),l+=1,c={id:"anno"+l,type:"Annotation",bodyType:"Text",bodyContent:"This is an annotation for "+f,shapeType:f,opacity:1,ntp_start:d,ntp_end:e},g.dataStore.canvas.loadItems([a.extend(c,h)])},g.exportShapes=function(){var b,c;b=a("#"+m).width(),c=a("#"+m).height(),a.each([])},g.ready(function(){g.events.onActiveAnnotationChange.addListener(g.presentation.raphsvg.eventFocusChange),g.events.onActiveAnnotationChange.addListener(g.presentation.annoItem.eventFocusChange),g.events.onCurrentTimeChange.addListener(function(a){g.dataView.currentAnnotations.setKeyRange(a-5,a+5)}),g.events.onPlayerChange.addListener(function(a){g.setCurrentTime(a.getPlayhead()),a.onPlayheadUpdate(function(a){g.setCurrentTime(g.getCurrentTime()+1)}),g.events.onCurrentModeChange.addListener(function(b){b!=="Watch"?a.pause():b==="Watch"&&a.play()})})}),g.ready(function(){var c,d,e,f,h,i,j,k,l,m,n,o;d=function(a){var b={};b.x=a.x+a.width/2,b.y=a.y+a.height/2,b.w=a.width,b.h=a.height;return b},m=function(b,c,d){var e={},f;f=a.extend(!0,{},b),e.x=f.x/c*100,e.y=f.y/d*100,e.w=f.w/c*100,e.h=f.h/d*100;return a.extend(f,e)},f=function(c,d,e,f){var h=g.initShapeLens(c,d,e,f),i=e.getItem(f),j,k,l,m;l=d.canvas.rect(i.x[0]-i.w[0]/2,i.y[0]-i.h[0]/2,i.w[0],i.h[0]),h.shape=l,l.attr({fill:"red"}),h.setOpacity(),a(l.node).attr("id",i.id[0]),k=g.controller.selectShape.bind(l),k.events.onSelect.addListener(function(){g.setActiveAnnotation(f)}),j=h.update,h.update=function(a){i=a,j(i);try{i.x!==undefined&&i.y!==undefined&&i.w!==undefined&&i.h!==undefined&&l.attr({x:i.x[0]-i.w[0]/2,y:i.y[0]-i.h[0]/2,width:i.w[0],height:i.h[0]})}catch(c){b.debug(c)}},h.getExtents=function(){return{x:l.attr("x")+l.attr("width")/2,y:l.attr("y")+l.attr("height")/2,width:l.attr("width"),height:l.attr("height")}};return h},g.addShapeType("Rectangle",{calc:d,lens:f}),e=function(a){var b={};b.x=a.x+a.width/2,b.y=a.y+a.height/2,b.w=a.width,b.h=a.height;return b},h=function(a,c,d,e){var f=g.initShapeLens(a,c,d,e),h=d.getItem(e),i,j,k;k=c.canvas.ellipse(h.x[0],h.y[0],h.w[0]/2,h.h[0]/2),f.shape=k,k.attr({fill:"red"}),f.setOpacity(),j=g.controller.selectShape.bind(k),j.events.onSelect.addListener(function(){g.setActiveAnnotation(e)}),i=f.update,f.update=function(a){i(a);try{a.x!==undefined&&a.y!==undefined&&k.attr({cx:a.x[0],cy:a.y[0],rx:a.w[0]/2,ry:a.h[0]/2})}catch(c){b.debug(c)}},f.getExtents=function(){return{x:k.attr("cx"),y:k.attr("cy"),width:k.attr("rx")*2,height:k.attr("ry")*2}};return f},g.addShapeType("Ellipse",{calc:e,lens:h}),g.addBody("Text",g.initTextLens),i=g.buttonFeature("buttongrouping","Shapes","Rectangle"),j=g.buttonFeature("buttongrouping","Shapes","Ellipse"),k=g.buttonFeature("buttongrouping","General","Select"),n=g.buttonFeature("buttongrouping","General","Watch"),g.setCurrentTime(0),o=g.controller.timecontrol.bind(".timeselect",{}),o.events.onUpdate.addListener(function(a,b,c){g.dataStore.canvas.updateItems([{id:a,ntp_start:b,ntp_end:c}])})});return g}}(jQuery,MITHGrid,OAC),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.CanvasClickController",{bind:{events:{onClick:null,onShapeStart:null,onShapeDrag:null,onShapeDone:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.TextBodyEditor",{bind:{events:{onClick:null,onDelete:null,onUpdate:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid",{dirs:["ul","top","ur","lft","lr","btm","ll","rgt","mid"],bind:{events:{onResize:null,onMove:null,onEdit:null,onDelete:null,onCurrentModeChange:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.KeyboardListener",{bind:{events:{onDelete:["preventable","unicast"]}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.AnnotationCreationButton",{bind:{events:{onCurrentModeChange:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.ShapeCreateBox",{bind:{events:{}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.WindowResize",{bind:{events:{onResize:null}},selectors:{"":""}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.Drag",{bind:{events:{onFocus:null,onUnfocus:null,onUpdate:null}},selectors:{"":""}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.Select",{bind:{events:{onSelect:null}},selectors:{"":""},isSelectable:function(){return!0}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.timeControl",{bind:{events:{onUpdate:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo",{controllers:{keyboard:{type:OAC.Client.StreamingVideo.Controller.KeyboardListener,selectors:{doc:""}},shapeEditBox:{type:OAC.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid},shapeCreateBox:{type:OAC.Client.StreamingVideo.Controller.ShapeCreateBox},canvas:{type:OAC.Client.StreamingVideo.Controller.CanvasClickController,selectors:{svg:" > svg",svgwrapper:".section-canvas"}},annoActive:{type:OAC.Client.StreamingVideo.Controller.TextBodyEditor,selectors:{annotation:"",annotationlist:":parent",bodycontent:".bodyContent",body:".body",editbutton:".button.edit",editarea:".editArea",textarea:".editArea > textarea",updatebutton:".button.update",deletebutton:".button.delete"}},buttonActive:{type:OAC.Client.StreamingVideo.Controller.AnnotationCreationButton,selectors:{button:""}},slider:{type:OAC.Client.StreamingVideo.Controller.sliderButton,selectors:{slider:"#slider",timedisplay:".timedisplay"}},timecontrol:{type:OAC.Client.StreamingVideo.Controller.timeControl,selectors:{timestart:"#timestart",timeend:"#timeend",submit:"#submittime",menudiv:""}},windowResize:{type:OAC.Client.StreamingVideo.Controller.WindowResize},selectShape:{type:OAC.Client.StreamingVideo.Controller.Select}},variables:{ActiveAnnotation:{is:"rw"},CurrentTime:{is:"rw","default":0},TimeEasement:{is:"rw","default":5},CurrentMode:{is:"rw"},Player:{is:"rw"}},dataViews:{currentAnnotations:{dataStore:"canvas",type:MITHGrid.Data.RangePager,leftExpressions:[".ntp_start"],rightExpressions:[".ntp_end"]}},dataStores:{canvas:{types:{Annotation:{}},properties:{shapeType:{valueType:"text"},bodyType:{valueType:"text"},bodyContent:{valueType:"text"},targetURI:{valueType:"uri"},opacity:{valueType:"numeric"},ntp_start:{valueType:"numeric"},ntp_end:{valueType:"numeric"}}}},presentations:{raphsvg:{type:MITHGrid.Presentation.RaphaelCanvas,dataView:"currentAnnotations",controllers:{keyboard:"keyboard",canvas:"canvas",shapeCreateBox:"shapeCreateBox",shapeEditBox:"shapeEditBox",windowResize:"windowResize"},events:{onOpacityChange:null},fadeStart:5},annoItem:{type:MITHGrid.Presentation.AnnotationList,dataView:"currentAnnotations",container:".anno_list"}}});
>>>>>>> c7d711250f069877efc73c7019b3cc3d113bcd4b
