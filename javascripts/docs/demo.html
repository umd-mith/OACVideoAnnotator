---
layout: docco
title: demo.coffee
---
<div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               demo.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>Video Annotator Demo</h1>

<p>This is the CoffeeScript source for the demo.js file used in the <a href="/OACVideoAnnotator/demo.html">demonstration page</a>.
This is an example of how you might build a video annotation application using the Video Annotator and
MITHgrid libraries.</p>

<p>We start by defining some default configuration information, then define the components we'll need for
the user interface outside the Video Annotator core, and then we end by defining the sub-class of the
Video Annotator that ties everything together.</p>

<h1>#</h1>

<h2>Educational Community License, Version 2.0</h2>

<p>Copyright 2011 University of Maryland. Licensed under the Educational
Community License, Version 2.0 (the "License"); you may not use this file
except in compliance with the License. You may obtain a copy of the License at</p>

<p>http:#www.osedu.org/licenses/ECL-2.0</p>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.</p>

<h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Default Configurations</h2>

<p>We define some default configurations for the controllers and other components we define here.
MITHgrid combines these configurations with any we provide when we instantiate an object.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Hover (controller)</h3>

<p>Each binding object will have the following events available:</p>

<ul>
<li>onFocus</li>
<li>onUnfocus</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">MITHgrid</span><span class="p">.</span><span class="nx">defaults</span> <span class="s">&quot;OAC.Client.StreamingVideo.Demo.Hover&quot;</span><span class="p">,</span>
    <span class="nv">bind:</span>
        <span class="nv">events:</span>
            <span class="nv">onFocus: </span><span class="kc">null</span>
            <span class="nv">onUnfocus: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>Click (controller)</h3>

<p>Each binding object will have the following events available:</p>

<ul>
<li>onSelect</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">MITHgrid</span><span class="p">.</span><span class="nx">defaults</span> <span class="s">&quot;OAC.Client.StreamingVideo.Demo.Click&quot;</span><span class="p">,</span>
    <span class="nv">bind:</span>
        <span class="nv">events:</span>
            <span class="nv">onSelect: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>TextControls (component)</h3>

<p>Each instance of this component will have the following events available:</p>

<ul>
<li>onDelete</li>
<li>onEdit</li>
<li>onSave</li>
</ul>

<p>Additionally, the text control DOM elements will be added to the container passed in to the
instance constructor.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">MITHgrid</span><span class="p">.</span><span class="nx">defaults</span> <span class="s">&quot;OAC.Client.StreamingVideo.Demo.TextControls&quot;</span><span class="p">,</span>
    <span class="nv">events:</span>
        <span class="nv">onCancel: </span><span class="kc">null</span>
        <span class="nv">onDelete: </span><span class="kc">null</span>
        <span class="nv">onEdit: </span><span class="kc">null</span>
        <span class="nv">onSave: </span><span class="kc">null</span>
    <span class="nv">viewSetup: </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        &lt;span class=&quot;edit&quot;&gt;&lt;a href=&quot;</span><span class="err">#</span><span class="s">&quot; title=&quot;edit annotation&quot;&gt;&lt;/a&gt;&lt;/span&gt;</span>
<span class="s">        &lt;span class=&quot;save&quot;&gt;&lt;a href=&quot;</span><span class="err">#</span><span class="s">&quot; title=&quot;save edit&quot;&gt;&lt;/a&gt;&lt;/span&gt;</span>
<span class="s">        &lt;span class=&quot;cancel&quot;&gt;&lt;a href=&quot;</span><span class="err">#</span><span class="s">&quot; title=&quot;cancel edit&quot;&gt;&lt;/a&gt;&lt;/span&gt;    </span>
<span class="s">        &lt;span class=&quot;delete&quot;&gt;&lt;a href=&quot;</span><span class="err">#</span><span class="s">&quot; title=&quot;delete annotation&quot;&gt;&lt;/a&gt;&lt;/span&gt;</span>
<span class="s">    &quot;&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Components</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">OAC</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">StreamingVideo</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&quot;Demo&quot;</span><span class="p">,</span> <span class="nf">(Demo) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h3>Click (controller)</h3>

<p>Attaches a click handler to an SVG rendering and fires an onSelect event if the rendering is clicked AND
the application is in a mode to select things.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Demo</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&quot;Click&quot;</span><span class="p">,</span> <span class="nf">(Click) -&gt;</span>
        <span class="nv">Click.initInstance = </span><span class="nf">(args...) -&gt;</span>
            <span class="nx">MITHgrid</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;OAC.Client.StreamingVideo.Demo.Click&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">...,</span> <span class="nf">(that) -&gt;</span>
                <span class="nv">that.applyBindings = </span><span class="nf">(binding) -&gt;</span>
                    <span class="nx">binding</span><span class="p">.</span><span class="nx">locate</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">click</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onSelect</span><span class="p">.</span><span class="nx">fire</span>
    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h3>Hover (controller)</h3>

<p>Attaches a set of hover handlers to a DOM element and fires onFocus and onUnfocus events as the
mouse starts or stops hovering over the element.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Demo</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&quot;Hover&quot;</span><span class="p">,</span> <span class="nf">(Hover) -&gt;</span>
        <span class="nv">Hover.initInstance = </span><span class="nf">(args...) -&gt;</span>
            <span class="nx">MITHgrid</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;OAC.Client.StreamingVideo.Demo.Hover&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">...,</span> <span class="nf">(that) -&gt;</span>
                <span class="nv">that.applyBindings = </span><span class="nf">(binding) -&gt;</span>
                    <span class="nx">binding</span><span class="p">.</span><span class="nx">locate</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">hover</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onFocus</span><span class="p">.</span><span class="nx">fire</span><span class="p">,</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onUnfocus</span><span class="p">.</span><span class="nx">fire</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h3>TextControls (component)</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Demo</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&quot;TextControls&quot;</span><span class="p">,</span> <span class="nf">(TextControls) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>We have a global click controller since we don't have any particular configuration that
is specific to the TextControls instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">clickController = </span><span class="nx">Demo</span><span class="p">.</span><span class="nx">Click</span><span class="p">.</span><span class="nx">initInstance</span> <span class="p">{}</span>
        
        <span class="nv">TextControls.initInstance = </span><span class="nf">(args...) -&gt;</span>    
            <span class="nx">MITHgrid</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;OAC.Client.StreamingVideo.Demo.TextControls&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">...,</span> <span class="nf">(that, container) -&gt;</span>
                <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
                <span class="nv">app = </span><span class="nx">options</span><span class="p">.</span><span class="nx">application</span><span class="p">()</span>
                <span class="nv">appFn = </span><span class="nx">options</span><span class="p">.</span><span class="nx">application</span>
                <span class="nv">shown = </span><span class="kc">false</span>
                <span class="nv">inEditing = </span><span class="kc">false</span>
                <span class="nv">setEditMode = </span><span class="o">-&gt;</span>
                <span class="nv">resetEditMode = </span><span class="o">-&gt;</span>

                <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Instead of building a controller that will bind to four different aspects of
the text controls DOM, we attach the controller to each of the controls we
show.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    
                    <span class="nv">editEl = </span><span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;.edit&quot;</span><span class="p">)</span>
                    <span class="nv">saveEl = </span><span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;.save&quot;</span><span class="p">)</span>
                    <span class="nv">cancelEl = </span><span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;.cancel&quot;</span><span class="p">)</span>
                    <span class="nv">deleteEl = </span><span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;.delete&quot;</span><span class="p">)</span>
                
                    <span class="nv">editBinding = </span><span class="nx">clickController</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">editEl</span>
                    <span class="nv">saveBinding = </span><span class="nx">clickController</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">saveEl</span>
                    <span class="nv">cancelBinding = </span><span class="nx">clickController</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">cancelEl</span>
                    <span class="nv">deleteBinding = </span><span class="nx">clickController</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">deleteEl</span>
                    </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>We use a pair of helpers to manage which tools we show.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">setEditMode = </span><span class="o">-&gt;</span>
                        <span class="nv">inEditing = </span><span class="kc">true</span>
                        <span class="nx">editEl</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
                        <span class="nx">saveEl</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>
                        <span class="nx">deleteEl</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
                        <span class="nx">cancelEl</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>
                        
                    <span class="nv">resetEditMode = </span><span class="o">-&gt;</span>
                        <span class="nv">inEditing = </span><span class="kc">false</span>
                        <span class="nx">editEl</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>
                        <span class="nx">saveEl</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
                        <span class="nx">deleteEl</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>
                        <span class="nx">cancelEl</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
                    </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>We take each of the bindings and add a listener that will manage the set of icons we show.
We also fire the individual command-related events that this component exposes.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">editBinding</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onSelect</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="nx">shown</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">inEditing</span>
                            <span class="nx">setEditMode</span><span class="p">()</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onEdit</span><span class="p">.</span><span class="nx">fire</span><span class="p">()</span>
                    <span class="nx">saveBinding</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onSelect</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="nx">shown</span> <span class="o">and</span> <span class="nx">inEditing</span>
                            <span class="nx">resetEditMode</span><span class="p">()</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onSave</span><span class="p">.</span><span class="nx">fire</span><span class="p">()</span>
                    <span class="nx">cancelBinding</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onSelect</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="nx">shown</span> <span class="o">and</span> <span class="nx">inEditing</span>
                            <span class="nx">resetEditMode</span><span class="p">()</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onCancel</span><span class="p">.</span><span class="nx">fire</span><span class="p">()</span>
                    <span class="nx">deleteBinding</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onSelect</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="nx">shown</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">inEditing</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onDelete</span><span class="p">.</span><span class="nx">fire</span><span class="p">()</span>
                    
                    <span class="nx">resetEditMode</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h4>#eventShow</h4>

<p>Shows the tools in the DOM. Also resets edit mode flags.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.eventShow = </span><span class="o">-&gt;</span> 
                    <span class="nx">resetEditMode</span><span class="p">()</span>
                    <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
                    <span class="nv">shown = </span><span class="kc">true</span>
            </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h4>#eventHide</h4>

<p>Hides the tools in the DOM.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.eventHide = </span><span class="o">-&gt;</span> 
                    <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
                    <span class="nv">shown = </span><span class="kc">false</span>
            </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h4>#eventMove</h4>

<p>Moves the tools to the indicated location. For now, we assume that the tools are 15px wide each.
Two tools (2 * 15px) plus a 15px separation from the text gives us the 45px deduction.</p>

<p>We reset edit mode if we're in edit mode and we're displayed. This triggers a cancel event
to cancel any editing.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.eventMove = </span><span class="nf">(top, right) -&gt;</span>
                    <span class="k">if</span> <span class="nx">shown</span> <span class="o">and</span> <span class="nx">inEditing</span>
                        <span class="nx">resetEditMode</span><span class="p">()</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onCancel</span><span class="p">.</span><span class="nx">fire</span><span class="p">()</span>
                        
                    <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">css</span>
                        <span class="nv">top: </span><span class="nx">top</span> <span class="o">+</span> <span class="s">&quot;px&quot;</span>
                        <span class="nv">left: </span><span class="p">(</span><span class="nx">right</span> <span class="o">-</span> <span class="mi">45</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;px&quot;</span>
                
                <span class="nx">that</span><span class="p">.</span><span class="nx">eventHide</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>Demo Application</h2>

<p>Now that we have our various components defined, we can proceed to the meat of the demo: sub-classing the Video Annotator
to add our own annotation body display and edit controls. We also add an import/export tie in to the UI.</p>

<p>Typical usage of this would be similar to what we do in the <a href="/OACVideoAnnotator/demo.html">demo.html</a> page:</p>

<pre><code>OAC.Client.StreamingVideo.Player.onNewPlayer.addListener(
  function(playerobj) {
    var app = 
      OAC.Client.StreamingVideo.Demo.Application.initInstance({
        player: playerobj
      });

    app.run();
  }
);
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Demo</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&quot;Application&quot;</span><span class="p">,</span> <span class="nf">(Application) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>We have a few objects that aren't tied to a particular instance of our demo application, so we
create them here. Controllers that are not configured based on the application instance are excellent
candidates for this.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">hoverController = </span><span class="nx">OAC</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">StreamingVideo</span><span class="p">.</span><span class="nx">Demo</span><span class="p">.</span><span class="nx">Hover</span><span class="p">.</span><span class="nx">initInstance</span><span class="p">()</span>
        
        <span class="nv">Application.initInstance = </span><span class="nf">(args...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>We begin by creating an instance of the Video Annotator application.
This requires the player object passed in by the onNewPlayer function above.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">OAC</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">StreamingVideo</span><span class="p">.</span><span class="nx">Application</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;OAC.Client.StreamingVideo.Demo.Application&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">...,</span> <span class="nf">(app) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Creating a function <code>appFn</code> that will return the <code>app</code> object is an easy way to ensure that the proper
object is passed through the initInstance process. This is an idiom that shows up in MITHgrid-based
projects.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">appFn = </span><span class="o">-&gt;</span> <span class="nx">app</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Running the application causes all of the DOM elements, presentations, and other components to be
instantiated. Once that is done, we proceed with adding the annotations view and hooking up the
controllers and events.</p>

<p><code>app.ready</code> does for the application what <code>$(document).ready</code> does for the DOM.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">app</span><span class="p">.</span><span class="nx">ready</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>We create a simple presentation of the annotations. This particular presentation type has a
base body lens that we can build from. We'll add edit controls next.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">annotations = </span><span class="nx">OAC</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">StreamingVideo</span><span class="p">.</span><span class="nx">Presentation</span><span class="p">.</span><span class="nx">AnnotationList</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&#39;#annotation-text&#39;</span><span class="p">,</span>
                        <span class="nv">dataView: </span><span class="nx">app</span><span class="p">.</span><span class="nx">dataView</span><span class="p">.</span><span class="nx">currentAnnotations</span>
                        <span class="nv">lensKey: </span><span class="p">[</span><span class="s">&#39;.bodyType&#39;</span><span class="p">]</span>
                        <span class="nv">application: </span><span class="nx">appFn</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>We use the TextControls component to create the controls we'll use for managing the text
annotation bodies. </p>

<p><strong>N.B.:</strong> Since we only have a single video in the demo, we can get away with
using an id-based container. If we wanted this to work for multiple videos, each with their
own text controls, we would need to based the container on something tied to the application.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">textControls = </span><span class="nx">OAC</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">StreamingVideo</span><span class="p">.</span><span class="nx">Demo</span><span class="p">.</span><span class="nx">TextControls</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">text-controls&quot;</span><span class="p">,</span>
                        <span class="nv">application: </span><span class="nx">appFn</span>
            </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>We want the text annotation list to focus on the Video Annotator's active
annotation, so we make sure any changes to the ActiveAnnotation variable
propagate to the annotations presentation.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">app</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onActiveAnnotationChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">annotations</span><span class="p">.</span><span class="nx">eventFocusChange</span>
                    </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Now we set up each of the actions that the text controls can generate.
Presentations track which rendering is currently in focus. For the Video Annotator
application, this is the same item as the ActiveAnnotation since we hooked
the presentation's focus to the application's ActiveAnnotation variable above.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">textControls</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onEdit</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">-&gt;</span>
                        <span class="nv">rendering = </span><span class="nx">annotations</span><span class="p">.</span><span class="nx">getFocusedRendering</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nx">rendering</span><span class="o">?</span>
                            <span class="nx">rendering</span><span class="p">.</span><span class="nx">eventEdit</span><span class="p">()</span>
                            
                    <span class="nx">textControls</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onDelete</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">-&gt;</span>
                        <span class="nv">rendering = </span><span class="nx">annotations</span><span class="p">.</span><span class="nx">getFocusedRendering</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nx">rendering</span><span class="o">?</span>
                            <span class="nx">rendering</span><span class="p">.</span><span class="nx">eventDelete</span><span class="p">()</span>
                            
                    <span class="nx">textControls</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onSave</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">-&gt;</span>
                        <span class="nv">rendering = </span><span class="nx">annotations</span><span class="p">.</span><span class="nx">getFocusedRendering</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nx">rendering</span><span class="o">?</span>
                            <span class="nx">rendering</span><span class="p">.</span><span class="nx">eventSave</span><span class="p">()</span>
                            
                    <span class="nx">textControls</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onCancel</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">-&gt;</span>
                        <span class="nv">rendering = </span><span class="nx">annotations</span><span class="p">.</span><span class="nx">getFocusedRendering</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nx">rendering</span><span class="o">?</span>
                            <span class="nx">rendering</span><span class="p">.</span><span class="nx">eventCancel</span><span class="p">()</span>
        
                    </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Now we add the meat of the annotation presentation: the body text rendering. In MITHgrid,
item templates are called Lenses. These lenses are functions that return a JavaScript
object with a number of properties. Check out the MITHgrid documentation for a list of
typical properties. Additional properties may be needed by certain presentations.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">annotations</span><span class="p">.</span><span class="nx">addLens</span> <span class="s">&quot;Text&quot;</span><span class="p">,</span> <span class="nf">(container, view, model, itemId) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>We start by calling the base text rendering from the annotation presentation. This
handles putting the text in the DOM and updating it when it changes.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nv">rendering = </span><span class="nx">annotations</span><span class="p">.</span><span class="nx">initTextLens</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">itemId</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Now we tie in the hover controller. The binding gives us a way to access the events
generated by the hover controller for this element.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nv">hoverBinding = </span><span class="nx">hoverController</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">rendering</span><span class="p">.</span><span class="nx">el</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>We use <code>inEditing</code> to track state so we know if we need to lock/unlock the ActiveAnnotation
variable among other changes.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nv">inEditing = </span><span class="kc">false</span>
                        </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>We go ahead and set up the editing elements for use later.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nv">textEl = </span><span class="nx">$</span><span class="p">(</span><span class="nx">rendering</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;.body-content&quot;</span><span class="p">)</span>
                        <span class="nv">inputEl = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;textarea&gt;&lt;/textarea&gt;&quot;</span><span class="p">)</span>
                        <span class="nx">rendering</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">inputEl</span><span class="p">)</span>
                        <span class="nx">inputEl</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>When we hover over the text annotation, we switch the active annotation to that item.
We don't worry about what happens when we 'unhover' (which would be the <code>unFocus</code> event). 
We keep the same active annotation.
Note that we don't check to see if we're editing. Nor do we do anything else that might
seem appropriate for changing focus (such as hiding the text controls or moving them to
the newly focused annotation). Instead, we allow those consequences to happen as the
change to ActiveAnnotation propagates. If we're editing, then the change won't happen
and we don't have to worry about the consequences.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">hoverBinding</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onFocus</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">-&gt;</span>
                            <span class="nx">app</span><span class="p">.</span><span class="nx">setActiveAnnotation</span> <span class="nx">itemId</span>
                        </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Now we want to handle showing the edit controls when this rendering is active.
We split this out from the above binding events focus/unfocus handling since
an annotation can become active from several different avenues.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nv">superFocus = </span><span class="nx">rendering</span><span class="p">.</span><span class="nx">eventFocus</span>
                        <span class="nv">superUnfocus = </span><span class="nx">rendering</span><span class="p">.</span><span class="nx">eventUnfocus</span>

                        <span class="nv">rendering.eventFocus = </span><span class="o">-&gt;</span>
                            <span class="nx">superFocus</span><span class="p">()</span>
                            <span class="nx">textControls</span><span class="p">.</span><span class="nx">eventMove</span> <span class="nx">$</span><span class="p">(</span><span class="nx">rendering</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">position</span><span class="p">().</span><span class="nx">top</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nx">rendering</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">position</span><span class="p">().</span><span class="nx">left</span>
                            <span class="nx">textControls</span><span class="p">.</span><span class="nx">eventShow</span><span class="p">()</span>

                        <span class="nv">rendering.eventUnfocus = </span><span class="o">-&gt;</span>
                            <span class="nx">textControls</span><span class="p">.</span><span class="nx">eventHide</span><span class="p">()</span>
                            <span class="nx">superUnfocus</span><span class="p">()</span>
                        </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>And now we add the rendering's handling of text control events.
We lock the ActiveAnnotation variable while we're editing so the controls don't
move to another annotation on us. This will keep the highlighted shape over the
video from changing as well. It won't keep the video from playing or the annotation
going out of scope. We leave as an exercise keeping the player from playing while
editing an annotation.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nv">rendering.eventEdit = </span><span class="o">-&gt;</span>
                            <span class="k">if</span> <span class="o">not</span> <span class="nx">inEditing</span>
                                <span class="nx">app</span><span class="p">.</span><span class="nx">lockActiveAnnotation</span><span class="p">()</span>
                                <span class="nv">inEditing = </span><span class="kc">true</span>
                                <span class="nv">text = </span><span class="nx">textEl</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
                                <span class="nx">textEl</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
                                <span class="nx">inputEl</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>
                                <span class="nx">inputEl</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>                           
                        </pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Note that we don't allow the text annotation to trigger a deletion of the annotation from
the MITHgrid data store unless we're not in editing mode. There are other ways to remove
the annotation from the data store.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nv">superDelete = </span><span class="nx">rendering</span><span class="p">.</span><span class="nx">eventDelete</span>
                        <span class="nv">rendering.eventDelete = </span><span class="o">-&gt;</span>
                            <span class="k">if</span> <span class="o">not</span> <span class="nx">inEditing</span>
                                <span class="nx">superDelete</span><span class="p">()</span>
                            
                        <span class="nv">rendering.eventCancel = </span><span class="o">-&gt;</span>
                            <span class="k">if</span> <span class="nx">inEditing</span>
                                <span class="nx">app</span><span class="p">.</span><span class="nx">unlockActiveAnnotation</span><span class="p">()</span>
                                <span class="nv">inEditing = </span><span class="kc">false</span>
                                <span class="nx">textEl</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>
                                <span class="nx">inputEl</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>

                        <span class="nv">rendering.eventSave = </span><span class="o">-&gt;</span>
                            <span class="k">if</span> <span class="nx">inEditing</span>
                                <span class="nx">app</span><span class="p">.</span><span class="nx">unlockActiveAnnotation</span><span class="p">()</span>
                                <span class="nv">inEditing = </span><span class="kc">false</span>
                                <span class="nx">textEl</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>
                                <span class="nx">rendering</span><span class="p">.</span><span class="nx">eventUpdate</span> <span class="nx">inputEl</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
                                <span class="nx">inputEl</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>

                        <span class="nx">rendering</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>We now tie together the mode buttons in the Tools area with the Video Annotator
CurrentMode variable.</p>

<p>A better way to do this might be to have a generic modal button component that
fires an event with the mode name. We would then hook that event to the application
setCurrentMode method to change the application's mode.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">OAC</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">StreamingVideo</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">ModeButton</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">modeRectangle&quot;</span><span class="p">,</span>
                        <span class="nv">mode: </span><span class="s">&quot;Rectangle&quot;</span>
                        <span class="nv">application: </span><span class="nx">appFn</span>

                    <span class="nx">OAC</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">StreamingVideo</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">ModeButton</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">modeEllipse&quot;</span><span class="p">,</span>
                        <span class="nv">mode: </span><span class="s">&quot;Ellipse&quot;</span>
                        <span class="nv">application: </span><span class="nx">appFn</span>

                    <span class="nx">OAC</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">StreamingVideo</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">ModeButton</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">modeSelect&quot;</span><span class="p">,</span>
                        <span class="nv">mode: </span><span class="s">&quot;Select&quot;</span>
                        <span class="nv">application: </span><span class="nx">appFn</span>

                    <span class="nx">OAC</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">StreamingVideo</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">ModeButton</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">modeWatch&quot;</span><span class="p">,</span>
                        <span class="nv">mode: </span><span class="s">&quot;Watch&quot;</span>
                        <span class="nv">application: </span><span class="nx">appFn</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>We finish out by tying in the import/export functions. We aren't using any MITHgrid-style
controllers for this.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">select-button&quot;</span><span class="p">).</span><span class="nx">click</span> <span class="o">-&gt;</span>
                        <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">export-text&quot;</span><span class="p">).</span><span class="nx">focus</span><span class="p">()</span>
                        <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">export-text&quot;</span><span class="p">).</span><span class="nx">select</span><span class="p">()</span>
                        
                    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">export-button&quot;</span><span class="p">).</span><span class="nx">click</span> <span class="o">-&gt;</span>
                        <span class="nv">data = </span><span class="nx">app</span><span class="p">.</span><span class="nx">exportData</span><span class="p">()</span>
                        <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">export-text&quot;</span><span class="p">).</span><span class="nx">val</span> <span class="nx">jsl</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">formatJson</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">data</span>

                    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">import-button&quot;</span><span class="p">).</span><span class="nx">click</span> <span class="o">-&gt;</span>
                        <span class="nv">str = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">export-text&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nx">str</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span>
                            <span class="nx">app</span><span class="p">.</span><span class="nx">importData</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">str</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div>
