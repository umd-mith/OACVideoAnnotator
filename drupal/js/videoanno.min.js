// Generated by CoffeeScript 1.6.3
/*
# OAC Video Annotation Tool v0.132590
# 
# The **OAC Video Annotation Tool** is a MITHgrid application providing annotation capabilities for streaming
# video embedded in a web page. 
#  
# Date: Thu Aug 29 14:16:14 2013 -0400
#  
# Educational Community License, Version 2.0
# 
# Copyright 2011 University of Maryland. Licensed under the Educational
# Community License, Version 2.0 (the "License"); you may not use this file
# except in compliance with the License. You may obtain a copy of the License at
# 
# http:#www.osedu.org/licenses/ECL-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under
# the License.
#
# Author: Grant Dickie
*/
(function(){var a,b=[].slice,c=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};a=MITHgrid.globalNamespace("OAC"),a.namespace("Client"),a.Client.namespace("StreamingVideo"),function(a,d,e){e.Client.StreamingVideo.namespace("Controller",function(c){var e;e=function(b,c){var d;d=a(b).offset();return{x:c.pageX-d.left,y:c.pageY-d.top}},c.namespace("Drag",function(a){return a.initInstance=function(){var a,c;a=1<=arguments.length?b.call(arguments,0):[];return(c=d.Controller.Raphael).initInstance.apply(c,["OAC.Client.StreamingVideo.Controller.Drag"].concat(b.call(a),[function(a){a.applyBindings=function(a){var b,c,d,f;f=a.locate("raphael"),d=function(b,c,d){var g;g=e(f.node,d),g.x+=f.attr("x"),g.y+=f.attr("y");return a.events.onFocus.fire(g.x,g.y)},b=function(){return a.events.onUnfocus.fire()},c=function(b,c){return a.events.onUpdate.fire(b,c)};return f.drag(c,d,b)};return a.removeBindings=function(a){var b;b=a.locate("raphael");return b.undrag}}]))}}),c.namespace("Select",function(a){return a.initInstance=function(){var a,c;a=1<=arguments.length?b.call(arguments,0):[];return(c=d.Controller.Raphael).initInstance.apply(c,["OAC.Client.StreamingVideo.Controller.Select"].concat(b.call(a),[function(a){var b,c;c=a.options,b=c.isSelectable||function(){return!0};return a.applyBindings=function(a){var c;c=a.locate("raphael");return c.click(function(c){if(b())return a.events.onSelect.fire()})}}]))}});return c.namespace("CanvasClickController",function(c){return c.initInstance=function(){var c,f;c=1<=arguments.length?b.call(arguments,0):[];return(f=d.Controller).initInstance.apply(f,["OAC.Client.StreamingVideo.Controller.CanvasClickController"].concat(b.call(c),[function(b){var c,f;c=b.options,f=null;return b.applyBindings=function(b,g){var h,i,j,k,l,m,n,o,p,q;n={},l=g.paper,p=b.locate("svgwrapper"),i=function(){m(),f=l.rect(0,0,l.width,l.height),f.toFront(),f.attr({fill:"#ffffff",opacity:.01});return a(f.node).css({"pointer-events":"auto"})},m=function(){f!=null&&(f.unmousedown(),f.unmouseup(),f.unmousemove(),f.attr({opacity:0}),f.remove(),f=null);return q()},k=!1,h=function(a){if(!k){k=!0;return d.mouse.capture(function(b){if(a[b]!=null)return a[b](this)})}},q=function(){if(k){d.mouse.uncapture();return k=!1}},j=function(a){var c,d,g,j,l,m;d=!1,k=!1,m=[],c=[],i(),f.unmousedown(),f.unmouseup(),f.unmousemove(),g=function(a){var g,h,i;if(!d){g=e(f.node,a),h=g.x,i=g.y,m=[h,i],c=[h,i],d=!0;return b.events.onShapeStart.fire(m)}},j=function(a){var g,h,i;if(!!d){g=e(f.node,a),h=g.x,i=g.y,c=[h,i];return b.events.onShapeDrag.fire(c)}},l=function(a){if(!!d){d=!1,b.events.onShapeDone.fire(c),q();return f.toFront()}},f.mousedown(g),f.mousemove(j),f.mouseup(l);return h({mousedown:g,mouseup:l,mousemove:j})},o=function(a){i(),f.unmousedown(),f.mousedown(function(){var a;c.application().setActiveAnnotation(void 0),a=null;return f.toBack()});return f.toBack()},c.application().events.onCurrentModeChange.addListener(function(b){m();switch(c.application().getCurrentModeClass()){case"shape":return j(p);case"select":return o(p);default:return a(p).unbind()}});return b.toBack=function(){if(f!=null)return f.toBack()}}}]))}})}),e.Client.StreamingVideo.namespace("Player",function(c){var e,f,g,h;h=[],c.player=function(a){a==null&&(a=0);return h[a]},c.onNewPlayer=d.initEventFirer(!1,!1,!0),e=[],g={},f={},c.onNewPlayer.addListener(function(a){return h.push(a)}),c.register=function(a,b){return e.push([a,b])},a(document).ready(function(){var b,d,h;c.register=function(b,d){var e,h,i,j,k,l,m,n,o,p,q;i={},d(i),f[b]={bindPlayer:function(b){var d;if(a(b).data("driver")!==i){a(b).data("driver",i),d=i.bindPlayer(b),d.container=b;return c.onNewPlayer.fire(d)}}},h=f[b].bindPlayer;if(g[b]!=null){o=g[b];for(k=0,m=o.length;k<m;k++)j=o[k],e=h(j),e.container=j;delete g[b]}p=i.getAvailablePlayers(),q=[];for(l=0,n=p.length;l<n;l++)j=p[l],e=h(j),q.push(e.container=j);return q};for(d=0,h=e.length;d<h;d++)b=e[d],c.register(b[0],b[1]);return e=null}),c.driver=function(a){return f[a]},c.addPlayer=function(a,b){var c;if(f[a]!=null){c=f[a].bindPlayer(b),c.container=b;return c}g[a]==null&&(g[a]=[]);return g[a].push(b)};return c.namespace("DriverBinding",function(a){return a.initInstance=function(){var a;a=1<=arguments.length?b.call(arguments,0):[];return d.initInstance.apply(d,["OAC.Client.StreamingVideo.Player.DriverBinding"].concat(b.call(a)))}})}),e.Client.StreamingVideo.Player.register("Dummy",function(b){var c;b.getAvailablePlayers=function(){var b,d,e,f,g,h,i;b=0,h=a(".dummyplayer"),i=[];for(f=0,g=h.length;f<g;f++)d=h[f],e=a(d).data("player"),e==null&&(e=c(d,b),a(d).data("player",e),e.startDummyPlayer()),b+=1,i.push(e);return i},b.getOACVersion=function(){return"1.0"},b.bindPlayer=function(a){return e.Client.StreamingVideo.Player.DriverBinding.initInstance(function(b){a.onplayheadupdate(function(){return b.events.onPlayheadUpdate.fire(b.getPlayhead())}),b.getCoordinates=function(){var b,c,d,e,f;e=a.getcoordinates(),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(parseInt(b,10));return f},b.getSize=function(){var b,c,d,e,f;e=a.getsize(),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(parseInt(b,10));return f},b.getTargetURI=a.getTargetURI,b.play=a.play,b.pause=a.pause,b.getPlayhead=a.getplayhead;return b.setPlayhead=a.setplayhead})};return c=function(b,c){var d;d={},d.getTargetURI=function(){return a(b).data("oatarget")},d.startDummyPlayer=function(){d.setAspect(),d.setContent(),d.play();return window.setTimeout(d.secondIntervalUpdate,1e3)},d.setAspect=function(){a(b).css("background",'url("dummyplayer/images/dummy.png") no-repeat scroll right bottom #F8C700');return a(b).css("border","1px solid darkBlue")},d.setContent=function(){var d;d="$('#player-content-"+c+"').parents('.dummyplayer').data('player')";return a(b).append('<ul id="player-content-'+c+'" style="list-style-type: none; padding: 0;">\n  <li style="text-align: center; font-weight: bold; text-decoration: underline;">Dummy Player #'+(c+1)+'</li>\n  <li style="text-align: center;">Status: <span class="dummy-status">Paused</span></li>\n  <li style="text-align: center;">Position: <span class="dummy-position">0</span> seconds</li>\n  <!-- li style="text-align: center;">\n    <ul style="list-style-type: none; padding: 0;">\n      <li style="margin: 0 8px; display: inline;">\n        <a onClick="'+d+'.rewind(5)"><img src="dummyplayer/images/rewind.png" /></a>\n      </li>\n      <li style="margin: 0 8px; display: inline;">\n        <a onClick="'+d+'.toggle()"><img src="dummyplayer/images/playpause.png" /></a>\n      </li>\n      <li style="margin: 0 8px; display: inline;">\n        <a onClick="'+d+'.forward(5)"><img src="dummyplayer/images/forward.png" /></a>\n      </li>\n    </ul>\n  </li -->\n</ul>')},d.secondIntervalUpdate=function(){window.setTimeout(d.secondIntervalUpdate,1e3);if(a(b).find(".dummy-status").html()==="Playing")return d.forward(1)},d.toggle=function(){return a(b).find(".dummy-status").html()==="Playing"?d.pause():d.play()},d.pause=function(){return a(b).find(".dummy-status").html("Paused")},d.play=function(){return a(b).find(".dummy-status").html("Playing")},d.rewind=function(a){return d.setplayhead(d.getplayhead()-parseInt(a,10))},d.forward=function(a){return d.setplayhead(d.getplayhead()+parseInt(a,10))},d.setplayhead=function(c){c=parseInt(c,10),c<0&&(c=0),a(b).find(".dummy-position").html(c);return a(b).trigger("timeupdate")},d.getplayhead=function(){return parseInt(a(b).find(".dummy-position").html(),10)},d.getsize=function(){var b;b=[],b.push(parseInt(a("#player-content-"+c).parents(".dummyplayer").css("width"),10)),b.push(parseInt(a("#player-content-"+c).parents(".dummyplayer").css("height"),10));return b},d.getcoordinates=function(){var b;b=[],b.push(a("#player-content-"+c).parents(".dummyplayer").position().top),b.push(a("#player-content-"+c).parents(".dummyplayer").position().left);return b},d.onplayheadupdate=function(c){return a(b).bind("timeupdate",c)};return d}}),e.Client.StreamingVideo.Player.register("HTML5",function(b){b.getAvailablePlayers=function(){return a("video")},b.getOACVersion=function(){return"1.0"};return b.bindPlayer=function(b){return e.Client.StreamingVideo.Player.DriverBinding.initInstance(function(c){var d,e;a(b).bind("loadedmetadata",function(){return c.events.onResize.fire(c.getSize())}),a(b).bind("loadeddata",function(){return c.events.onResize.fire(c.getSize())}),e=0,d=!1,a(b).bind("timeupdate",function(){var a;a=b.currentTime;if(Math.abs(e-a)>=.1||a<.1){e=a,d=!0;return c.events.onPlayheadUpdate.fire(a)}}),c.getCoordinates=function(){return[a(b).offset().left,a(b).offset().top]},c.getSize=function(){return[a(b).width(),a(b).height()]},c.getTargetURI=function(){return a(b).data("oatarget")},c.play=function(){return b.play()},c.pause=function(){return b.pause()},c.getPlayhead=function(){return b.currentTime};return c.setPlayhead=function(a){return d?d=!1:b.currentTime=parseFloat(a)}})}}),e.Client.StreamingVideo.namespace("Component",function(c){c.namespace("ModeButton",function(c){return c.initInstance=function(){var c;c=1<=arguments.length?b.call(arguments,0):[];return d.initInstance.apply(d,["OAC.Client.StreamingVideo.Component.ModeButton"].concat(b.call(c),[function(b,c){var d,e;e=b.options,d=e.application(),a(c).mousedown(function(){return a(c).hasClass("active")?d.setCurrentMode(null):d.setCurrentMode(e.mode)});return d.events.onCurrentModeChange.addListener(function(b){return b===e.mode?a(c).addClass("active"):a(c).removeClass("active")})}]))}}),c.namespace("ShapeEditBox",function(c){var f;f=null;return c.initInstance=function(){var c;c=1<=arguments.length?b.call(arguments,0):[],f==null&&(f=e.Client.StreamingVideo.Controller.Drag.initInstance({}));return d.initInstance.apply(d,["OAC.Client.StreamingVideo.Component.ShapeEditBox"].concat(b.call(c),[function(b,c){var d,e,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;t=b.options,p=null,r={},d=null,e={},u={},n={},l={},m={},v=null,s=null,q=5,j=t.dirs,o={ul:["nw",0,0],top:["n",1,0],ur:["ne",2,0],rgt:["e",2,1],lr:["se",2,2],btm:["s",1,2],ll:["sw",0,2],lft:["w",0,1],mid:["pointer",1,1]},i=function(a){var b,c,d,e;b=a.brx,d=a.tlx,c=a.bry,e=a.tly,m.x===0&&m.y===0?(d+=a.dx,b+=a.dx,e+=a.dy,c+=a.dy):(m.x<0?d+=a.dx:m.x>0&&(b+=a.dx),m.y<0?e+=a.dy:m.y>0&&(c+=a.dy)),b>d?a.x=d:a.x=b,c>e?a.y=e:a.y=c,a.width=Math.abs(b-d),a.height=Math.abs(c-e);return a},h=function(a){var b,c,d,e,f,g,h;i(a),b=function(b,c,d){return{x:a.x+c*a.width/2-q/2,y:a.y+d*a.height/2-q/2,cursor:b.length>2?b:b+"-resize"}},e=function(b,c,d){b.x=a.x+c*a.width/2-q/2,b.y=a.y+d*a.height/2-q/2;return b.el.attr({x:b.x,y:b.y})},h=[];for(f=0,g=j.length;f<g;f++)d=j[f],c=o[d],c!=null?r[d]!=null?h.push(e(r[d],c[1],c[2])):h.push(r[d]=b(c[0],c[1],c[2])):h.push(void 0);return h},g=function(){l=d.getExtents(),e={tlx:l.x-l.width/2,tly:l.y-l.height/2,brx:l.x+l.width/2,bry:l.y+l.height/2,dx:0,dy:0};return h(e)},k=function(){var j,k,n,o;if(p==null){p=c.set();for(k in r)o=r[k],k==="mid"?(s=c.rect(o.x,o.y,q,q),a(s.node).css({"pointer-events":"auto"}),o.id=s.id,o.el=s):(j=c.rect(o.x,o.y,q,q),a(j.node).css({"pointer-events":"auto"}),o.id=j.id,o.el=j,j.attr({cursor:o.cursor}),p.push(j));p.attr({fill:"black",stroke:"black"}),a.isEmptyObject(s)||s.attr({fill:"black",stroke:"black",cursor:"move"}),i(e),v=c.rect(e.x,e.y,e.width,e.height),v.attr({stroke:"#333333","stroke-dasharray":["--"]}),s!=null&&(n=f.bind(s),n.events.onUpdate.addListener(function(a,b){e.dx=a,e.dy=b,h(e);return v.attr({x:e.x,y:e.y})}),n.events.onFocus.addListener(function(a,c){b.events.onFocus.fire(),m.x=0,m.y=0,g();return d.shape.attr({cursor:"move"})}),n.events.onUnfocus.addListener(function(){i(e),b.events.onMove.fire({x:e.x+e.width/2,y:e.y+e.height/2});return b.events.onUnfocus.fire()}));return p.forEach(function(a){var c;c=f.bind(a),c.events.onUpdate.addListener(function(a,b){e.dx=a,e.dy=b,h(e);return v.attr({x:e.x,y:e.y,width:e.width,height:e.height})}),c.events.onFocus.addListener(function(a,c){var e,f;l=d.getExtents(),b.events.onFocus.fire(),e=8*(a-l.x)/l.width+4,f=8*(c-l.y)/l.height+4,e<3?m.x=-1:e<5?m.x=0:m.x=1,f<3?m.y=-1:f<5?m.y=0:m.y=1;return g()}),c.events.onUnfocus.addListener(function(){i(e),b.events.onResize.fire({x:e.x+e.width/2,y:e.y+e.height/2,width:e.width,height:e.height});return b.events.onUnfocus.fire()}),v.toFront(),p.toFront();return s.toFront()})}v.show().toFront(),v.attr({x:e.x,y:e.y,width:e.width,height:e.height}),p.show().toFront();return s.show().toFront()},b.show=function(){g();return k()},b.hide=function(){if(!a.isEmptyObject(p)){p.hide(),v.hide();return s.hide()}},b.attachToRendering=function(a){b.detachFromRendering();if(a!=null){d=a;return b.show()}};return b.detachFromRendering=function(){d=null;return b.hide()}}]))}});return c.namespace("ShapeCreateBox",function(a){return a.initInstance=function(){var a;a=1<=arguments.length?b.call(arguments,0):[];return d.initInstance.apply(d,["OAC.Client.StreamingVideo.Component.ShapeCreateBox"].concat(b.call(a),[function(a,b){var c,d,e,f,g;e=a.options,g=null,d={},c={},f={},a.createGuide=function(a){c.x=a[0],c.y=a[1],c.width=0,c.height=0;if(g==null){g=b.rect(c.x,c.y,c.width,c.height);return g.attr({stroke:"#333333","stroke-dasharray":["--"]})}g.show();return g.attr({x:c.x,y:c.y,width:c.width,height:c.height})},a.resizeGuide=function(a){c.width=a[0]-c.x,c.height=a[1]-c.y;return c.width<0?c.height<0?g.attr({width:-c.width,height:-c.height,x:c.x+c.width,y:c.y+c.height}):g.attr({width:-c.width,height:c.height,x:c.x+c.width,y:c.y}):c.height<0?g.attr({width:c.width,height:-c.height,x:c.x,y:c.y+c.height}):g.attr({width:c.width,height:c.height,x:c.x,y:c.y})};return a.completeShape=function(b){a.resizeGuide(b),g.hide(),c.width<0&&(c.x+=c.width,c.width=-c.width),c.height<0&&(c.y+=c.height,c.height=-c.height);return{x:c.x,y:c.y,width:c.width,height:c.height}}}]))}})}),e.Client.StreamingVideo.namespace("Presentation",function(c){c.namespace("AnnotationList",function(c){return c.initInstance=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Presentation).initInstance.apply(e,["OAC.Client.StreamingVideo.Presentation.AnnotationList"].concat(b.call(c),[function(b,c){var d,e;e=b.options,d=e.application();return b.initTextLens=function(b,c,d,e,f){var g,h,i,j;j={},h=d.getItem(e),i=a('<div class="annotation-body">\n  <div class="annotation-body-text">\n    <div class="body-content">\n    </div>\n  </div>\n</div>'),g=a(i).find(".body-content"),a(g).text(h.bodyContent[0]),j.el=i,a(b).append(i),j.eventFocus=function(){return i.addClass("selected")},j.eventUnfocus=function(){return i.removeClass("selected")},j.eventUpdate=function(a){return d.updateItems([{id:e,bodyContent:a}])},j.eventDelete=function(){return d.removeItems([e])},j.update=function(b){return a(g).text(b.bodyContent[0])},j.remove=function(){return a(i).remove()},f!=null&&f(j);return j}}]))}});return c.namespace("RaphaelCanvas",function(c){var f;f=1;return c.initInstance=function(){var c,g;c=1<=arguments.length?b.call(arguments,0):[];return(g=d.Presentation).initInstance.apply(g,["OAC.StreamingVideo.Client.Presentation.RaphaelCanvas"].concat(b.call(c),[function(b,c){var g,h,i,j,k,l,m,n,o,p,q;c==null?(k="oac-raphael-presentation-canvas-"+f,f+=1,c=a("<div id='"+k+"'></div>"),a("body").append(c)):(k=a(c).attr("id"),k==null&&(k="oac-raphael-presentation-canvas-"+f,f+=1,a(c).attr({id:k}))),l=b.options,g=l.application(),n={width:0,height:0},j=l.controllers.canvas,b.canvas=new Raphael(a(c),10,10),a(b.canvas.canvas).css({"pointer-events":"none"}),i=j.bind(a(c),{closeEnough:5,paper:b.canvas}),h=e.Client.StreamingVideo.Component.ShapeEditBox.initInstance(b.canvas),o=e.Client.StreamingVideo.Component.ShapeCreateBox.initInstance(b.canvas),h.events.onResize.addListener(function(a){var c;c=b.getFocusedRendering();if(c!=null&&c.eventResize!=null)return c.eventResize(a)}),h.events.onMove.addListener(function(a){var c;c=b.getFocusedRendering();if(c!=null&&c.eventMove!=null)return c.eventMove(a)}),h.events.onDelete.addListener(function(){var a;a=b.getFocusedRendering();if(a!=null&&a.eventDelete!=null){a.eventDelete();return h.detachFromRendering()}}),g.events.onCurrentModeChange.addListener(function(a){var c;if(g.getCurrentModeClass()!=="select")return h.detachFromRendering();c=b.getFocusedRendering();if(c!=null)return h.attachToRendering(c)}),m=g.getPlayer(),q=function(){var c,d,e,f,g,h;if(m!=null){g=m.getCoordinates(),e=g[0],f=g[1],h=m.getSize(),d=h[0],c=h[1],n={width:d,height:c},a(b.canvas.canvas).css({left:e+"px",top:f+"px"});return b.canvas.setSize(d,c)}},d.events.onWindowResize.addListener(q),m!=null&&m.events.onResize.addListener(q),q(),i.events.onShapeStart.addListener(o.createGuide),i.events.onShapeDrag.addListener(o.resizeGuide),i.events.onShapeDone.addListener(function(a){var b;b=o.completeShape(a);if(b.height>1&&b.width>1){b.shapeType=g.getCurrentMode();return g.insertAnnotation(b)}}),g.events.onCurrentTimeChange.addListener(function(a){return b.visitRenderings(function(b,c){if(c.eventCurrentTimeChange!=null)return c.eventCurrentTimeChange(a)})}),g.events.onTimeEasementChange.addListener(function(a){return b.visitRenderings(function(b,c){if(c.eventTimeEasementChange!=null)return c.eventTimeEasementChange(a)})}),p=b.eventFocusChange,b.eventFocusChange=function(a){p(a);if(g.getCurrentMode()==="Select"){h.attachToRendering(b.getFocusedRendering());if(i!=null)return i.toBack()}};return b.initShapeLens=function(a,b,c,d,e){var f,h,i,j,k,l,m,o,p;m={id:d},l=c.getItem(d),j=!1,p=l.npt_start[0],h=l.npt_end[0],k=p-g.getTimeEasement(),i=h+g.getTimeEasement(),f=function(a){var b,c;c=0,a>=k&&a<i&&(b=g.getTimeEasement(),b>0?a<p?c=(b-p+a)/b:a>h?c=(b+h-a)/b:c=1:c=1);return c},m.scalePoint=function(a,b,c,d){c!=null&&c[0]!=null?c=c[0]:c=n.width,d!=null&&d[0]!=null?d=d[0]:d=n.height;return c===0||d===0?[a,b]:[a*n.width/c,b*n.height/d]},m.eventTimeEasementChange=function(a){k=p-a,i=h+a;return m.setOpacity(f(g.getCurrentTime()))},m.eventCurrentTimeChange=function(a){return m.setOpacity(f(a))},o=0,m.setOpacity=function(a){a!=null&&(o=a);if(m.shape!=null)return m.shape.attr({opacity:(j?.5:.25)*o})},m.getOpacity=function(){return o},m.setOpacity(f(g.getCurrentTime())),m.eventFocus=function(){j=!0,m.setOpacity();if(m.shape!=null)return m.shape.toFront()},m.eventUnfocus=function(){j=!1,m.setOpacity();if(m.shape!=null)return m.shape.toBack()},m.eventDelete=function(){return c.removeItems([d])},m.eventResize=function(a){return c.updateItems([{id:d,x:a.x,y:a.y,w:a.width,h:a.height,targetWidth:n.width,targetHeight:n.height}])},m.eventMove=function(a){return c.updateItems([{id:d,x:a.x,y:a.y}])},m.update=function(a){if(a.npt_start[0]!==p||a.npt_end[0]!==h){p=a.npt_start[0],h=a.npt_end[0],k=p-g.getTimeEasement(),i=h+g.getTimeEasement();return m.setOpacity(f(g.getCurrentTime()))}},m.remove=function(a){m.shape!=null&&(m.shape.remove(),m.shape=null);if(g.getActiveAnnotation()===d)return g.setActiveAnnotation(null)},e!=null&&e(m);return m}}]))}})});return e.Client.StreamingVideo.namespace("Application",function(e){var f,g;f=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},g=function(){return f()+f()+"-"+f()+"-"+f()+"-"+f()+"-"+f()+f()+f()};return e.initInstance=function(){var e,f,h;f=1<=arguments.length?b.call(arguments,0):[];return e=(h=d.Application).initInstance.apply(h,["OAC.Client.StreamingVideo.Application"].concat(b.call(f),[{controllers:{selectShape:{isSelectable:function(){return e.getCurrentMode()==="Select"}}}}],[function(b){var d,e,f,h,i,j,k,l,m,n;k={},i={},j=0,m=[],l=[],e=b.options,h=e.player,e.url==null&&(e.url=h.getTargetURI()),h!=null&&(n=h.getSize(),i.width=n[0],i.height=n[1],h.events.onResize.addListener(function(a){return i.width=a[0],i.height=a[1],a})),b.getPlayer=function(){return h},b.ready(function(){return b.initShapeLens=b.presentation.raphsvg.initShapeLens}),b.getCurrentModeClass=function(){var a;a=b.getCurrentMode();if(k[a]!=null)return"shape";switch(a){case"Select":return"select";case"Watch":return"video";default:return null}},b.addShapeType=function(a,c){return b.ready(function(){k[a]=c;return b.presentation.raphsvg.addLens(a,c.lens)})},b.addBodyType=function(a,b){return bodyTypes[a]=b},b.insertAnnotation=function(a){var c,d,e,f;e=a.npt_start!=null?a.npt_start:parseFloat(b.getCurrentTime())-5,d=a.npt_end!=null?a.npt_end:parseFloat(b.getCurrentTime())+5,c=a.shapeType!=null?a.shapeType:b.getCurrentMode();if(k[c]!=null){f=k[c].calc!=null?k[c].calc(a):{},j=g(),f.id="_:anno"+j,f.type="Annotation",f.bodyType="Text",f.bodyContent="This is an annotation for "+c,f.shapeType=c,f.targetURI=b.options.url,f.targetHeight=i.height,f.targetWidth=i.width,f.npt_start=e<0?0:e,f.npt_end=d,f.x=a.x+a.width/2,f.y=a.y+a.height/2,f.w=a.width,f.h=a.height,b.dataStore.canvas.loadItems([f]),b.setActiveAnnotation(f.id);return f.id}},d={OA:"http://www.w3.org/ns/oa#",RDF:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",CNT:"http://www.w3.org/2011/content#",DC:"http://purl.org/dc/elements/1.1/",DCTERMS:"http://purl.org/dc/terms/",DCTYPES:"http://purl.org/dc/dcmitype/",EXIF:"http://www.w3.org/2003/12/exif/ns#"},f=function(a){var b,c,d,e,f;a.indexOf(":")===-1?(f=parseFloat(a),e=0,d=0):(c=function(){var c,d,e,f;e=a.split(":"),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(parseFloat(b));return f}(),f=c.pop(),c.length>0?e=c.pop():e=0,c.length>0?d=c.pop():d=0);return(d*60+e)*60+f},b.importData=function(g){var h,i,j,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O;y=[];for(p in g){r=g[p];if(H=""+d.OA+"Annotation",c.call(function(){var a,b,c,e;c=r[""+d.RDF+"type"],e=[];for(a=0,b=c.length;a<b;a++)w=c[a],e.push(w.value);return e}(),H)>=0){x={id:p,type:"Annotation",bodyContent:"",bodyType:"Text",targetURI:e.url},r[""+d.OA+"hasBody"]!=null&&r[""+d.OA+"hasBody"][0]!=null&&g[r[""+d.OA+"hasBody"][0].value]!=null&&(x.bodyContent=g[r[""+d.OA+"hasBody"][0].value][""+d.CNT+"chars"][0].value);if(r[""+d.OA+"hasTarget"]!=null){I=function(){var a,b,c,e;c=r[""+d.OA+"hasTarget"],e=[];for(a=0,b=c.length;a<b;a++)A=c[a],e.push(A.value);return e}();for(B=0,E=I.length;B<E;B++){o=I[B];if(g[o]!=null&&g[o][""+d.OA+"hasSource"]!=null)if(J=e.url,c.call(function(){var a,b,c,e;c=g[o][""+d.OA+"hasSource"],e=[];for(a=0,b=c.length;a<b;a++)t=c[a],e.push(t.value);return e}(),J)>=0){K=function(){var a,b,c,e;c=g[o][""+d.OA+"hasSelector"],e=[];for(a=0,b=c.length;a<b;a++)A=c[a],e.push(A.value);return e}();for(C=0,F=K.length;C<F;C++){m=K[C];if(g[m]!=null&&(L=""+d.OA+"Composite",c.call(function(){var a,b,c,e;c=g[m][""+d.RDF+"type"],e=[];for(a=0,b=c.length;a<b;a++)w=c[a],e.push(w.value);return e}(),L)>=0)){M=function(){var a,b,c,e;c=g[m][""+d.OA+"item"],e=[];for(a=0,b=c.length;a<b;a++)A=c[a],e.push(A.value);return e}();for(D=0,G=M.length;D<G;D++){n=M[D];if(g[n]!=null){z=function(){var a,b,c,e;c=g[n][""+d.RDF+"type"],e=[];for(a=0,b=c.length;a<b;a++)w=c[a],e.push(w.value);return e}();if(N=""+d.OA+"SvgSelector",c.call(z,N)>=0)if(g[n][""+d.CNT+"chars"]!=null&&g[n][""+d.CNT+"chars"][0]!=null){v=g[n][""+d.CNT+"chars"][0].value,j=a.parseXML(v);if(j!=null){i=j.documentElement,s=i.nodeName;for(w in k)q=k[w],q.extractFromSVG!=null&&c.call(q.rootSVGElement,s)>=0&&(u=q.extractFromSVG(i),u!=null&&(a.extend(x,u),x.shapeType=w,g[n][""+d.EXIF+"width"]!=null&&g[n][""+d.EXIF+"width"][0]!=null&&(x.targetWidth=parseFloat(g[n][""+d.EXIF+"width"][0].value)),g[n][""+d.EXIF+"height"]!=null&&g[n][""+d.EXIF+"height"][0]!=null&&(x.targetHeight=parseFloat(g[n][""+d.EXIF+"height"][0].value))))}}(O=""+d.OA+"FragmentSelector",c.call(z,O)>=0)&&g[n][""+d.RDF+"value"]!=null&&g[n][""+d.RDF+"value"][0]!=null&&(l=g[n][""+d.RDF+"value"][0].value,l=l.replace(/^t=npt:/,""),h=l.split(","),x.npt_start=f(h[0]),x.npt_end=f(h[1]))}}}}}}}(x.npt_start!=null||x.npt_end!=null||x.shapeType!=null)&&y.push(x)}}return b.dataStore.canvas.loadItems(y)},b.importJSONLD=function(g,h){if(typeof jsonld!="undefined"&&jsonld!==null)return jsonld.expand(g,{keepFreeFloatingNodes:!0},function(g,i,j){if(g!=null||i==null)return h(g,i);return jsonld.compact(i,{oa:"http://www.w3.org/ns/oa#",cnt:"http://www.w3.org/2011/content#",dc:"http://purl.org/dc/elements/1.1/",dcterms:"http://purl.org/dc/terms/",dctypes:"http://purl.org/dc/dcmitype/",foaf:"http://xmlns.com/foaf/0.1/",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",rdfs:"http://www.w3.org/2000/01/rdf-schema#",skos:"http://www.w3.org/2004/02/skos/core#",hasBody:{"@type":"@id","@id":"oa:hasBody"},hasTarget:{"@type":"@id","@id":"oa:hasTarget"},hasSource:{"@type":"@id","@id":"oa:hasSource"},hasSelector:{"@type":"@id","@id":"oa:hasSelector"},hasState:{"@type":"@id","@id":"oa:hasState"},hasScope:{"@type":"@id","@id":"oa:hasScope"},annotatedBy:{"@type":"@id","@id":"oa:annotatedBy"},serializedBy:{"@type":"@id","@id":"oa:serializedBy"},motivatedBy:{"@type":"@id","@id":"oa:motivatedBy"},equivalentTo:{"@type":"@id","@id":"oa:equivalentTo"},styledBy:{"@type":"@id","@id":"oa:styledBy"},cachedSource:{"@type":"@id","@id":"oa:cachedSource"},conformsTo:{"@type":"@id","@id":"dcterms:conformsTo"},"default":{"@type":"@id","@id":"oa:default"},item:{"@type":"@id","@id":"oa:item"},first:{"@type":"@id","@id":"rdf:first"},rest:{"@type":"@id","@id":"rdf:rest","@container":"@list"},chars:"cnt:chars",bytes:"cnt:bytes",format:"dc:format",annotatedAt:"oa:annotatedAt",serializedAt:"oa:serializedAt",when:"oa:when",value:"rdf:value",start:"oa:start",end:"oa:end",exact:"oa:exact",prefix:"oa:prefix",suffix:"oa:suffix",label:"rdfs:label",name:"foaf:name",mbox:"foaf:mbox",styleClass:"oa:styleClass",exif:d.EXIF},function(d,g){var i,j,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;p=function(b,d){return a.isArray(d)?c.call(d,b)>=0:b===d},n=g["@graph"]!=null?g["@graph"]:g,a.isArray(n)||(n=[n]),x=[];for(A=0,C=n.length;A<C;A++){i=n[A];if(!p("oa:Annotation",i["@type"]))continue;if(!p("dctypes:Text",(E=i.hasBody)!=null?E["@type"]:void 0))continue;if(i.hasTarget==null||!p("oa:SpecificResource",i.hasTarget["@type"]))continue;if(!p(e.url,i.hasTarget.hasSource))continue;q={id:i["@id"],type:"Annotation",bodyContent:i.hasBody.chars,bodyType:"Text",targetURI:e.url};if(i.hasTarget.hasSelector!=null){p("oa:CompoundSelector",i.hasTarget.hasSelector["@type"])?t=i.hasTarget.hasSelector.item:t=i.hasTarget.hasSelector,a.isArray(t)||(t=[t]);for(B=0,D=t.length;B<D;B++){s=t[B],y=s["@type"],a.isArray(y)&&(y=y[0]);switch(y){case"oa:FragmentSelector":s.conformsTo!=null&&p("http://www.w3.org/TR/media-frags/",s.conformsTo)&&(z=s.value,a.isArray(z)&&(z=z[0]),s.value!=null&&s.value.slice(0,6)==="t=npt:"&&(j=s.value.slice(6).split(","),j.length===2&&(q.npt_start=f(j[0]),q.npt_end=f(j[1]))));break;case"oa:SvgSelector":if(s.format==="image/svg+xml"&&s.chars!=null){v=s.chars,m=a.parseXML(v);if(m!=null){l=m.documentElement,r=l.nodeName;for(w in k)o=k[w],o.extractFromSVG!=null&&c.call(o.rootSVGElement,r)>=0&&(u=o.extractFromSVG(l),u!=null&&(a.extend(q,u),q.shapeType=w))}s["exif:height"]!=null&&(q.targetHeight=parseInt(s["exif:height"],10)),s["exif:width"]!=null&&(q.targetWidth=parseInt(s["exif:width"],10))}}}}q.npt_start!=null&&q.npt_end!=null&&x.push(q)}return b.dataStore.canvas.loadItems(x,h)})})},b.exportJSONLD=function(){var a,c,e,f,g,h,j,l,m;h={"@context":["http://www.w3.org/ns/oa-context-20130208.json",{exif:d.EXIF}],"@graph":[]},a=b.dataStore.canvas.prepare(["!type"]),e=function(a){return{"@type":"dctypes:Text",format:"text/plain",chars:a.bodyContent[0]}},f=function(a){var c,d,e,f,g,h,j,l;d={},c={},a.shapeType!=null&&(e=(f=k[a.shapeType[0]])!=null?f.renderAsSVG:void 0),e!=null&&(d={"@type":"oa:SvgSelector",format:"image/svg+xml",chars:e(b.dataStore.canvas,a.id[0])},((g=a.targetHeight)!=null?g[0]:void 0)!=null?d["exif:height"]=(h=a.targetHeight)!=null?h[0]:void 0:d["exif:height"]=i.height,((j=a.targetWidth)!=null?j[0]:void 0)!=null?d["exif:width"]=(l=a.targetWidth)!=null?l[0]:void 0:d["exif:width"]=i.width),c={"@type":"oa:FragmentSelector",value:"t=npt:"+a.npt_start[0]+","+a.npt_end[0],conformsTo:"http://www.w3.org/TR/media-frags/"};return{"@type":"oa:SpecificResource",hasSource:a.targetURI[0],hasSelector:{"@type":"oa:Composite",item:[d,c]}}},c=function(a){var b;return{"@type":"oa:Annotation","@id":(b=a.id)!=null?b[0]:void 0,hasBody:e(a),hasTarget:f(a)}},m=a.evaluate("Annotation");for(j=0,l=m.length;j<l;j++)g=m[j],h["@graph"].push(c(b.dataStore.canvas.getItem(g)));return h},b.exportData=function(){var a,c,e,f,h,j,l,m,n,o,p,q,r,s,t;e={},p={},f=b.dataStore.canvas.prepare(["!type"]),n=function(a,b,c,d,e){p[a]==null&&(p[a]={}),p[a][b+c]==null&&(p[a][b+c]=[]);return p[a][b+c].push({type:d,value:e})},a=function(a,b,c,d){return n(a,b,c,"bnode",d)},q=function(a,b,c,d){return n(a,b,c,"uri",d)},l=function(a,b,c,d){return n(a,b,c,"literal",d)},h=function(a,b){q(b.buid,d.RDF,"type",""+d.DCTYPES+"Text"),l(b.buid,d.DC,"format","text/plain"),l(b.buid,d.CNT,"characterEncoding","utf-8");return l(b.buid,d.CNT,"chars",a.bodyContent[0])},j=function(c,e){var f,g;q(e.tuid,d.RDF,"type",""+d.OA+"SpecificResource"),q(e.tuid,d.OA,"hasSource",c.targetURI[0]),a(e.tuid,d.OA,"hasSelector",e.suid),q(e.suid,d.RDF,"type",""+d.OA+"Composite"),a(e.suid,d.OA,"item",e.svgid),a(e.suid,d.OA,"item",e.fgid),c.shapeType!=null&&(f=(g=k[c.shapeType[0]])!=null?g.renderAsSVG:void 0),f!=null&&(q(e.svgid,d.RDF,"type",""+d.OA+"SvgSelector"),l(e.svgid,d.DC,"format","image/svg+xml"),l(e.svgid,d.CNT,"characterEncoding","utf-8"),l(e.svgid,d.CNT,"chars",f(b.dataStore.canvas,c.id[0])),c.targetHeight!=null&&c.targetHeight[0]!=null?l(e.svgid,d.EXIF,"height",c.targetHeight[0]):l(e.svgid,d.EXIF,"height",i.height),c.targetWidth!=null&&c.targetWidth[0]!=null?l(e.svgid,d.EXIF,"width",c.targetWidth[0]):l(e.svgid,d.EXIF,"width",i.width)),q(e.fgid,d.RDF,"type",""+d.OA+"FragmentSelector"),l(e.fgid,d.RDF,"value","t=npt:"+c.npt_start[0]+","+c.npt_end[0]);return q(e.fgid,d.DCTERMS,"conformsTo","http://www.w3.org/TR/media-frags/")},c=function(c){var e;e=b.dataStore.canvas.getItem(c.id),c.buid==null&&(c.buid="_:b"+g()),c.tuid==null&&(c.tuid="_:t"+g()),c.suid==null&&(c.suid="_:sel"+g()),c.svgid==null&&(c.svgid="_:sel"+g()),c.fgid==null&&(c.fgid="_:sel"+g()),q(c.id,d.RDF,"type",""+d.OA+"Annotation"),a(c.id,d.OA,"hasBody",c.buid),a(c.id,d.OA,"hasTarget",c.tuid),h(e,c);return j(e,c)},m=function(a){var d;d=b.dataStore.canvas.getItem(a);return c({id:d.id})},t=f.evaluate("Annotation");for(r=0,s=t.length;r<s;r++)o=t[r],m(o);return p},b.ready(function(){b.events.onActiveAnnotationChange.addListener(b.presentation.raphsvg.eventFocusChange),b.events.onCurrentTimeChange.addListener(function(a){b.dataView.currentAnnotations.setKeyRange(a-5,a+5),h.setPlayhead(a);if(b.getCurrentMode()!=="Watch")return b.setCurrentMode(null)}),b.setCurrentTime(h.getPlayhead()),h.events.onPlayheadUpdate.addListener(b.setCurrentTime);return b.events.onCurrentModeChange.addListener(function(a){if(a!=="Watch")return h.pause();if(a==="Watch")return h.play()})});return b.ready(function(){b.addShapeType("Rectangle",{renderAsSVG:function(a,b){var c;c=a.getItem(b);return"<rect x='"+c.x[0]+"' y='"+c.y[0]+"' width='"+c.w[0]+"' height='"+c.h[0]+"' />"},rootSVGElement:["rect"],extractFromSVG:function(a){var b;b={},b.w=parseFloat(a.getAttribute("width")),b.h=parseFloat(a.getAttribute("height")),b.x=parseFloat(a.getAttribute("x")),b.y=parseFloat(a.getAttribute("y"));return b},lens:function(c,d,e,f){return b.initShapeLens(c,d,e,f,function(c){var g,h,i,j,k,l,m,n,o,p;i=e.getItem(f),o=c.scalePoint(i.x[0]-i.w[0]/2,i.y[0]-i.h[0]/2,i.targetWidth,i.targetHeight),m=o[0],n=o[1],p=c.scalePoint(i.w[0],i.h[0],i.targetWidth,i.targetHeight),l=p[0],h=p[1],g=d.canvas.rect(m,n,l,h),c.shape=g,g.attr({fill:"silver",border:"grey"}),c.setOpacity(),a(g.node).css({"pointer-events":"auto"}),j=b.controller.selectShape.bind(g),j.events.onSelect.addListener(function(){return b.setActiveAnnotation(f)}),k=c.update,c.update=function(a){var b,d;i=a,k(i);if(i.x!=null&&i.y!=null&&i.w!=null&&i.h!=null){b=c.scalePoint(i.x[0],i.y[0],i.targetWidth,i.targetHeight
),m=b[0],n=b[1],d=c.scalePoint(i.w[0],i.h[0],i.targetWidth,i.targetHeight),l=d[0],h=d[1];return g.attr({x:m-l/2,y:n-h/2,width:l,height:h})}};return c.getExtents=function(){return{x:g.attr("x")+g.attr("width")/2,y:g.attr("y")+g.attr("height")/2,width:g.attr("width"),height:g.attr("height")}}})}}),b.addShapeType("Ellipse",{renderAsSVG:function(a,b){var c;c=a.getItem(b);return"<ellipse x='"+c.x[0]+"' y='"+c.y[0]+"' width='"+c.w[0]+"' height='"+c.h[0]+"' />"},rootSVGElement:["ellipse"],extractFromSVG:function(a){var b;b={},b.w=parseFloat(a.getAttribute("width")),b.h=parseFloat(a.getAttribute("height")),b.x=parseFloat(a.getAttribute("x")),b.y=parseFloat(a.getAttribute("y"));return b},lens:function(c,d,e,f){return b.initShapeLens(c,d,e,f,function(c){var g,h,i,j,k,l,m,n,o,p;i=e.getItem(f),o=c.scalePoint(i.x[0],i.y[0],i.targetWidth,i.targetHeight),m=o[0],n=o[1],p=c.scalePoint(i.w[0]/2,i.h[0]/2,i.targetWidth,i.targetHeight),l=p[0],h=p[1],g=d.canvas.ellipse(m,n,l,h),c.shape=g,g.attr({fill:"silver",border:"grey"}),c.setOpacity(),a(g.node).css({"pointer-events":"auto"}),j=b.controller.selectShape.bind(g),j.events.onSelect.addListener(function(){return b.setActiveAnnotation(f)}),k=c.update,c.update=function(a){var b,d;k(a);if(a.x!=null&&a.y!=null){b=c.scalePoint(a.x[0],a.y[0],a.targetWidth,a.targetHeight),m=b[0],n=b[1],d=c.scalePoint(a.w[0],a.h[0],a.targetWidth,a.targetHeight),l=d[0],h=d[1];return g.attr({cx:m,cy:n,rx:l/2,ry:h/2})}};return c.getExtents=function(){return{x:g.attr("cx"),y:g.attr("cy"),width:g.attr("rx")*2,height:g.attr("ry")*2}}})}});return b.setCurrentTime(0)})}]))}})}(jQuery,MITHgrid,a),MITHgrid.defaults("OAC.Client.StreamingVideo.Application",{controllers:{canvas:{type:a.Client.StreamingVideo.Controller.CanvasClickController,selectors:{svgwrapper:""}},selectShape:{type:a.Client.StreamingVideo.Controller.Select,selectors:{raphael:""}}},variables:{ActiveAnnotation:{is:"rwl"},CurrentTime:{is:"rw","default":0},TimeEasement:{is:"rw","default":5},CurrentMode:{is:"rw"}},dataViews:{currentAnnotations:{dataStore:"canvas",type:MITHgrid.Data.RangePager,leftExpressions:[".npt_start"],rightExpressions:[".npt_end"]}},dataStores:{canvas:{types:{Annotation:{}},properties:{bodyContent:{valueType:"text"},bodyType:{valueType:"text"},npt_end:{valueType:"numeric"},npt_start:{valueType:"numeric"},shapeType:{valueType:"text"},targetURI:{valueType:"uri"},h:{valueType:"numeric"},targetHeight:{valueType:"numeric"},targetWidth:{valueType:"numeric"},w:{valueType:"numeric"},x:{valueType:"numeric"},y:{valueType:"numeric"}}}},presentations:{raphsvg:{type:a.Client.StreamingVideo.Presentation.RaphaelCanvas,container:".canvas",lenses:{},lensKey:[".shapeType"],dataView:"currentAnnotations",controllers:{canvas:"canvas"}}},viewSetup:'<div class="canvas"></div>'}),MITHgrid.defaults("OAC.Client.StreamingVideo.Component.ShapeCreateBox",{bind:{events:{onNewShape:null}}}),MITHgrid.defaults("OAC.Client.StreamingVideo.Component.ShapeEditBox",{dirs:["ul","top","ur","lft","lr","btm","ll","rgt","mid"],events:{onResize:null,onMove:null,onDelete:null,onFocus:null,onUnfocus:null}}),MITHgrid.defaults("OAC.Client.StreamingVideo.Controller.CanvasClickController",{bind:{events:{onShapeStart:null,onShapeDrag:null,onShapeDone:null}}}),MITHgrid.defaults("OAC.Client.StreamingVideo.Controller.Drag",{bind:{events:{onFocus:null,onUnfocus:null,onUpdate:null}}}),MITHgrid.defaults("OAC.Client.StreamingVideo.Controller.Select",{bind:{events:{onSelect:null}},isSelectable:function(){return!0}}),MITHgrid.defaults("OAC.Client.StreamingVideo.Player.DriverBinding",{events:{onResize:null,onPlayheadUpdate:null}})}).call(this);