---
layout: docco
title: OACVideoAnnotator/code/src/canvas.coffee.html
---
<div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../src/canvas.coffee.html" class="source selected"><span class="base_path">src / </span><span class="file_name">canvas.coffee</span></a><a href="../src/component.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">component.coffee</span></a><a href="../src/controllers.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">controllers.coffee</span></a><a href="../src/driver-framework.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">driver-framework.coffee</span></a><a href="../src/drivers/dummy.coffee.html" class="source "><span class="base_path">src / drivers / </span><span class="file_name">dummy.coffee</span></a><a href="../src/drivers/html5.coffee.html" class="source "><span class="base_path">src / drivers / </span><span class="file_name">html5.coffee</span></a><a href="../src/drivers/youtube.coffee.html" class="source "><span class="base_path">src / drivers / </span><span class="file_name">youtube.coffee</span></a><a href="../src/intro.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">intro.coffee</span></a><a href="../src/outro.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">outro.coffee</span></a><a href="../src/presentations.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">presentations.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>canvas.coffee</h1><div class="filepath">src/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><h1>Annotation Application</h1>

<p>TODO: rename file to application.js</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><h1>S4 (private)</h1>

<p>Generates a UUID value, this is not a global uid</p>

<p>Returns:
String with 16-byte pattern</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">S4 = </span><span class="nf">() -&gt;</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">())</span> <span class="o">*</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><h1>uuid (private)</h1>

<p>Generates a UUID</p>

<p>This is not a global variable - theoretically could clash with another
variable if enough MITHGrid instances are started. Works now as a local
unique ID
**FIXME: Abstract so that there is a server prefix component that insures
more of a GUID</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">uuid = </span><span class="nf">() -&gt;</span> <span class="p">(</span><span class="nx">S4</span><span class="p">()</span> <span class="o">+</span> <span class="nx">S4</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">S4</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">S4</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">S4</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">S4</span><span class="p">()</span> <span class="o">+</span> <span class="nx">S4</span><span class="p">()</span> <span class="o">+</span> <span class="nx">S4</span><span class="p">())</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>canvasId is unique within the OAC annotation application, which is loaded once on a webpage but instanced for
each video.</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">canvasId = </span><span class="mi">1</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><h2>StreamingVideo.initApp</h2>

<p>Parameters:</p>

<ul>
<li>container - the DOM container in which the application should place its content</li>
<li>options - an object holding configuration information</li>
</ul>

<p>Returns:</p>

<p>The configured OAC streaming video annotation client object.</p>

<p>Options:</p>

<ul>
<li>playerWrapper: [Required] DOM path to the top-level element of the video player</li>
</ul>
</td><td class="code"><div class="highlight"><pre><span class="nv">OAC.Client.StreamingVideo.initApp = OAC.Client.StreamingVideo.initInstance = </span><span class="nf">(args...) -&gt;</span>
  <span class="nv">app = </span><span class="p">{}</span>
  <span class="nv">shapeAnnotationId = </span><span class="mi">0</span>
  <span class="nv">myCanvasId = </span><span class="s">&#39;OAC-Client-StreamingVideo-SVG-Canvas-&#39;</span> <span class="o">+</span> <span class="nx">canvasId</span>
  <span class="nv">xy = </span><span class="p">[]</span>
  <span class="nv">wh = </span><span class="p">[]</span>
  <span class="p">[</span><span class="nx">klass</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">normalizeArgs</span> <span class="s">&quot;OAC.Client.StreamingVideo&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Generating the canvasId allows us to have multiple instances of the application on a page and still
have a unique ID as expected by the Raphaël library.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">canvasId</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="nv">extendedOpts = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>We create a general template that holds all of the different DOM elements we need:</p>

<ul>
<li>the SVG view that will overlay the play surface (myCanvasId is the DOM id)</li>
<li>the time selection input area (.timeselect)</li>
<li>the controls (.section-controls)</li>
<li>the annotations (.section-annotations)</li>
</ul>

<p>TODO: Split out display of modes into a separate issue... let this application focus on
     the display of annotations and targets instead of the chrome.
     We'll put together a demo page that does have all of the parts working together.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">viewSetup: </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">      &lt;div id=&quot;</span><span class="si">#{</span><span class="nx">myCanvasId</span><span class="si">}</span><span class="s">&quot; class=&quot;section-canvas&quot;&gt;&lt;/div&gt;</span>
<span class="s">      &lt;div class=&quot;mithgrid-bottomarea&quot;&gt;</span>
<span class="s">        &lt;div class=&quot;timeselect&quot;&gt;</span>
<span class="s">          &lt;p&gt;Enter start time:&lt;/p&gt;</span>
<span class="s">          &lt;input id=&quot;timestart&quot; type=&quot;text&quot; /&gt;</span>
<span class="s">          &lt;p&gt;Enter end time:&lt;/p&gt;</span>
<span class="s">          &lt;input id=&quot;timeend&quot; type=&quot;text&quot; /&gt;</span>
<span class="s">          &lt;div id=&quot;submittime&quot; class=&quot;button&quot;&gt;Confirm time settings&lt;/div&gt;</span>
<span class="s">        &lt;/div&gt;</span>
<span class="s">        &lt;div id=&quot;sidebar</span><span class="si">#{</span><span class="nx">myCanvasId</span><span class="si">}</span><span class="s">&quot; class=&quot;section-controls&quot;&gt;&lt;/div&gt;</span>
<span class="s">        &lt;div class=&quot;section-annotations&quot;&gt;</span>
<span class="s">          &lt;div class=&quot;header&quot;&gt;</span>
<span class="s">            Annotations</span>
<span class="s">          &lt;/div&gt;</span>
<span class="s">        &lt;/div&gt;</span>
<span class="s">      &lt;/div&gt;</span>
<span class="s">    &quot;&quot;&quot;</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>We make the isActive() function available to the keyboard controller to let it know if
the keyboard should be considered active.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">controllers:</span>
      <span class="nv">keyboard:</span>
        <span class="nv">isActive: </span><span class="nf">() -&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">getCurrentMode</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;Editing&#39;</span>
      <span class="nv">selectShape:</span>
        <span class="nv">isSelectable: </span><span class="nf">() -&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">getCurrentMode</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;Select&quot;</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>We connect the SVG overlay and annotation sections of the DOM with their respective
presentations.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">presentations:</span>
      <span class="nv">raphsvg:</span>
        <span class="nv">container: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nx">myCanvasId</span>
        <span class="nv">lenses: </span><span class="p">{}</span>
        <span class="nv">lensKey: </span><span class="p">[</span><span class="s">&#39;.shapeType&#39;</span><span class="p">]</span>
        <span class="nv">playerWrapper: </span><span class="nx">options</span><span class="p">.</span><span class="nx">playerWrapper</span>
      <span class="nv">annoItem:</span>
        <span class="nv">container: </span><span class="s">&#39;.section-annotations&#39;</span>
        <span class="nv">lenses: </span><span class="p">{}</span>
        <span class="nv">lensKey: </span><span class="p">[</span><span class="s">&#39;.bodyType&#39;</span><span class="p">]</span>
  <span class="p">},</span> <span class="nx">options</span><span class="p">)</span>

  <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Application</span><span class="p">.</span><span class="nx">initInstance</span> <span class="nx">klass</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">extendedOpts</span><span class="p">,</span> <span class="nf">(appOb) -&gt;</span>
    <span class="nv">app = </span><span class="nx">appOb</span>
    <span class="nv">shapeTypes = </span><span class="p">{}</span>
    
    
    <span class="nv">options = </span><span class="nx">app</span><span class="p">.</span><span class="nx">options</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>We isolate the player object through a closure so it won't change on us.
We expect one application instance per player.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">playerObj = </span><span class="nx">options</span><span class="p">.</span><span class="nx">player</span>

    <span class="nv">app.getPlayer = </span><span class="o">-&gt;</span> <span class="nx">playerObj</span>
  </pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><h3>#initShapeLens</h3>

<p>Initializes a basic shape lens. The default methods expect the Raphaël SVG shape object to
be held in the .shape property.</p>

<p>Parameters:</p>

<ul>
<li>container - the container holding the lens content</li>
<li>view - the presentation managing the collection of renderings</li>
<li>model - the data store or data view holding information about the item to be rendered</li>
<li>itemId - the item ID of the item to be rendered</li>
</ul>

<p>Returns:</p>

<p>The basic lens object with the following methods defined:</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">app.initShapeLens = </span><span class="nf">(container, view, model, itemId) -&gt;</span>
      <span class="nv">that =</span>
        <span class="nv">id: </span><span class="nx">itemId</span>
      <span class="nv">item = </span><span class="nx">model</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">itemId</span>

      <span class="nv">focused = </span><span class="kc">false</span>
      <span class="nv">start = </span><span class="nx">item</span><span class="p">.</span><span class="nx">npt_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">end = </span><span class="nx">item</span><span class="p">.</span><span class="nx">npt_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">fstart = </span><span class="nx">start</span> <span class="o">-</span> <span class="nx">app</span><span class="p">.</span><span class="nx">getTimeEasement</span><span class="p">()</span>
      <span class="nv">fend = </span><span class="nx">end</span> <span class="o">+</span> <span class="nx">app</span><span class="p">.</span><span class="nx">getTimeEasement</span><span class="p">()</span>
      </pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><h3>#calcOpacity (private)</h3>

<p>Calculate the opacity of the annotation shape rendering over the video.</p>

<p>Parameters:</p>

<ul>
<li>n - the current time of the play head</li>
</ul>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">calcOpacity = </span><span class="nf">(n) -&gt;</span>
        <span class="nv">val = </span><span class="mf">0.0</span>

        <span class="k">if</span> <span class="nx">n</span> <span class="o">&gt;=</span> <span class="nx">fstart</span> <span class="o">and</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">fend</span>
          <span class="nv">e = </span><span class="nx">app</span><span class="p">.</span><span class="nx">getTimeEasement</span><span class="p">()</span>
          <span class="k">if</span> <span class="nx">e</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">start</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>fading in</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nv">val = </span><span class="p">(</span><span class="nx">e</span> <span class="o">-</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">n</span><span class="p">)</span> <span class="o">/</span> <span class="nx">e</span>
            <span class="k">else</span> <span class="k">if</span> <span class="nx">n</span> <span class="o">&gt;</span> <span class="nx">end</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>fading out</p>
</td><td class="code"><div class="highlight"><pre>              <span class="nv">val = </span><span class="p">(</span><span class="nx">e</span> <span class="o">+</span> <span class="nx">end</span> <span class="o">-</span> <span class="nx">n</span><span class="p">)</span> <span class="o">/</span> <span class="nx">e</span>
            <span class="k">else</span>
              <span class="nv">val = </span><span class="mf">1.0</span>
          <span class="k">else</span>
            <span class="nv">val = </span><span class="mf">1.0</span>
        <span class="nx">val</span>
      
    </pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><h3>eventTimeEasementChange (private)</h3>

<p>Handles event calls for when the user wants
to see the annotation at a specific interval.
By default, annotations are in view for the time period
of the item being annotated. They are 'eased in', or fade in
and out depending on the Easement variable, which is set
here.</p>

<p>Parameters:</p>

<ul>
<li>v: when the annotation should be in view</li>
</ul>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.eventTimeEasementChange = </span><span class="nf">(v) -&gt;</span>
        <span class="nv">fstart = </span><span class="nx">start</span> <span class="o">-</span> <span class="nx">v</span>
        <span class="nv">fend = </span><span class="nx">end</span> <span class="o">+</span> <span class="nx">v</span>
        
        <span class="nx">that</span><span class="p">.</span><span class="nx">setOpacity</span> <span class="nx">calcOpacity</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">getCurrentTime</span><span class="p">())</span>
      </pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><h3>eventCurrentTimeChange (private)</h3>

<p>Handles when application advances the time</p>

<p>Parameters:</p>

<p>*n: current time of the video player</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.eventCurrentTimeChange = </span><span class="nf">(n) -&gt;</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">setOpacity</span> <span class="nx">calcOpacity</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
      
      <span class="nv">opacity = </span><span class="mf">0.0</span>
    </pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><h4>#setOpacity</h4>

<p>Sets the opacity for the SVG shape. This is moderated by the renderings focus. If in focus, then
the full opacity is set. Otherwise, it is halved.</p>

<p>If no value is given, then the shape's opacity is updated to reflect the currently set opacity and
focus state.</p>

<p>Parameters:</p>

<ul>
<li>o - opacity when in focus</li>
</ul>

<p>Returns: Nothing.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.setOpacity = </span><span class="nf">(o) -&gt;</span>
        <span class="k">if</span> <span class="nx">o</span><span class="o">?</span>
          <span class="nv">opacity = </span><span class="nx">o</span>
      
        <span class="k">if</span> <span class="nx">that</span><span class="p">.</span><span class="nx">shape</span><span class="o">?</span>
          <span class="nx">that</span><span class="p">.</span><span class="nx">shape</span><span class="p">.</span><span class="nx">attr</span>
            <span class="nv">opacity: </span><span class="p">(</span><span class="k">if</span> <span class="nx">focused</span> <span class="k">then</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">*</span> <span class="nx">opacity</span>
    
      <span class="nv">that.getOpacity = </span><span class="o">-&gt;</span> <span class="nx">opacity</span>
      
      <span class="nx">that</span><span class="p">.</span><span class="nx">setOpacity</span><span class="p">(</span><span class="nx">calcOpacity</span> <span class="nx">app</span><span class="p">.</span><span class="nx">getCurrentTime</span><span class="p">())</span>
      </pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><h4>#eventFocus</h4>

<p>Called when this rendering receives the selection focus. The default implementation brings the rendering
to the front and makes it opaque.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.eventFocus = </span><span class="o">-&gt;</span>
        <span class="nv">focused = </span><span class="kc">true</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">setOpacity</span><span class="p">()</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">shape</span><span class="p">.</span><span class="nx">toFront</span><span class="p">()</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p><strong>FIXME:</strong> This should be handled in the view instead of by adding/removing listeners like this</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">view</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onDelete</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">that</span><span class="p">.</span><span class="nx">eventDelete</span>
      </pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><h4>#eventUnfocus</h4>

<p>Called when this rendering loses the selection focus. The default implementation pushes the rendering
to the back and makes it semi-transparent.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.eventUnfocus = </span><span class="o">-&gt;</span>
        <span class="nv">focused = </span><span class="kc">false</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">setOpacity</span><span class="p">()</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">shape</span><span class="p">.</span><span class="nx">toBack</span><span class="p">()</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onDelete</span><span class="p">.</span><span class="nx">removeListener</span> <span class="nx">that</span><span class="p">.</span><span class="nx">eventDelete</span>
      </pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><h4>#eventDelete</h4>

<p>Called when the data item represented by this rendering is to be deleted. The default implementation
passes the deletion request to the data store with the item ID represented by the rendering.</p>

<p>Parameters: None.</p>

<p>Returns: Nothing.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.eventDelete = </span><span class="o">-&gt;</span> <span class="nx">model</span><span class="p">.</span><span class="nx">removeItems</span> <span class="p">[</span><span class="nx">itemId</span><span class="p">]</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><h4>#eventResize</h4>

<p>Called when the bounding box of the rendering changes size.</p>

<p>Parameters:</p>

<ul>
<li>pos - object containing the .width and .height properties</li>
</ul>

<p>Returns: Nothing.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.eventResize = </span><span class="nf">(pos) -&gt;</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">updateItems</span> <span class="p">[</span>
          <span class="nv">id: </span><span class="nx">itemId</span>
          <span class="nv">x: </span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span>
          <span class="nv">y: </span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span>
          <span class="nv">w: </span><span class="nx">pos</span><span class="p">.</span><span class="nx">width</span>
          <span class="nv">h: </span><span class="nx">pos</span><span class="p">.</span><span class="nx">height</span>
        <span class="p">]</span>
      </pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><h4>#eventMove</h4>

<p>Called when the bounding box of the rendering is moved.</p>

<p>Parameters:</p>

<ul>
<li>pos - object containing the .x and .y properties</li>
</ul>

<p>Returns: Nothing.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.eventMove = </span><span class="nf">(pos) -&gt;</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">updateItems</span> <span class="p">[</span>
          <span class="nv">id: </span><span class="nx">itemId</span>
          <span class="nv">x: </span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span>
          <span class="nv">y: </span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span>
        <span class="p">]</span>
      </pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><h4>#update</h4>

<p>Updates the rendering's opacity based on the current time and the time extent of the annotation.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.update = </span><span class="nf">(item) -&gt;</span>
        <span class="k">if</span> <span class="nx">item</span><span class="p">.</span><span class="nx">npt_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">start</span> <span class="o">or</span> <span class="nx">item</span><span class="p">.</span><span class="nx">npt_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">end</span>
          <span class="nv">start = </span><span class="nx">item</span><span class="p">.</span><span class="nx">npt_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="nv">end = </span><span class="nx">item</span><span class="p">.</span><span class="nx">npt_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="nv">fstart = </span><span class="nx">start</span> <span class="o">-</span> <span class="nx">app</span><span class="p">.</span><span class="nx">getTimeEasement</span><span class="p">()</span>
          <span class="nv">fend = </span><span class="nx">end</span> <span class="o">+</span> <span class="nx">app</span><span class="p">.</span><span class="nx">getTimeEasement</span><span class="p">()</span>
          <span class="nx">that</span><span class="p">.</span><span class="nx">setOpacity</span> <span class="nx">calcOpacity</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">getCurrentTime</span><span class="p">())</span>
      </pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><h4>#remove</h4>

<p>Called to remove the rendering from the presentation.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.remove = </span><span class="nf">(item) -&gt;</span> <span class="nx">that</span><span class="p">.</span><span class="nx">shape</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>
      
      <span class="nx">that</span>
      </pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><h3>#initTextLens</h3>

<p>Initializes a basic text lens.</p>

<p>Parameters:</p>

<ul>
<li>container - the container holding the lens content</li>
<li>view - the presentation managing the collection of renderings</li>
<li>model - the data store or data view holding information abut the item to be rendered</li>
<li>itemId - the item ID of the item to be rendered</li>
</ul>

<p>Returns:</p>

<p>The basic lens object.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">app.initTextLens = </span><span class="nf">(container, view, model, itemId) -&gt;</span>
      <span class="nv">that = </span><span class="p">{}</span>
      <span class="nv">item = </span><span class="nx">model</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">itemId</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>We put together a template representing the text annotations associated with any shape.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">itemEl = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        &lt;div class=&quot;anno_item&quot;&gt;</span>
<span class="s">          &lt;p class=&quot;bodyContentInstructions&quot;&gt;Double click here to open edit window.&lt;/p&gt;</span>
<span class="s">          &lt;div class=&quot;editArea&quot;&gt;</span>
<span class="s">            &lt;textarea class=&quot;bodyContentTextArea&quot;&gt;&lt;/textarea&gt;</span>
<span class="s">            &lt;div id=&quot;editUpdate&quot; class=&quot;button update&quot;&gt;Update&lt;/div&gt;</span>
<span class="s">            &lt;div id=&quot;editDelete&quot; class=&quot;button delete&quot;&gt;Delete&lt;/div&gt;</span>
<span class="s">          &lt;/div&gt;</span>
<span class="s">          &lt;div class=&quot;body&quot;&gt;</span>
<span class="s">            &lt;p class=&quot;bodyContent&quot;&gt;&lt;/p&gt;</span>
<span class="s">          &lt;/div&gt;</span>
<span class="s">        &lt;/div&gt;</span>
<span class="s">      &quot;&quot;&quot;</span><span class="p">)</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>We capture the parts of the annotation presentation for use later.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">bodyContentTextArea = </span><span class="nx">$</span><span class="p">(</span><span class="nx">itemEl</span><span class="p">).</span><span class="nx">find</span> <span class="s">&quot;.bodyContentTextArea&quot;</span>
      <span class="nv">bodyContent = </span><span class="nx">$</span><span class="p">(</span><span class="nx">itemEl</span><span class="p">).</span><span class="nx">find</span> <span class="s">&quot;.bodyContent&quot;</span>

      <span class="nx">$</span><span class="p">(</span><span class="nx">bodyContentTextArea</span><span class="p">).</span><span class="nx">text</span> <span class="nx">item</span><span class="p">.</span><span class="nx">bodyContent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">bodyContent</span><span class="p">).</span><span class="nx">text</span> <span class="nx">item</span><span class="p">.</span><span class="nx">bodyContent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>We attach the rendering to the container and hide the edit area.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">append</span> <span class="nx">itemEl</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">itemEl</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;.editArea&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>We then construct the following methods:</p>

<h4>#eventFocus</h4>

<p>Called when this rendering receives the selection focus. The default implementation adds the
.selected CSS class.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.eventFocus = </span><span class="o">-&gt;</span> <span class="nx">itemEl</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&#39;selected&#39;</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><h4>#eventUnfocus</h4>

<p>Called when this rendering loses the selection focus. The default implementation removes the
.selected CSS class.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.eventUnfocus = </span><span class="o">-&gt;</span> <span class="nx">itemEl</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&#39;selected&#39;</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><h4>#eventUpdate</h4>

<p>Called when the text annotation body is updated. This will update the data store with the new body.</p>

<p>The rendering is update if and only if the id passed in matches the id of the rendered item.</p>

<p>Parameters:</p>

<ul>
<li>id - the item ID of the item to be updated</li>
<li>data - the object holding the current data associated with the item ID</li>
</ul>

<p>Returns: Nothing.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.eventUpdate = </span><span class="nf">(id, data) -&gt;</span>
        <span class="k">if</span> <span class="nx">id</span> <span class="o">==</span> <span class="nx">itemId</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">updateItems</span> <span class="p">[</span>
            <span class="nv">id: </span><span class="nx">itemId</span>
            <span class="nv">bodyContent: </span><span class="nx">data</span>
          <span class="p">]</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><h4>#eventDelete</h4>

<p>Called when the data item represented by this rendering is to be deleted. The default implementation
passes the deletion request to the data store with the item ID represented by the rendering.</p>

<p>The data item is removed if and only if the id passed in matches the id of the rendered item.</p>

<p>Parameters:</p>

<ul>
<li>id - the item ID of the item to be deleted</li>
</ul>

<p>Returns: Nothing.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.eventDelete = </span><span class="nf">(id) -&gt;</span>
        <span class="k">if</span> <span class="nx">id</span> <span class="o">==</span> <span class="nx">itemId</span>
          <span class="nx">model</span><span class="p">.</span><span class="nx">removeItems</span> <span class="p">[</span><span class="nx">itemId</span><span class="p">]</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><h4>#update</h4>

<p>Called when the underlying data represented by the rendering changes. The rendering is updated to
reflect the item data.</p>

<p>The rendering is update if and only if the id passed in matches the id of the rendered item.</p>

<p>Parameters:</p>

<ul>
<li>data - the object holding the current data associated with the item ID</li>
</ul>

<p>Returns: Nothing.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.update = </span><span class="nf">(item) -&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">itemEl</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;.bodyContent&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="nx">item</span><span class="p">.</span><span class="nx">bodyContent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">itemEl</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;.bodyContentTextArea&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="nx">item</span><span class="p">.</span><span class="nx">bodyContent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a href="#section-35" class="pilcrow">&#182;</a></div><h4>#remove</h4>

<p>Called to remove the rendering from the presentation.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">that.remove = </span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">itemEl</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a href="#section-36" class="pilcrow">&#182;</a></div><h4>UI events</h4>

<p>We attach a controller to highlight the
HTML when the corresponding shape is selected.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">annoEvents = </span><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">annoActive</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">itemEl</span><span class="p">,</span>
        <span class="nv">model: </span><span class="nx">model</span>
        <span class="nv">itemId: </span><span class="nx">itemId</span></pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a href="#section-37" class="pilcrow">&#182;</a></div><p>We hook up the events generated by the controller to events on the application or
rendering, as appropriate.</p>

<p><strong>FIXME:</strong> We may need to hook some of these up through the view if we depend on the itemId being passed in</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">annoEvents</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onClick</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">app</span><span class="p">.</span><span class="nx">setActiveAnnotation</span>
      <span class="nx">annoEvents</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onDelete</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">that</span><span class="p">.</span><span class="nx">eventDelete</span>
      <span class="nx">annoEvents</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onUpdate</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">that</span><span class="p">.</span><span class="nx">eventUpdate</span>

      <span class="nx">that</span></pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a href="#section-38" class="pilcrow">&#182;</a></div><h3>app.buttonFeature</h3>

<p>Creates an HTML div that acts as a button</p>

<p>**FIXME: Tease this out from the rest of the application and work on better parameters</p>

<p>Parameters:</p>

<ul>
<li><p>area - Classname of the div where the button should go; so far, this can be either 'buttongrouping', where all
general buttons go, or 'slidergrouping', where a jQuery UI slider can be placed</p></li>
<li><p>grouping - Name to be given to the inner div inside the area div</p></li>
<li><p>action - Name to be given to the ID of the clickable HTML button and the name
of the event to fire when button is clicked</p></li>
</ul>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">app.buttonFeature = </span><span class="nf">(area, grouping, action) -&gt;</span></pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a href="#section-39" class="pilcrow">&#182;</a></div><p>Check to make sure button isn't already present
<strong>FIXME:</strong> make sure the id is unique in the page since we can have multiple instances of the
annotation client (one per video)</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">action</span> <span class="o">+</span> <span class="nx">myCanvasId</span><span class="p">).</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">false</span> <span class="c1"># Abort</span>

      <span class="nv">that = </span><span class="p">{}</span>
      <span class="nv">buttons = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;.button&quot;</span><span class="p">)</span>
      <span class="nv">container = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">sidebar&quot;</span> <span class="o">+</span> <span class="nx">myCanvasId</span><span class="p">)</span>

      <span class="k">switch</span> <span class="nx">area</span>
        <span class="k">when</span> <span class="s">&#39;buttongrouping&#39;</span></pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a href="#section-40" class="pilcrow">&#182;</a></div><p>Set the group element where this button should go in. If no group
element is yet created, create that group element with name <em>grouping</em></p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">grouping</span> <span class="o">+</span> <span class="nx">myCanvasId</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s">&#39;&lt;div id=&quot;&#39;</span> <span class="o">+</span> <span class="nx">grouping</span> <span class="o">+</span> <span class="nx">myCanvasId</span> <span class="o">+</span> <span class="s">&#39;&quot; class=&quot;buttongrouping&quot;&gt;&lt;/div&gt;&#39;</span><span class="p">)</span>

          <span class="nv">groupEl = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nx">grouping</span> <span class="o">+</span> <span class="nx">myCanvasId</span><span class="p">)</span></pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a href="#section-41" class="pilcrow">&#182;</a></div><p>generate HTML for button, then attach the callback. action
refers to ID and also the title of the button</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">item = </span><span class="s">&#39;&lt;div id=&quot;&#39;</span> <span class="o">+</span> <span class="nx">action</span> <span class="o">+</span> <span class="nx">myCanvasId</span> <span class="o">+</span> <span class="s">&#39;&quot; class=&quot;button&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">action</span> <span class="o">+</span> <span class="s">&#39;&lt;/div&gt;&#39;</span>

          <span class="nx">$</span><span class="p">(</span><span class="nx">groupEl</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>

          <span class="nv">that.element = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nx">action</span> <span class="o">+</span> <span class="nx">myCanvasId</span><span class="p">)</span>

          <span class="nv">buttonBinding = </span><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">buttonActive</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">that</span><span class="p">.</span><span class="nx">element</span><span class="p">,</span>
            <span class="nv">action: </span><span class="nx">action</span>
        <span class="k">when</span> <span class="s">&#39;slidergrouping&#39;</span>
          <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">grouping</span> <span class="o">+</span> <span class="nx">myCanvasId</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s">&#39;&lt;div id=&quot;&#39;</span> <span class="o">+</span> <span class="nx">grouping</span> <span class="o">+</span> <span class="nx">myCanvasId</span> <span class="o">+</span> <span class="s">&#39;&quot; class=&quot;slidergrouping&quot;&gt;&lt;/div&gt;&#39;</span><span class="p">)</span>

          <span class="nv">groupEl = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nx">grouping</span> <span class="o">+</span> <span class="nx">myCanvasId</span><span class="p">)</span></pre></div></td></tr><tr id="section-42"><td class="docs"><div class="pilwrap"><a href="#section-42" class="pilcrow">&#182;</a></div><p>HTML for slider button</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">item = </span><span class="s">&#39;&lt;div id=&quot;&#39;</span> <span class="o">+</span> <span class="nx">action</span> <span class="o">+</span> <span class="nx">myCanvasId</span> <span class="o">+</span> <span class="s">&#39;&quot;&gt;&lt;div class=&quot;header&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">action</span> <span class="o">+</span> <span class="nx">myCanvasId</span> <span class="o">+</span> <span class="s">&#39;&lt;/div&gt;&#39;</span> <span class="o">+</span>
          <span class="s">&#39;&lt;div id=&quot;slider&quot;&gt;&lt;/div&gt;&lt;div class=&quot;timedisplay&quot;&gt;&lt;/div&gt;&lt;/div&gt;&#39;</span>
          <span class="nx">$</span><span class="p">(</span><span class="nx">groupEl</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
          <span class="nv">that.element = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nx">action</span> <span class="o">+</span> <span class="nx">myCanvasId</span><span class="p">)</span>

          <span class="nv">buttonBinding = </span><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">slider</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">that</span><span class="p">.</span><span class="nx">element</span><span class="p">,</span>
            <span class="nv">action: </span><span class="nx">action</span>
      <span class="nx">that</span></pre></div></td></tr><tr id="section-43"><td class="docs"><div class="pilwrap"><a href="#section-43" class="pilcrow">&#182;</a></div><h3>#addShape</h3>

<p>Adds a shape lens to the SVG overlay presentation.</p>

<p>Parameters:</p>

<ul>
<li>key - the internal shape name</li>
<li>svgShape - the lens rendering function for rendering the shape on the SVG overlay</li>
</ul>

<p>Returns: Nothing.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">app.addShape = </span><span class="nf">(key, svgShape) -&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">presentation</span><span class="p">.</span><span class="nx">raphsvg</span><span class="p">.</span><span class="nx">addLens</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">svgShape</span><span class="p">)</span></pre></div></td></tr><tr id="section-44"><td class="docs"><div class="pilwrap"><a href="#section-44" class="pilcrow">&#182;</a></div><h3>#addBody</h3>

<p>Adds an annotation body lens to the annotation presentation</p>

<p>Parameters:</p>

<ul>
<li>key - the internal annotation body type</li>
<li>textLens - the lens rendering function for rendering the annotation body in the annotation presentation</li>
</ul>

<p>Returns: Nothing.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">app.addBody = </span><span class="nf">(key, textLens) -&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">presentation</span><span class="p">.</span><span class="nx">annoItem</span><span class="p">.</span><span class="nx">addLens</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">textLens</span><span class="p">)</span></pre></div></td></tr><tr id="section-45"><td class="docs"><div class="pilwrap"><a href="#section-45" class="pilcrow">&#182;</a></div><h3>#addShapeType</h3>

<p>Adds a shape type. This includes a lens, a button to activate the shape mode, and
a callback function for creating an item in the data store.</p>

<p>Parameters:</p>

<ul>
<li>type - the internal shape name</li>
<li>args - an object containing the following items:
<ul><li>calc - the callback function for inserting the new shape into the data store</li>
<li>lens - the lens rendering function for rendering the shape on the SVG overlay</li></ul></li>
</ul>

<p>Returns: Nothing.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">app.addShapeType = </span><span class="nf">(type, args) -&gt;</span>
      <span class="nv">calcF = </span><span class="nx">args</span><span class="p">.</span><span class="nx">calc</span>
      <span class="nv">lensF = </span><span class="nx">args</span><span class="p">.</span><span class="nx">lens</span>
      <span class="nv">button = </span><span class="nx">app</span><span class="p">.</span><span class="nx">buttonFeature</span><span class="p">(</span><span class="s">&#39;Shapes&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span>

      <span class="nx">shapeTypes</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">args</span>

      <span class="nx">app</span><span class="p">.</span><span class="nx">addShape</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">lensF</span><span class="p">)</span></pre></div></td></tr><tr id="section-46"><td class="docs"><div class="pilwrap"><a href="#section-46" class="pilcrow">&#182;</a></div><h3>#insertShape</h3>

<p>Inserts a new annotation into the data store using the passed coordinates. An empty text annotation body
is added. The application CurrentMode variable determines the shape. The time span is 5 seconds on either side
of the CurrentTime variable.</p>

<p>Parameters:</p>

<ul>
<li>coords - the coordinates of the center of the shape in the .x, .y, .width, and .height properties.</li>
</ul>

<p>Returns:</p>

<p>The item id of the inserted annotation item.</p>

<p><strong>FIXME:</strong> We should ensure that we don't have clashing IDs. We need to use UUIDs when possible.
 : Using uuid() to generate local UUIDs - not truly a UUID, but close enough for now.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">app.insertShape = </span><span class="nf">(coords) -&gt;</span>
      <span class="nv">npt_start = </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">getCurrentTime</span><span class="p">())</span> <span class="o">-</span> <span class="mi">5</span>
      <span class="nv">npt_end = </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">getCurrentTime</span><span class="p">())</span> <span class="o">+</span> <span class="mi">5</span>
      <span class="nv">curMode = </span><span class="nx">app</span><span class="p">.</span><span class="nx">getCurrentMode</span><span class="p">()</span></pre></div></td></tr><tr id="section-47"><td class="docs"><div class="pilwrap"><a href="#section-47" class="pilcrow">&#182;</a></div><p>Insert into local array of ShapeTypes</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="nx">shapeTypes</span><span class="p">[</span><span class="nx">curMode</span><span class="p">]</span><span class="o">?</span>
        <span class="nv">shape = </span><span class="nx">shapeTypes</span><span class="p">[</span><span class="nx">curMode</span><span class="p">].</span><span class="nx">calc</span><span class="p">(</span><span class="nx">coords</span><span class="p">)</span>
        <span class="nv">shapeAnnotationId = </span><span class="nx">uuid</span><span class="p">()</span>

        <span class="nv">shapeItem =</span>
          <span class="nv">id: </span><span class="s">&quot;anno&quot;</span> <span class="o">+</span> <span class="nx">shapeAnnotationId</span>
          <span class="nv">type: </span><span class="s">&quot;Annotation&quot;</span>
          <span class="nv">bodyType: </span><span class="s">&quot;Text&quot;</span>
          <span class="nv">bodyContent: </span><span class="s">&quot;This is an annotation for &quot;</span> <span class="o">+</span> <span class="nx">curMode</span>
          <span class="nv">shapeType: </span><span class="nx">curMode</span>
          <span class="nv">targetURI: </span><span class="nx">app</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span></pre></div></td></tr><tr id="section-48"><td class="docs"><div class="pilwrap"><a href="#section-48" class="pilcrow">&#182;</a></div><p>Starts off with half-opacity, 1 is for in-focus</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">npt_start: </span><span class="k">if</span><span class="p">(</span><span class="nx">npt_start</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nx">npt_start</span>
          <span class="nv">npt_end: </span><span class="nx">npt_end</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">loadItems</span> <span class="p">[</span><span class="nv">t = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">shapeItem</span><span class="p">,</span> <span class="nx">shape</span><span class="p">)]</span>
        <span class="nx">shapeItem</span><span class="p">.</span><span class="nx">id</span></pre></div></td></tr><tr id="section-49"><td class="docs"><div class="pilwrap"><a href="#section-49" class="pilcrow">&#182;</a></div><h3>importData</h3>

<p>Importing annotation data from an external source. Must be in JSON format</p>

<p>Parameters:
* data - Object housing the data for application</p>
</td><td class="code"><div class="highlight"><pre>  
    <span class="nv">NS = </span>
      <span class="nv">OA: </span><span class="s">&quot;http://www.w3.org/ns/openannotation/core&quot;</span>
      <span class="nv">OAX: </span><span class="s">&quot;http://www.w3.org/ns/openannotation/extensions&quot;</span>
      <span class="nv">RDF: </span><span class="s">&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns</span><span class="err">#</span><span class="s">&quot;</span>
      <span class="nv">CNT: </span><span class="s">&quot;http://www.w3.org/2008/content</span><span class="err">#</span><span class="s">&quot;</span>
      <span class="nv">DC: </span><span class="s">&quot;http://purl.org/dc/elements/1.1/&quot;</span>
    
    <span class="nv">parseNPT = </span><span class="nf">(npt) -&gt;</span>
      <span class="k">if</span> <span class="nx">npt</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">seconds = </span><span class="nb">parseFloat</span> <span class="nx">npt</span>
        <span class="nv">minutes = </span><span class="mi">0</span>
        <span class="nv">hours = </span><span class="mi">0</span>
      <span class="k">else</span>
        <span class="nv">bits = </span><span class="p">((</span><span class="nb">parseFloat</span> <span class="nx">b</span><span class="p">)</span> <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">npt</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))</span>
        <span class="nv">seconds = </span><span class="nx">bits</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">bits</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nv">minutes = </span><span class="nx">bits</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="nv">minutes = </span><span class="mi">0</span>
        <span class="k">if</span> <span class="nx">bits</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nv">hours = </span><span class="nx">bits</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="nv">hours = </span><span class="mi">0</span>
      <span class="p">(</span><span class="nx">hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nx">minutes</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nx">seconds</span>
     
    <span class="nv">app.importData = </span><span class="nf">(data) -&gt;</span></pre></div></td></tr><tr id="section-50"><td class="docs"><div class="pilwrap"><a href="#section-50" class="pilcrow">&#182;</a></div><p>ingest data and put it into dataStore</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">tempstore = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">o</span> <span class="k">of</span> <span class="nx">data</span></pre></div></td></tr><tr id="section-51"><td class="docs"><div class="pilwrap"><a href="#section-51" class="pilcrow">&#182;</a></div><p>Singling out the Annotations from the rest of the RDF data so
we can work down from just the Annotation object and its pointers</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">Annotation&quot;</span> <span class="k">in</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">o</span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="si">}</span><span class="s">type&quot;</span><span class="p">])</span>
          <span class="nv">temp = </span>
            <span class="nv">id: </span><span class="nx">i</span>
            <span class="nv">type: </span><span class="s">&quot;Annotation&quot;</span>
            <span class="nv">bodyContent: </span><span class="s">&#39;&#39;</span>
            <span class="nv">bodyType: </span><span class="s">&#39;Text&#39;</span>
            <span class="nv">targetURI: </span><span class="nx">app</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span></pre></div></td></tr><tr id="section-52"><td class="docs"><div class="pilwrap"><a href="#section-52" class="pilcrow">&#182;</a></div><p>Logic chain to determine what kind of incoming annotation we're dealing with</p>

<p>Only interested in annotations that match our Video URI: are 'about' the video OR
that do not yet have targets</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span> <span class="nx">o</span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasBody&quot;</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">o</span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasBody&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">data</span><span class="p">[</span><span class="nx">o</span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasBody&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">]</span><span class="o">?</span>
            <span class="nv">temp.bodyContent = </span><span class="nx">data</span><span class="p">[</span><span class="nx">o</span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasBody&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">CNT</span><span class="si">}</span><span class="s">chars&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span>
          <span class="k">if</span> <span class="nx">o</span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasTarget&quot;</span><span class="p">]</span><span class="o">?</span>
            <span class="k">for</span> <span class="nx">hasTarget</span> <span class="k">in</span> <span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">o</span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasTarget&quot;</span><span class="p">])</span>
              <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasTarget</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasTarget</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasSource&quot;</span><span class="p">]</span><span class="o">?</span>
                <span class="nv">refd = </span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="k">in</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">s</span> <span class="k">in</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasTarget</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasSource&quot;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="nx">refd</span></pre></div></td></tr><tr id="section-53"><td class="docs"><div class="pilwrap"><a href="#section-53" class="pilcrow">&#182;</a></div><p>Target source matches the URI of our video; generate an OAC dataStore model 
to insert into canvas for this annotation series in the JSON:RDF data</p>
</td><td class="code"><div class="highlight"><pre>            </pre></div></td></tr><tr id="section-54"><td class="docs"><div class="pilwrap"><a href="#section-54" class="pilcrow">&#182;</a></div><p>Unique ID comes from the URI value of type</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-55"><td class="docs"><div class="pilwrap"><a href="#section-55" class="pilcrow">&#182;</a></div><p>Check to see if target is a CompositeSelector Resource
Right now, we don't care about things that are not Compound Resources made
up of a time fragment and an SVG Constraint</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="k">for</span> <span class="nx">hasSelector</span> <span class="k">in</span> <span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasTarget</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasSelector&quot;</span><span class="p">])</span>
                    <span class="nv">refd = </span><span class="p">(</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OAX</span><span class="si">}</span><span class="s">CompositeSelector&quot;</span> <span class="k">in</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasSelector</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="si">}</span><span class="s">type&quot;</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasSelector</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">refd</span>
                      <span class="k">for</span> <span class="nx">hasSubSelector</span> <span class="k">in</span> <span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasSelector</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasSelector&quot;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasSubSelector</span><span class="p">]</span><span class="o">?</span>
                          <span class="nv">types = </span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasSubSelector</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="si">}</span><span class="s">type&quot;</span><span class="p">])</span>
                          <span class="k">if</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OAX</span><span class="si">}</span><span class="s">SvgSelector&quot;</span> <span class="k">in</span> <span class="nx">types</span></pre></div></td></tr><tr id="section-56"><td class="docs"><div class="pilwrap"><a href="#section-56" class="pilcrow">&#182;</a></div><p>extract SVG stuff</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasSubSelector</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">CNT</span><span class="si">}</span><span class="s">chars&quot;</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasSubSelector</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">CNT</span><span class="si">}</span><span class="s">chars&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span>
                              <span class="nv">svg = </span><span class="nx">data</span><span class="p">[</span><span class="nx">hasSubSelector</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">CNT</span><span class="si">}</span><span class="s">chars&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span>
                              <span class="nv">dom = </span><span class="nx">$</span><span class="p">.</span><span class="nx">parseXML</span> <span class="nx">svg</span></pre></div></td></tr><tr id="section-57"><td class="docs"><div class="pilwrap"><a href="#section-57" class="pilcrow">&#182;</a></div><p>based on the root element, we interogate the shape info to see
which one wants to handle extracting the extents/etc. from the svg</p>
</td><td class="code"><div class="highlight"><pre>                              <span class="k">if</span> <span class="nx">dom</span><span class="o">?</span>
                                <span class="nv">doc = </span><span class="nx">dom</span><span class="p">.</span><span class="nx">documentElement</span>
                                <span class="nv">rootName = </span><span class="nx">doc</span><span class="p">.</span><span class="nx">nodeName</span>
                                <span class="k">for</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">info</span> <span class="k">of</span> <span class="nx">shapeTypes</span>
                                  <span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">extractFromSVG</span><span class="o">?</span> <span class="o">and</span> <span class="nx">rootName</span> <span class="k">in</span> <span class="nx">info</span><span class="p">.</span><span class="nx">rootSVGElement</span>
                                    <span class="nv">shapeInfo = </span><span class="nx">info</span><span class="p">.</span><span class="nx">extractFromSVG</span> <span class="nx">doc</span>
                                    <span class="k">if</span> <span class="nx">shapeInfo</span><span class="o">?</span>
                                      <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">temp</span><span class="p">,</span> <span class="nx">shapeInfo</span><span class="p">)</span>
                                      <span class="nv">temp.shapeType = </span><span class="nx">t</span>
                              
                          <span class="k">if</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">FragSelector&quot;</span> <span class="k">in</span> <span class="nx">types</span></pre></div></td></tr><tr id="section-58"><td class="docs"><div class="pilwrap"><a href="#section-58" class="pilcrow">&#182;</a></div><p>extract media fragment stuff</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasSubSelector</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="si">}</span><span class="s">value&quot;</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">data</span><span class="p">[</span><span class="nx">hasSubSelector</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="si">}</span><span class="s">value&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span>
                              <span class="nv">fragment = </span><span class="nx">data</span><span class="p">[</span><span class="nx">hasSubSelector</span><span class="p">][</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="si">}</span><span class="s">value&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span>
                              <span class="nv">fragment = </span><span class="nx">fragment</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^t=npt:/</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                              <span class="nv">bits = </span><span class="nx">fragment</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                              <span class="nv">temp.npt_start = </span><span class="nx">parseNPT</span> <span class="nx">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                              <span class="nv">temp.npt_end   = </span><span class="nx">parseNPT</span> <span class="nx">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
          <span class="k">else</span></pre></div></td></tr><tr id="section-59"><td class="docs"><div class="pilwrap"><a href="#section-59" class="pilcrow">&#182;</a></div><p>No Target is created yet - create blank item to insert into dataStore
Unique ID comes from the URI value of type</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">temp =</span>
              <span class="nv">id: </span><span class="nx">i</span>
              <span class="nv">type: </span><span class="s">&quot;Annotation&quot;</span>
              <span class="nv">bodyContent: </span><span class="s">&#39;&#39;</span>
              <span class="nv">bodyType: </span><span class="s">&#39;Text&#39;</span>
              <span class="nv">targetURI: </span><span class="nx">app</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span>
              <span class="nv">shapeType: </span><span class="s">&#39;&#39;</span>
              <span class="nv">npt_start: </span><span class="mi">0</span>
              <span class="nv">npt_end: </span><span class="mi">0</span>
          
          <span class="k">if</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">npt_start</span><span class="o">?</span> <span class="o">or</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">npt_end</span><span class="o">?</span> <span class="o">or</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">shapeType</span><span class="o">?</span>
            <span class="nx">tempstore</span><span class="p">.</span><span class="nx">push</span> <span class="nx">temp</span></pre></div></td></tr><tr id="section-60"><td class="docs"><div class="pilwrap"><a href="#section-60" class="pilcrow">&#182;</a></div><p>insert into dataStore</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">app</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">loadItems</span> <span class="nx">tempstore</span></pre></div></td></tr><tr id="section-61"><td class="docs"><div class="pilwrap"><a href="#section-61" class="pilcrow">&#182;</a></div><h3>exportData</h3>

<p>Works backwards from the importData function for now.</p>

<p>Parameters:</p>

<ul>
<li>data - JSON Object of the original data used during import (Not stored locally during MITHGrid session)</li>
</ul>

<p>Returns:</p>

<p>JSON Object that conforms to the</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">app.exportData = </span><span class="nf">(data) -&gt;</span></pre></div></td></tr><tr id="section-62"><td class="docs"><div class="pilwrap"><a href="#section-62" class="pilcrow">&#182;</a></div><p>Get all data from dataStore</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">tempstore = </span><span class="p">{}</span>
      <span class="nv">findAnnos = </span><span class="nx">app</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">prepare</span> <span class="p">[</span><span class="s">&#39;!type&#39;</span><span class="p">]</span>
    
    
      <span class="nv">node = </span><span class="nf">(s, pns, p, t, o) -&gt;</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">tempstore</span><span class="p">[</span><span class="nx">s</span><span class="p">]</span><span class="o">?</span>
          <span class="nx">tempstore</span><span class="p">[</span><span class="nx">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">tempstore</span><span class="p">[</span><span class="nx">s</span><span class="p">][</span><span class="nx">pns</span><span class="o">+</span><span class="nx">p</span><span class="p">]</span><span class="o">?</span>
          <span class="nx">tempstore</span><span class="p">[</span><span class="nx">s</span><span class="p">][</span><span class="nx">pns</span><span class="o">+</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nx">tempstore</span><span class="p">[</span><span class="nx">s</span><span class="p">][</span><span class="nx">pns</span><span class="o">+</span><span class="nx">p</span><span class="p">].</span><span class="nx">push</span>
          <span class="s">&#39;type&#39;</span><span class="o">:</span> <span class="nx">t</span>
          <span class="s">&#39;value&#39;</span><span class="o">:</span> <span class="nx">o</span>
    
      <span class="nv">bnode = </span>  <span class="nf">(s, pns, p, o) -&gt;</span> <span class="nx">node</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">pns</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="s">&#39;bnode&#39;</span><span class="p">,</span>   <span class="nx">o</span>
      <span class="nv">uri = </span>    <span class="nf">(s, pns, p, o) -&gt;</span> <span class="nx">node</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">pns</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="s">&#39;uri&#39;</span><span class="p">,</span>     <span class="nx">o</span>
      <span class="nv">literal = </span><span class="nf">(s, pns, p, o) -&gt;</span> <span class="nx">node</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">pns</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="s">&#39;literal&#39;</span><span class="p">,</span> <span class="nx">o</span></pre></div></td></tr><tr id="section-63"><td class="docs"><div class="pilwrap"><a href="#section-63" class="pilcrow">&#182;</a></div><h4>genBody (private)</h4>

<p>Generates the body oject and adds it to tempstore</p>

<p>Parameters:
* obj - DataStore item
* id (optional) - create Body Object with specific ID</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">genBody = </span><span class="nf">(obj, id) -&gt;</span></pre></div></td></tr><tr id="section-64"><td class="docs"><div class="pilwrap"><a href="#section-64" class="pilcrow">&#182;</a></div><p>Generating body element</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">uri</span>     <span class="nx">id</span><span class="p">,</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span>   <span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">Body&quot;</span>
        <span class="nx">literal</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">DC</span><span class="p">,</span>  <span class="s">&quot;format&quot;</span><span class="p">,</span> <span class="s">&quot;text/plain&quot;</span>
        <span class="nx">literal</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">CNT</span><span class="p">,</span> <span class="s">&quot;characterEncoding&quot;</span><span class="p">,</span> <span class="s">&quot;utf-8&quot;</span>
        <span class="nx">literal</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">CNT</span><span class="p">,</span> <span class="s">&quot;chars&quot;</span><span class="p">,</span>  <span class="nx">obj</span><span class="p">.</span><span class="nx">bodyContent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div></td></tr><tr id="section-65"><td class="docs"><div class="pilwrap"><a href="#section-65" class="pilcrow">&#182;</a></div><h4>genTarget (private)</h4>

<p>Generates a JSON object representing a target and adds it to tempstore</p>

<p>Parameters
* obj - dataStore item
* id (optional) - pass array of IDs to use as target ID, Selector ID, etc</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">genTarget = </span><span class="nf">(obj, id) -&gt;</span></pre></div></td></tr><tr id="section-66"><td class="docs"><div class="pilwrap"><a href="#section-66" class="pilcrow">&#182;</a></div><p>Unique Identifiers for pieces of Target</p>
</td><td class="code"><div class="highlight"><pre>      </pre></div></td></tr><tr id="section-67"><td class="docs"><div class="pilwrap"><a href="#section-67" class="pilcrow">&#182;</a></div><p>Generating target element</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">uri</span>   <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span>       <span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">SpecificResource&quot;</span>
        <span class="nx">uri</span>   <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="p">,</span>  <span class="s">&quot;hasSource&quot;</span><span class="p">,</span>  <span class="nx">obj</span><span class="p">.</span><span class="nx">targetURI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">bnode</span> <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="p">,</span>  <span class="s">&quot;hasSelector&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div></td></tr><tr id="section-68"><td class="docs"><div class="pilwrap"><a href="#section-68" class="pilcrow">&#182;</a></div><p>Selector element, which points to the SVG constraint and NPT constraint</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">uri</span>   <span class="nx">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span>       <span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OAX</span><span class="si">}</span><span class="s">CompositeSelector&quot;</span>
        <span class="nx">bnode</span> <span class="nx">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="p">,</span>  <span class="s">&quot;hasSelector&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="nx">bnode</span> <span class="nx">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="p">,</span>  <span class="s">&quot;hasSelector&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">shapeType</span><span class="o">?</span>
          <span class="nv">svglens = </span><span class="nx">shapeTypes</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">shapeType</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">?</span><span class="p">.</span><span class="nx">renderAsSVG</span>

        <span class="k">if</span> <span class="nx">svglens</span><span class="o">?</span></pre></div></td></tr><tr id="section-69"><td class="docs"><div class="pilwrap"><a href="#section-69" class="pilcrow">&#182;</a></div><p>Targets have selectors, which then have svg and npt elements
<strong>FIXME:</strong> This should be provided by the shape management info - render to SVG just as
we render to the presentation</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">uri</span>     <span class="nx">id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span>              <span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OAX</span><span class="si">}</span><span class="s">SvgSelector&quot;</span>
          <span class="nx">literal</span> <span class="nx">id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">DC</span><span class="p">,</span>  <span class="s">&quot;format&quot;</span><span class="p">,</span>            <span class="s">&quot;text/svg+xml&quot;</span>
          <span class="nx">literal</span> <span class="nx">id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">CNT</span><span class="p">,</span> <span class="s">&quot;characterEncoding&quot;</span><span class="p">,</span> <span class="s">&quot;utf-8&quot;</span>
          <span class="nx">literal</span> <span class="nx">id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">CNT</span><span class="p">,</span> <span class="s">&quot;chars&quot;</span><span class="p">,</span>             <span class="nx">svglens</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    </pre></div></td></tr><tr id="section-70"><td class="docs"><div class="pilwrap"><a href="#section-70" class="pilcrow">&#182;</a></div><p>This is inserted regardless of the shape type - it's a function of this being a
streaming video annotation client</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">uri</span>     <span class="nx">id</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span>  <span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">FragSelector&quot;</span>
        <span class="nx">literal</span> <span class="nx">id</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="p">,</span> <span class="s">&quot;value&quot;</span><span class="p">,</span> <span class="s">&#39;t=npt:&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">npt_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">npt_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div></td></tr><tr id="section-71"><td class="docs"><div class="pilwrap"><a href="#section-71" class="pilcrow">&#182;</a></div><h4>createJSONObjSeries (private)</h4>

<p>Creates the necessary series of objects to be inserted
into the exported JSON. Only called if there isn't already a RDF:JSON object that was imported with a matching ID</p>

<p>Parameters:</p>

<ul>
<li>id - Array of Ids to use as:
0th - Annotation Object (required)
1st - Body Object (optional)
2nd - Target (optional)
3rd - Target Selector (optional)
4th - Target SVG (optional)
5th - Target NPT (optional)</li>
</ul>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">createJSONObjSeries = </span><span class="nf">(id) -&gt;</span>
        <span class="nv">obj = </span><span class="nx">app</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
          <span class="nv">buid = </span><span class="nx">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="nv">tuid = </span><span class="nx">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
          <span class="nv">suid = </span><span class="nx">id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
          <span class="nv">svgid = </span><span class="nx">id</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
          <span class="nv">fgid = </span><span class="nx">id</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="nv">buid = </span><span class="s">&#39;_:b&#39;</span> <span class="o">+</span> <span class="nx">uuid</span><span class="p">()</span>
          <span class="nv">tuid = </span><span class="s">&#39;_:t&#39;</span> <span class="o">+</span> <span class="nx">uuid</span><span class="p">()</span>
          <span class="nv">suid = </span><span class="s">&#39;_:sel&#39;</span> <span class="o">+</span> <span class="nx">uuid</span><span class="p">()</span>
          <span class="nv">svgid = </span><span class="s">&#39;_:sel&#39;</span> <span class="o">+</span> <span class="nx">uuid</span><span class="p">()</span>
          <span class="nv">fgid = </span><span class="s">&#39;_:sel&#39;</span> <span class="o">+</span> <span class="nx">uuid</span><span class="p">()</span></pre></div></td></tr><tr id="section-72"><td class="docs"><div class="pilwrap"><a href="#section-72" class="pilcrow">&#182;</a></div><p>Fragment Idenitifier ID</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">uri</span>   <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">RDF</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span>      <span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">Annotation&quot;</span>
        <span class="nx">bnode</span> <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="p">,</span>  <span class="s">&quot;hasBody&quot;</span><span class="p">,</span>   <span class="nx">buid</span>
        <span class="nx">bnode</span> <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="p">,</span>  <span class="s">&quot;hasTarget&quot;</span><span class="p">,</span> <span class="nx">tuid</span>

        <span class="nx">genBody</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">buid</span>
        <span class="nx">genTarget</span> <span class="nx">obj</span><span class="p">,</span> <span class="p">[</span><span class="nx">tuid</span><span class="p">,</span> <span class="nx">suid</span><span class="p">,</span> <span class="nx">svgid</span><span class="p">,</span> <span class="nx">fgid</span><span class="p">]</span></pre></div></td></tr><tr id="section-73"><td class="docs"><div class="pilwrap"><a href="#section-73" class="pilcrow">&#182;</a></div><h4>mergeData (private)</h4>

<p>Takes an id of a dataStore object and merges the data
in the object with what is in the (optionally) passed
RDF:JSON object</p>

<p>Parameters:
* id - ID of object to merge</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">mergeData = </span><span class="nf">(id) -&gt;</span>
        <span class="nv">obj = </span><span class="nx">app</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">id</span></pre></div></td></tr><tr id="section-74"><td class="docs"><div class="pilwrap"><a href="#section-74" class="pilcrow">&#182;</a></div><p>check where data merges</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span></pre></div></td></tr><tr id="section-75"><td class="docs"><div class="pilwrap"><a href="#section-75" class="pilcrow">&#182;</a></div><p>go through annotation pointers in RDF:JSON to update body, target, etc</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">for</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">data</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
            <span class="k">switch</span> <span class="nx">type</span>
              <span class="k">when</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasBody&quot;</span>
                <span class="nv">buid = </span><span class="nx">data</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">hasBody</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span>
                <span class="nx">data</span><span class="p">[</span><span class="nx">buid</span><span class="p">].</span><span class="nx">chars</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">value = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">bodyContent</span>
              <span class="k">when</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">NS</span><span class="p">.</span><span class="nx">OA</span><span class="si">}</span><span class="s">hasTarget&quot;</span></pre></div></td></tr><tr id="section-76"><td class="docs"><div class="pilwrap"><a href="#section-76" class="pilcrow">&#182;</a></div><p>If Target is undefined within ASP JSON, then it remains blank in RDF:JSON</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">targetURI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span>
                  <span class="nv">tuid = </span><span class="nx">data</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">hasTarget</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span></pre></div></td></tr><tr id="section-77"><td class="docs"><div class="pilwrap"><a href="#section-77" class="pilcrow">&#182;</a></div><p>Using variable to check against whether object is found or not</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="nv">found = </span><span class="kc">false</span></pre></div></td></tr><tr id="section-78"><td class="docs"><div class="pilwrap"><a href="#section-78" class="pilcrow">&#182;</a></div><p>Matching video URLs means matching Targets</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">tuid</span><span class="p">].</span><span class="nx">hasSource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span> <span class="o">==</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">targetURI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div></td></tr><tr id="section-79"><td class="docs"><div class="pilwrap"><a href="#section-79" class="pilcrow">&#182;</a></div><p>matching sources - merging</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nv">suid = </span><span class="nx">data</span><span class="p">[</span><span class="nx">tuid</span><span class="p">].</span><span class="nx">hasSelector</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span>
                    <span class="nv">found = </span><span class="kc">true</span></pre></div></td></tr><tr id="section-80"><td class="docs"><div class="pilwrap"><a href="#section-80" class="pilcrow">&#182;</a></div><p>Go through the selectors</p>
</td><td class="code"><div class="highlight"><pre>                  
                    <span class="k">for</span> <span class="nx">seltype</span><span class="p">,</span> <span class="nx">selval</span> <span class="k">of</span> <span class="nx">data</span><span class="p">[</span><span class="nx">suid</span><span class="p">]</span>
                      <span class="k">if</span> <span class="nx">seltype</span> <span class="o">==</span> <span class="s">&#39;hasSelector&#39;</span>
                        <span class="k">for</span> <span class="nx">seli</span><span class="p">,</span> <span class="nx">selo</span> <span class="k">of</span> <span class="nx">selval</span></pre></div></td></tr><tr id="section-81"><td class="docs"><div class="pilwrap"><a href="#section-81" class="pilcrow">&#182;</a></div><p>is svg, npt?</p>
</td><td class="code"><div class="highlight"><pre>                          <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">selo</span><span class="p">.</span><span class="nx">value</span><span class="p">].</span><span class="nx">type</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span> <span class="o">==</span> <span class="nx">OAC_NS</span><span class="p">.</span><span class="nx">SVGConstraint</span>
                            <span class="nx">data</span><span class="p">[</span><span class="nx">selo</span><span class="p">.</span><span class="nx">value</span><span class="p">].</span><span class="nv">chars = </span><span class="p">[</span>
                              <span class="nv">type: </span><span class="s">&#39;literal&#39;</span>
                              <span class="nv">value: </span><span class="s">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">shapeType</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span>
                              <span class="s">&#39; x=&quot;&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;&quot; y=&quot;&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; width=&quot;&#39;</span> <span class="o">+</span>
                              <span class="nx">obj</span><span class="p">.</span><span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;&quot; height=&quot;&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;&quot; /&gt;&#39;</span>
                            <span class="p">]</span>
                          <span class="k">else</span> <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="nx">selo</span><span class="p">.</span><span class="nx">value</span><span class="p">].</span><span class="nx">type</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span> <span class="o">==</span> <span class="nx">OAC_NS</span><span class="p">.</span><span class="nx">FragSelector</span>
                            <span class="nx">data</span><span class="p">[</span><span class="nx">selval</span><span class="p">].</span><span class="nv">chars = </span><span class="p">[</span>
                              <span class="s">&#39;type&#39;</span><span class="o">:</span> <span class="s">&#39;literal&#39;</span>
                              <span class="s">&#39;value&#39;</span><span class="o">:</span> <span class="s">&#39;t=npt:&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">npt_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">npt_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="p">]</span></pre></div></td></tr><tr id="section-82"><td class="docs"><div class="pilwrap"><a href="#section-82" class="pilcrow">&#182;</a></div><p>If no target element found, create new one in RDF:JSON</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="k">if</span> <span class="o">!</span><span class="nx">found</span>
                    <span class="nx">genTarget</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
              <span class="k">else</span></pre></div></td></tr><tr id="section-83"><td class="docs"><div class="pilwrap"><a href="#section-83" class="pilcrow">&#182;</a></div><p>do nothing</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">else</span>
          <span class="nx">createJSONObjSeries</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span>

      <span class="nv">data = </span><span class="nx">data</span> <span class="o">or</span> <span class="p">{}</span>

      <span class="k">for</span> <span class="nx">o</span> <span class="k">in</span> <span class="nx">findAnnos</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="s">&#39;Annotation&#39;</span><span class="p">)</span>
        <span class="nx">mergeData</span> <span class="nx">o</span>

      <span class="nx">tempstore</span></pre></div></td></tr><tr id="section-84"><td class="docs"><div class="pilwrap"><a href="#section-84" class="pilcrow">&#182;</a></div><h2>Application Configuration</h2>

<p>The rest of this prepares the annotation application once it's in the up-and-running process.</p>

<p>We wrap all of this in the app.ready() call so we will have all of the events, presentations,
data stores, etc., instantiated for us.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">ready</span> <span class="o">-&gt;</span></pre></div></td></tr><tr id="section-85"><td class="docs"><div class="pilwrap"><a href="#section-85" class="pilcrow">&#182;</a></div><p>We want the SVG overlay and the annotation body presentation to react to changes in
the selection focus.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">app</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onActiveAnnotationChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">app</span><span class="p">.</span><span class="nx">presentation</span><span class="p">.</span><span class="nx">raphsvg</span><span class="p">.</span><span class="nx">eventFocusChange</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onActiveAnnotationChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">app</span><span class="p">.</span><span class="nx">presentation</span><span class="p">.</span><span class="nx">annoItem</span><span class="p">.</span><span class="nx">eventFocusChange</span></pre></div></td></tr><tr id="section-86"><td class="docs"><div class="pilwrap"><a href="#section-86" class="pilcrow">&#182;</a></div><p>We always want the current annotation list to include anything that covers a time within five seconds
of the current time.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">app</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onCurrentTimeChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(t) -&gt;</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">dataView</span><span class="p">.</span><span class="nx">currentAnnotations</span><span class="p">.</span><span class="nx">setKeyRange</span><span class="p">(</span><span class="nx">t</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">t</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
        <span class="nx">playerObj</span><span class="p">.</span><span class="nx">setPlayhead</span> <span class="nx">t</span></pre></div></td></tr><tr id="section-87"><td class="docs"><div class="pilwrap"><a href="#section-87" class="pilcrow">&#182;</a></div><p>Making sure that none of the button items are still active while video is playing
(Can't draw a shape while video is playing - force user to re-click item)
app.setCurrentMode('Watch')</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-88"><td class="docs"><div class="pilwrap"><a href="#section-88" class="pilcrow">&#182;</a></div><p>We currently have a Player variable that handles the current player object. This may change since
we intend for the annotation client to be bound to a particular video stream on the page.</p>

<p><strong>TODO:</strong> This may be better done as an option when the app object is initialized. Annotations are
specific to the video being annotated, so it doesn't make as much sense to change the video we're
annotating. Better to create a new applicaiton instance.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">app</span><span class="p">.</span><span class="nx">setCurrentTime</span> <span class="nx">playerObj</span><span class="p">.</span><span class="nx">getPlayhead</span><span class="p">()</span>
      <span class="nx">playerObj</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onPlayheadUpdate</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">app</span><span class="p">.</span><span class="nx">setCurrentTime</span>

      <span class="nx">app</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onCurrentModeChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(nmode) -&gt;</span>
        <span class="k">if</span> <span class="nx">nmode</span> <span class="o">!=</span> <span class="s">&#39;Watch&#39;</span>
          <span class="nx">playerObj</span><span class="p">.</span><span class="nx">pause</span><span class="p">()</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">nmode</span> <span class="o">==</span> <span class="s">&#39;Watch&#39;</span>
          <span class="nx">playerObj</span><span class="p">.</span><span class="nx">play</span><span class="p">()</span></pre></div></td></tr><tr id="section-89"><td class="docs"><div class="pilwrap"><a href="#section-89" class="pilcrow">&#182;</a></div><p>We want to populate the available shapes with the rectangle and ellipse. These are considered stock
shapes for annotations.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">ready</span> <span class="o">-&gt;</span></pre></div></td></tr><tr id="section-90"><td class="docs"><div class="pilwrap"><a href="#section-90" class="pilcrow">&#182;</a></div><h3>exportRectangle (private)</h3>

<p>Calculate the attributes needed for exporting the rectangle constraint.</p>

<p>Parameters:</p>

<ul>
<li><p>item - an object holding the .x, .y, .w, and .h (center and extents)</p></li>
<li><p>w - width of play surface</p></li>
<li><p>h - height of play surface</p></li>
</ul>

<p>Returns:</p>

<p>Returns an object with the scaled .x, .y, .w, and .h.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">exportRectangle = </span><span class="nf">(item, w, h) -&gt;</span>
        <span class="nv">itemCopy = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">item</span><span class="p">)</span>

        <span class="nv">itemCopy.x = </span><span class="p">(</span><span class="nx">itemCopy</span><span class="p">.</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">w</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="nv">itemCopy.y = </span><span class="p">(</span><span class="nx">itemCopy</span><span class="p">.</span><span class="nx">y</span> <span class="o">/</span> <span class="nx">h</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="nv">itemCopy.w = </span><span class="p">(</span><span class="nx">itemCopy</span><span class="p">.</span><span class="nx">w</span> <span class="o">/</span> <span class="nx">w</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="nv">itemCopy.h = </span><span class="p">(</span><span class="nx">itemCopy</span><span class="p">.</span><span class="nx">h</span> <span class="o">/</span> <span class="nx">h</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="nx">itemCopy</span>
      </pre></div></td></tr><tr id="section-91"><td class="docs"><div class="pilwrap"><a href="#section-91" class="pilcrow">&#182;</a></div><p>Using addShapeType to add Rectangle to the array of possible SVG
shapes</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">app</span><span class="p">.</span><span class="nx">addShapeType</span> <span class="s">&quot;Rectangle&quot;</span><span class="p">,</span></pre></div></td></tr><tr id="section-92"><td class="docs"><div class="pilwrap"><a href="#section-92" class="pilcrow">&#182;</a></div><p>Calculate the center and extents given the corner and extents.</p>

<p>Parameters:</p>

<ul>
<li>coords - object holding the .x, .y, .width, and .height</li>
</ul>

<p>Returns:</p>

<p>An object holding the .x, .y, .w, and .h holding the center and extents.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">calc: </span><span class="nf">(coords) -&gt;</span>
          <span class="nv">x: </span><span class="nx">coords</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
          <span class="nv">y: </span><span class="nx">coords</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
          <span class="nv">w: </span><span class="nx">coords</span><span class="p">.</span><span class="nx">width</span>
          <span class="nv">h: </span><span class="nx">coords</span><span class="p">.</span><span class="nx">height</span>
          </pre></div></td></tr><tr id="section-93"><td class="docs"><div class="pilwrap"><a href="#section-93" class="pilcrow">&#182;</a></div><p>Renders the SVG <rect/> element representing the rectangle</p>

<p>Parameters:</p>

<ul>
<li><p>model - the data store or data view holding information abut the item to be rendered</p></li>
<li><p>itemId - the item ID of the item to be rendered</p></li>
</ul>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">renderAsSVG: </span><span class="nf">(model, itemId) -&gt;</span>
          <span class="nv">item = </span><span class="nx">model</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">itemId</span>
          <span class="s">&quot;&lt;rect x=&#39;</span><span class="si">#{</span><span class="nx">item</span><span class="p">.</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&#39; y=&#39;</span><span class="si">#{</span><span class="nx">item</span><span class="p">.</span><span class="nx">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&#39; width=&#39;</span><span class="si">#{</span><span class="nx">item</span><span class="p">.</span><span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&#39; height=&#39;</span><span class="si">#{</span><span class="nx">item</span><span class="p">.</span><span class="nx">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&#39; /&gt;&quot;</span>

        <span class="nv">rootSVGElement: </span><span class="p">[</span><span class="s">&quot;rect&quot;</span><span class="p">]</span>
        
        <span class="nv">extractFromSVG: </span><span class="nf">(svg) -&gt;</span>
          <span class="nv">info = </span><span class="p">{}</span>
          <span class="nv">info.w = </span><span class="nb">parseFloat</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;width&#39;</span><span class="p">)</span>
          <span class="nv">info.h = </span><span class="nb">parseFloat</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;height&#39;</span><span class="p">)</span>
          <span class="nv">info.x = </span><span class="nb">parseFloat</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
          <span class="nv">info.y = </span><span class="nb">parseFloat</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
          <span class="nx">info</span>
        </pre></div></td></tr><tr id="section-94"><td class="docs"><div class="pilwrap"><a href="#section-94" class="pilcrow">&#182;</a></div><p>Renders the rectangular constraint on the video target.</p>

<p>Parameters:</p>

<ul>
<li><p>container - the container holding the lens content</p></li>
<li><p>view - the presentation managing the collection of renderings</p></li>
<li><p>model - the data store or data view holding information abut the item to be rendered</p></li>
<li><p>itemId - the item ID of the item to be rendered</p></li>
</ul>

<p>Returns:</p>

<p>The rendering object.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">lens: </span><span class="nf">(container, view, model, itemId) -&gt;</span></pre></div></td></tr><tr id="section-95"><td class="docs"><div class="pilwrap"><a href="#section-95" class="pilcrow">&#182;</a></div><p>Note: Rectangle measurements x,y start at CENTER
Initiate object with super-class methods and variables</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">that = </span><span class="nx">app</span><span class="p">.</span><span class="nx">initShapeLens</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">itemId</span>
          <span class="nv">item = </span><span class="nx">model</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">itemId</span></pre></div></td></tr><tr id="section-96"><td class="docs"><div class="pilwrap"><a href="#section-96" class="pilcrow">&#182;</a></div><p>Accessing the view.canvas Object that was created in MITHGrid.Presentation.RaphSVG</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">c = </span><span class="nx">view</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">rect</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nx">item</span><span class="p">.</span><span class="nx">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nx">item</span><span class="p">.</span><span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">item</span><span class="p">.</span><span class="nx">h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

          <span class="nv">that.shape = </span><span class="nx">c</span></pre></div></td></tr><tr id="section-97"><td class="docs"><div class="pilwrap"><a href="#section-97" class="pilcrow">&#182;</a></div><p>fill and set opacity</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">c</span><span class="p">.</span><span class="nx">attr</span>
            <span class="nv">fill: </span><span class="s">&quot;silver&quot;</span>
            <span class="nv">border: </span><span class="s">&quot;grey&quot;</span>
          <span class="nx">that</span><span class="p">.</span><span class="nx">setOpacity</span><span class="p">()</span></pre></div></td></tr><tr id="section-98"><td class="docs"><div class="pilwrap"><a href="#section-98" class="pilcrow">&#182;</a></div><p><strong>FIXME:</strong> may break with multiple videos if different annotations have the same ids in different
sets of annotations.
Should be fixed with UUID</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">$</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">node</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

          <span class="nv">selectBinding = </span><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">selectShape</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">c</span>
          <span class="nx">selectBinding</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onSelect</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">-&gt;</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">setActiveAnnotation</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>

          <span class="nv">superUpdate = </span><span class="nx">that</span><span class="p">.</span><span class="nx">update</span>
          <span class="nv">that.update = </span><span class="nf">(newItem) -&gt;</span></pre></div></td></tr><tr id="section-99"><td class="docs"><div class="pilwrap"><a href="#section-99" class="pilcrow">&#182;</a></div><p>receiving the Object passed through
model.updateItems in move()</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">item = </span><span class="nx">newItem</span>
            <span class="nx">superUpdate</span> <span class="nx">item</span>
            <span class="k">if</span> <span class="nx">item</span><span class="p">.</span><span class="nx">x</span><span class="o">?</span> <span class="o">and</span> <span class="nx">item</span><span class="p">.</span><span class="nx">y</span><span class="o">?</span> <span class="o">and</span> <span class="nx">item</span><span class="p">.</span><span class="nx">w</span><span class="o">?</span> <span class="o">and</span> <span class="nx">item</span><span class="p">.</span><span class="nx">h</span><span class="o">?</span>
              <span class="nx">c</span><span class="p">.</span><span class="nx">attr</span>
                <span class="nv">x: </span><span class="nx">item</span><span class="p">.</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">item</span><span class="p">.</span><span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="nv">y: </span><span class="nx">item</span><span class="p">.</span><span class="nx">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">item</span><span class="p">.</span><span class="nx">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="nv">width: </span><span class="nx">item</span><span class="p">.</span><span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nv">height: </span><span class="nx">item</span><span class="p">.</span><span class="nx">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div></td></tr><tr id="section-100"><td class="docs"><div class="pilwrap"><a href="#section-100" class="pilcrow">&#182;</a></div><p>calculate the extents (x, y, width, height)
of this type of shape</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">that.getExtents = </span><span class="o">-&gt;</span>
            <span class="nv">x: </span><span class="nx">c</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;width&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="nv">y: </span><span class="nx">c</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;height&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="nv">width: </span><span class="nx">c</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;width&quot;</span><span class="p">)</span>
            <span class="nv">height: </span><span class="nx">c</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;height&quot;</span><span class="p">)</span>

          <span class="nx">that</span>

      <span class="nx">app</span><span class="p">.</span><span class="nx">addShapeType</span> <span class="s">&quot;Ellipse&quot;</span><span class="p">,</span></pre></div></td></tr><tr id="section-101"><td class="docs"><div class="pilwrap"><a href="#section-101" class="pilcrow">&#182;</a></div><p>Generates a JSON object containing the measurements for an
ellipse object but only using x, y, w, h</p>

<p>Returns:
JSON object</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">calc: </span><span class="nf">(coords) -&gt;</span>
          <span class="nv">x: </span><span class="nx">coords</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
          <span class="nv">y: </span><span class="nx">coords</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
          <span class="nv">w: </span><span class="nx">coords</span><span class="p">.</span><span class="nx">width</span>
          <span class="nv">h: </span><span class="nx">coords</span><span class="p">.</span><span class="nx">height</span>
          </pre></div></td></tr><tr id="section-102"><td class="docs"><div class="pilwrap"><a href="#section-102" class="pilcrow">&#182;</a></div><p>Renders the SVG <rect/> element representing the rectangle</p>

<p>Parameters:</p>

<ul>
<li><p>model - the data store or data view holding information abut the item to be rendered</p></li>
<li><p>itemId - the item ID of the item to be rendered</p></li>
</ul>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">renderAsSVG: </span><span class="nf">(model, itemId) -&gt;</span>
          <span class="nv">item = </span><span class="nx">model</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">itemId</span>
          <span class="s">&quot;&lt;elli x=&#39;</span><span class="si">#{</span><span class="nx">item</span><span class="p">.</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&#39; y=&#39;</span><span class="si">#{</span><span class="nx">item</span><span class="p">.</span><span class="nx">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&#39; width=&#39;</span><span class="si">#{</span><span class="nx">item</span><span class="p">.</span><span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&#39; height=&#39;</span><span class="si">#{</span><span class="nx">item</span><span class="p">.</span><span class="nx">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&#39; /&gt;&quot;</span>
          
        <span class="nv">rootSVGElement: </span><span class="p">[</span><span class="s">&quot;elli&quot;</span><span class="p">]</span>
        
        <span class="nv">extractFromSVG: </span><span class="nf">(svg) -&gt;</span>
          <span class="nv">info = </span><span class="p">{}</span>
          <span class="nv">info.w = </span><span class="nb">parseFloat</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;width&#39;</span><span class="p">)</span>
          <span class="nv">info.h = </span><span class="nb">parseFloat</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;height&#39;</span><span class="p">)</span>
          <span class="nv">info.x = </span><span class="nb">parseFloat</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
          <span class="nv">info.y = </span><span class="nb">parseFloat</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
          <span class="nx">info</span></pre></div></td></tr><tr id="section-103"><td class="docs"><div class="pilwrap"><a href="#section-103" class="pilcrow">&#182;</a></div><p>Rendering Lens for the Ellipse SVG shape</p>

<p>Parameters:</p>

<ul>
<li><p>container - the container holding the lens content</p></li>
<li><p>view - the presentation managing the collection of renderings</p></li>
<li><p>model - the data store or data view holding information abut the item to be rendered</p></li>
<li><p>itemId - the item ID of the item to be rendered</p></li>
</ul>

<p>Returns:</p>

<p>The rendering object.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">lens: </span><span class="nf">(container, view, model, itemId) -&gt;</span>
          <span class="nv">that = </span><span class="nx">app</span><span class="p">.</span><span class="nx">initShapeLens</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">itemId</span>
          <span class="nv">item = </span><span class="nx">model</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">itemId</span></pre></div></td></tr><tr id="section-104"><td class="docs"><div class="pilwrap"><a href="#section-104" class="pilcrow">&#182;</a></div><p>create the shape</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">c = </span><span class="nx">view</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">ellipse</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">item</span><span class="p">.</span><span class="nx">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">item</span><span class="p">.</span><span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
          <span class="nv">that.shape = </span><span class="nx">c</span></pre></div></td></tr><tr id="section-105"><td class="docs"><div class="pilwrap"><a href="#section-105" class="pilcrow">&#182;</a></div><p>fill shape</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">c</span><span class="p">.</span><span class="nx">attr</span>
            <span class="nv">fill: </span><span class="s">&quot;silver&quot;</span>
            <span class="nv">border: </span><span class="s">&quot;grey&quot;</span>
          <span class="nx">that</span><span class="p">.</span><span class="nx">setOpacity</span><span class="p">()</span>

          <span class="nv">selectBinding = </span><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">selectShape</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">c</span>
          <span class="nx">selectBinding</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onSelect</span><span class="p">.</span><span class="nx">addListener</span> <span class="o">-&gt;</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">setActiveAnnotation</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>

          <span class="nv">superUpdate = </span><span class="nx">that</span><span class="p">.</span><span class="nx">update</span>

          <span class="nv">that.update = </span><span class="nf">(item) -&gt;</span></pre></div></td></tr><tr id="section-106"><td class="docs"><div class="pilwrap"><a href="#section-106" class="pilcrow">&#182;</a></div><p>receiving the Object passed through
model.updateItems in move()</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">superUpdate</span> <span class="nx">item</span>

            <span class="k">if</span> <span class="nx">item</span><span class="p">.</span><span class="nx">x</span><span class="o">?</span> <span class="o">and</span> <span class="nx">item</span><span class="p">.</span><span class="nx">y</span><span class="o">?</span>
              <span class="nx">c</span><span class="p">.</span><span class="nx">attr</span>
                <span class="nv">cx: </span><span class="nx">item</span><span class="p">.</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nv">cy: </span><span class="nx">item</span><span class="p">.</span><span class="nx">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nv">rx: </span><span class="nx">item</span><span class="p">.</span><span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="nv">ry: </span><span class="nx">item</span><span class="p">.</span><span class="nx">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
          </pre></div></td></tr><tr id="section-107"><td class="docs"><div class="pilwrap"><a href="#section-107" class="pilcrow">&#182;</a></div><p>calculate the extents (x, y, width, height)
of this type of shape</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">that.getExtents = </span><span class="o">-&gt;</span>
            <span class="nv">x: </span><span class="nx">c</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;cx&quot;</span><span class="p">)</span>
            <span class="nv">y: </span><span class="nx">c</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;cy&quot;</span><span class="p">)</span>
            <span class="nv">width: </span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;rx&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="nv">height: </span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;ry&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

          <span class="nx">that</span>

      <span class="nx">app</span><span class="p">.</span><span class="nx">addBody</span> <span class="s">&quot;Text&quot;</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">initTextLens</span></pre></div></td></tr><tr id="section-108"><td class="docs"><div class="pilwrap"><a href="#section-108" class="pilcrow">&#182;</a></div><p>Adding in button features for annotation creation</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">rectButton = </span><span class="nx">app</span><span class="p">.</span><span class="nx">buttonFeature</span> <span class="s">&#39;buttongrouping&#39;</span><span class="p">,</span> <span class="s">&#39;Shapes&#39;</span><span class="p">,</span> <span class="s">&#39;Rectangle&#39;</span>

      <span class="nv">ellipseButton = </span><span class="nx">app</span><span class="p">.</span><span class="nx">buttonFeature</span> <span class="s">&#39;buttongrouping&#39;</span><span class="p">,</span> <span class="s">&#39;Shapes&#39;</span><span class="p">,</span> <span class="s">&#39;Ellipse&#39;</span>

      <span class="nv">selectButton = </span><span class="nx">app</span><span class="p">.</span><span class="nx">buttonFeature</span> <span class="s">&#39;buttongrouping&#39;</span><span class="p">,</span> <span class="s">&#39;General&#39;</span><span class="p">,</span> <span class="s">&#39;Select&#39;</span>

      <span class="nv">watchButton = </span><span class="nx">app</span><span class="p">.</span><span class="nx">buttonFeature</span> <span class="s">&#39;buttongrouping&#39;</span><span class="p">,</span> <span class="s">&#39;General&#39;</span><span class="p">,</span> <span class="s">&#39;Watch&#39;</span>

      <span class="nx">app</span><span class="p">.</span><span class="nx">setCurrentTime</span> <span class="mi">0</span></pre></div></td></tr><tr id="section-109"><td class="docs"><div class="pilwrap"><a href="#section-109" class="pilcrow">&#182;</a></div><p>binding time controller to time DOM</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">timeControlBinding = </span><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">timecontrol</span><span class="p">.</span><span class="nx">bind</span> <span class="s">&#39;.timeselect&#39;</span><span class="p">,</span> <span class="p">{}</span>
      <span class="nx">timeControlBinding</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onUpdate</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(id, start, end) -&gt;</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">updateItems</span> <span class="p">[</span>
          <span class="nv">id: </span><span class="nx">id</span>
          <span class="nv">npt_start: </span><span class="nx">start</span>
          <span class="nv">npt_end: </span><span class="nx">end</span>
        <span class="p">]</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Sat Apr 28 2012 19:08:51 GMT-0400 (EDT)  </div><div id="projectname"><a href="../index.html">OAC Video Annotation Client</a></div></div>
